!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.appBundle=t():e.appBundle=t()}(this,()=>(()=>{"use strict";var e={5246(e,t,n){n.d(t,{s:()=>a});var s=n(1272);const i="eth_chat_keystores",a=new class{constructor(){this.wallet=null,this.address=null,this.signer=null,this.currentWalletName=null,this.isGuest=!1}generateLocalWallet(){try{const e=ethers.Wallet.createRandom();return this.wallet=e,this.address=e.address,this.signer=e,this.isGuest=!1,s.V.info("Generated local wallet:",this.address),s.V.warn("Private key is only stored in memory. Save it to keep access!"),{address:this.address,privateKey:e.privateKey,signer:this.signer}}catch(e){throw s.V.error("Failed to generate local wallet:",e),e}}importPrivateKey(e){try{const t=new ethers.Wallet(e);return this.wallet=t,this.address=t.address,this.signer=t,this.isGuest=!1,s.V.info("Imported wallet:",this.address),{address:this.address,signer:this.signer}}catch(e){throw s.V.error("Failed to import private key:",e),e}}async saveWalletEncrypted(e,t=null,n=null){if(!this.wallet)throw new Error("No local wallet to save");try{const a=t||`Wallet ${this.address.slice(0,8)}`;let r;s.V.debug("Encrypting wallet with Keystore V3 (this may take a moment)..."),r=n&&"function"==typeof n?await this.wallet.encrypt(e,n):await this.wallet.encrypt(e);const o=JSON.parse(r),l=this.loadAllKeystores();l[this.address.toLowerCase()]={name:a,keystore:o,createdAt:Date.now(),lastUsed:Date.now()},localStorage.setItem(i,JSON.stringify(l)),this.currentWalletName=a;const d=o.crypto||o.Crypto;return s.V.info("Wallet saved as Keystore V3"),s.V.debug(`   Name: ${a}`),s.V.debug(`   Address: ${this.address}`),s.V.debug(`   Crypto: ${d?.cipher||"aes-128-ctr"} + ${d?.kdf||"scrypt"}`),{name:a,address:this.address,version:o.version}}catch(e){throw s.V.error("Failed to save wallet:",e),e}}async loadWalletEncrypted(e,t=null,n=null){try{const a=this.loadAllKeystores();if(0===Object.keys(a).length)throw new Error("No saved wallets found");let r,o;if(t){if(o=t.toLowerCase(),r=a[o],!r)throw new Error(`Wallet not found: ${t}`)}else{const e=Object.entries(a).sort((e,t)=>(t[1].lastUsed||0)-(e[1].lastUsed||0));[o,r]=e[0]}this.validateKeystore(r.keystore),s.V.debug("Decrypting Keystore V3 (this may take a moment)...");const l=JSON.stringify(r.keystore);let d;return d=n&&"function"==typeof n?await ethers.Wallet.fromEncryptedJson(l,e,n):await ethers.Wallet.fromEncryptedJson(l,e),this.wallet=d,this.address=d.address,this.signer=d,this.currentWalletName=r.name,a[o].lastUsed=Date.now(),localStorage.setItem(i,JSON.stringify(a)),s.V.info("Wallet loaded from Keystore V3"),s.V.debug(`   Name: ${r.name}`),s.V.debug(`   Address: ${this.address}`),{address:this.address,name:r.name,signer:this.signer}}catch(e){throw s.V.error("Failed to load wallet:",e),e}}validateKeystore(e){if(!e)throw new Error("Invalid keystore: empty");if(3!==e.version)throw new Error(`Invalid keystore version: ${e.version} (expected 3)`);if(!e.crypto&&!e.Crypto)throw new Error("Invalid keystore: missing crypto section");const t=e.crypto||e.Crypto;if(!t.cipher||!t.ciphertext||!t.cipherparams)throw new Error("Invalid keystore: missing cipher data");if(!t.kdf||!t.kdfparams)throw new Error("Invalid keystore: missing KDF data");if(!t.mac)throw new Error("Invalid keystore: missing MAC");return!0}loadAllKeystores(){try{const e=localStorage.getItem(i);return e?JSON.parse(e):{}}catch(e){return s.V.error("Failed to load keystores:",e),{}}}listSavedWallets(){const e=this.loadAllKeystores();return Object.entries(e).map(([e,t])=>({address:e,name:t.name,createdAt:t.createdAt,lastUsed:t.lastUsed,version:t.keystore?.version||3}))}updateWalletName(e,t=null){const n=(t||this.address)?.toLowerCase();if(!n)return!1;const s=this.loadAllKeystores();return!!s[n]&&(s[n].name=e||`Account ${n.slice(0,8)}`,localStorage.setItem(i,JSON.stringify(s)),n===this.address?.toLowerCase()&&(this.currentWalletName=s[n].name),!0)}exportKeystore(e=null){const t=this.loadAllKeystores(),n=e?.toLowerCase()||this.address?.toLowerCase();if(!n)throw new Error("No wallet address specified");const s=t[n];if(!s)throw new Error(`Wallet not found: ${n}`);return JSON.stringify(s.keystore,null,2)}async importKeystore(e,t,n=null){try{const a=JSON.parse(e);this.validateKeystore(a),s.V.debug("Verifying keystore password...");const r=await ethers.Wallet.fromEncryptedJson(e,t),o=n||`Imported ${r.address.slice(0,8)}`,l=this.loadAllKeystores();return l[r.address.toLowerCase()]={name:o,keystore:a,createdAt:Date.now(),lastUsed:Date.now(),imported:!0},localStorage.setItem(i,JSON.stringify(l)),this.wallet=r,this.address=r.address,this.signer=r,this.currentWalletName=o,s.V.info("Keystore imported successfully"),{address:r.address,name:o,signer:r}}catch(e){throw s.V.error("Failed to import keystore:",e),e}}deleteWallet(e){const t=this.loadAllKeystores(),n=e.toLowerCase();if(!t[n])throw new Error(`Wallet not found: ${e}`);return delete t[n],localStorage.setItem(i,JSON.stringify(t)),this.address?.toLowerCase()===n&&this.disconnect(),s.V.info("Wallet deleted:",e),!0}hasSavedWallet(){const e=this.loadAllKeystores();return Object.keys(e).length>0}connectAsGuest(){try{const e=ethers.Wallet.createRandom();return this.wallet=e,this.address=e.address,this.signer=e,this.isGuest=!0,this.currentWalletName="Guest",s.V.info("Connected as Guest:",this.address),{address:this.address,signer:this.signer}}catch(e){throw s.V.error("Failed to create guest wallet:",e),e}}isGuestMode(){return!0===this.isGuest}disconnect(){this.wallet=null,this.address=null,this.signer=null,this.currentWalletName=null,this.isGuest=!1,s.V.info("Wallet disconnected")}getAddress(){return this.address}getWalletName(){return this.currentWalletName}getSigner(){return this.signer}isConnected(){return null!==this.address}async signMessage(e){if(!this.signer)throw new Error("No signer available");try{return await this.signer.signMessage(e)}catch(e){throw s.V.error("Failed to sign message:",e),e}}async changePassword(e,t,n=null){const i=n?.toLowerCase()||this.address?.toLowerCase();if(!i)throw new Error("No wallet address specified");const a=await this.loadWalletEncrypted(e,i);return await this.saveWalletEncrypted(t,a.name),s.V.info("Password changed successfully"),!0}async getPrivateKey(e,t=null){const n=t?.toLowerCase()||this.address?.toLowerCase();if(!n)throw new Error("No wallet address specified");const i=this.loadAllKeystores()[n];if(!i)throw new Error("Wallet not found");try{const t=JSON.stringify(i.keystore),n=await ethers.Wallet.fromEncryptedJson(t,e);return s.V.debug("Password verified, returning private key"),n.privateKey}catch(e){if(e.message.includes("invalid")||e.message.includes("password"))throw new Error("Incorrect password");throw e}}exportKeystores(){const e={format:"pombo-keystores",version:1,exportedAt:(new Date).toISOString(),keystores:{}},t=this.loadAllKeystores();for(const[n,s]of Object.entries(t))e.keystores[n]={name:s.name,keystore:s.keystore,createdAt:s.createdAt};return e}importKeystores(e,t=!0){if(!e||"pombo-keystores"!==e.format)throw new Error("Invalid keystores backup format");const n={keystoresImported:0};if(e.keystores){const s=t?this.loadAllKeystores():{};for(const[i,a]of Object.entries(e.keystores))t&&s[i]||(s[i]={name:a.name,keystore:a.keystore,createdAt:a.createdAt||Date.now(),lastUsed:Date.now()},n.keystoresImported++);localStorage.setItem(i,JSON.stringify(s))}return s.V.info("Keystores imported:",n),n}}},7040(e,t,n){n.d(t,{L:()=>c});var s=n(1272),i=n(6976),a=n(5246),r=(n(3413),n(1350)),o=n(6884),l=n(7482);function d(e){const t=e.message||"",n=e.code||"",s=e.reason?.code||e.reason||"",i=t.toLowerCase();return"INSUFFICIENT_FUNDS"===n||t.includes("INSUFFICIENT_FUNDS")||t.includes("code=INSUFFICIENT_FUNDS")||i.includes("insufficient funds")||i.includes("not enough balance")?{isGasError:!0,message:"Insufficient POL for gas fees. Please add POL to your wallet on Polygon network."}:"CALL_EXCEPTION"===n||"CALL_EXCEPTION"===s||t.includes("CALL_EXCEPTION")?{isGasError:!0,message:"Transaction failed. This usually means insufficient POL for gas fees or the transaction was rejected."}:"NETWORK_ERROR"===n||"SERVER_ERROR"===n||i.includes("network")||i.includes("timeout")?{isGasError:!1,message:"Network error. Please check your connection and try again."}:"ACTION_REJECTED"===n||4001===n||i.includes("user rejected")?{isGasError:!1,message:"Transaction was cancelled."}:{isGasError:!1,message:t||"An unknown error occurred"}}const c=new class{constructor(){this.channels=new Map,this.currentChannel=null,this.messageHandlers=[],this.processingMessages=new Set,this.sendingMessages=new Set,this.pendingReactions=new Set,this.REACTION_DEBOUNCE_MS=500,this.onlineUsers=new Map,this.presenceInterval=null,this.ONLINE_TIMEOUT=15e3,this.onlineUsersHandlers=[],this.pendingMessages=new Map,this.MAX_RETRIES=3,this.RETRY_DELAY=2e3}loadChannels(){try{if(!o.Z.isStorageUnlocked())return void s.V.warn("Secure storage not unlocked - cannot load channels");const e=o.Z.getChannels();if(s.V.debug("Loading channels from secure storage"),e&&e.length>0){for(const t of e)t.messages=[],t.reactions={},t.historyLoaded=!1,t.hasMoreHistory=!0,t.loadingHistory=!1,t.oldestTimestamp=null,t.streamId=t.messageStreamId,this.channels.set(t.messageStreamId,t);s.V.debug(`Loaded ${e.length} channels from secure storage (metadata only)`),s.V.debug("Channels in map:",Array.from(this.channels.keys()))}else s.V.debug("No saved channels found")}catch(e){s.V.error("Failed to load channels:",e)}}async saveChannels(){try{if(!o.Z.isStorageUnlocked())return void s.V.warn("Secure storage not unlocked - cannot save channels");const e=Array.from(this.channels.values()).map(e=>({messageStreamId:e.messageStreamId,ephemeralStreamId:e.ephemeralStreamId,name:e.name,type:e.type,createdAt:e.createdAt,createdBy:e.createdBy,password:e.password,members:e.members||[],storageEnabled:e.storageEnabled,exposure:e.exposure||"hidden",description:e.description||"",language:e.language||"",category:e.category||"",readOnly:e.readOnly||!1,classification:e.classification||null}));s.V.debug("Saving channels to secure storage:",e.length),await o.Z.setChannels(e),s.V.debug("Channels saved to secure storage (metadata only)")}catch(e){s.V.error("Failed to save channels:",e)}}clearChannels(){this.channels.clear(),this.currentChannel=null,this.onlineUsers.clear(),this.processingMessages.clear(),this.pendingMessages.clear(),this.sendingMessages.clear(),this.pendingReactions.clear(),s.V.debug("Channels cleared from memory")}async createChannel(e,t,n=null,r=[],l={}){try{const d=a.s.getAddress();if(!d)throw new Error("Not authenticated");s.V.debug("Creating dual-stream channel:",{name:e,type:t,realAddress:d,members:"native"===t?r:[]});const c=await i.xA.createStream(e,d,t,"native"===t?r:[],l);s.V.debug("Dual-stream created:",{messageStreamId:c.messageStreamId,ephemeralStreamId:c.ephemeralStreamId});let h={success:!1,provider:null,storageDays:null};try{h=await i.xA.enableStorage(c.messageStreamId,{storageProvider:l.storageProvider,storageDays:l.storageDays}),s.V.debug("Storage result:",h)}catch(e){s.V.warn("Failed to enable storage (continuing without history):",e.message)}const u="native"===t?[d,...r.filter(e=>e.toLowerCase()!==d.toLowerCase())]:[],m=l.exposure||"hidden",p="native"===t?l.classification||"personal":null,g={messageStreamId:c.messageStreamId,ephemeralStreamId:c.ephemeralStreamId,streamId:c.messageStreamId,name:e,type:t,createdAt:Date.now(),createdBy:d,password:n,members:u,messages:[],reactions:{},storageEnabled:h.success,storageProvider:h.provider||"streamr",storageDays:h.storageDays,exposure:m,description:"visible"===m&&l.description||"",language:"visible"===m?l.language||"en":"",category:"visible"===m?l.category||"general":"",classification:p,readOnly:l.readOnly||!1,historyLoaded:!1,hasMoreHistory:!0,loadingHistory:!1,oldestTimestamp:null};this.channels.set(g.messageStreamId,g),await this.saveChannels(),await o.Z.addToChannelOrder(g.messageStreamId),s.V.debug("Channel saved to localStorage:",g.messageStreamId),s.V.debug("Total channels:",this.channels.size);try{await this.subscribeToChannel(g.messageStreamId),s.V.debug("Subscribed to dual-stream channel")}catch(e){s.V.warn("Failed to subscribe (can retry later):",e)}return s.V.info("Dual-stream channel created successfully:",g.messageStreamId),g}catch(e){s.V.error("Failed to create channel:",e);const t=d(e);throw new Error(t.message)}}async joinChannel(e,t=null,n={}){try{const r=(0,i._k)(e);if(this.channels.has(e))return s.V.debug("Already in this channel"),this.channels.get(e);let d=n.type,c=[],h=n.createdBy||null;s.V.debug("Checking permissions and channel info in parallel...");const u=!d||!h,[m,p]=await Promise.all([i.xA.checkPermissions(e),u?(async()=>{try{const[t,n]=await Promise.all([d?Promise.resolve(d):l.graphAPI.detectStreamType(e),l.graphAPI.getStreamMembers(e)]);return{success:!0,detectedType:t,streamMembers:n}}catch(e){return s.V.warn("Graph API failed, falling back to inference:",e.message),{success:!1,error:e}}})():Promise.resolve({success:!0,detectedType:d,streamMembers:[]})]);if(s.V.debug("Permissions result:",m),!m.canSubscribe)throw new Error("You do not have permission to access this channel. This is a private channel and you are not a member.");if(p.success){d||(d=p.detectedType,s.V.debug("Detected type:",d));const e=p.streamMembers;if(e&&e.length>0){const t=e.find(e=>e.isOwner);!h&&t&&(h=t.address,s.V.debug("Found owner from Graph:",h?.slice(0,10))),"native"===d&&(c=e.map(e=>e.address),s.V.debug("Got",c.length,"members"))}}else d=t?"password":"native";d&&"unknown"!==d||(s.V.debug("Type unknown, defaulting to native (private)"),d=t?"password":"native");let g=n.localName||n.name||e.split("/")[1]?.replace(/-\d$/,"")||e;const w="native"===d?n.classification||"personal":null,v={messageStreamId:e,ephemeralStreamId:r,streamId:e,name:g,type:d,createdAt:Date.now(),createdBy:h,password:t,members:c,messages:[],reactions:{},classification:w,readOnly:n.readOnly||!1,historyLoaded:!1,hasMoreHistory:!0,loadingHistory:!1,oldestTimestamp:null},y=a.s.getAddress();return y&&(v._publishPermCache={address:y,canPublish:m.canPublish,timestamp:Date.now()}),this.channels.set(e,v),await Promise.all([this.saveChannels(),o.Z.addToChannelOrder(e),this.subscribeToChannel(e,t)]),this.notifyHandlers("channelJoined",{streamId:e,messageStreamId:e,ephemeralStreamId:r,password:t,channel:v,permissions:{canPublish:m.canPublish,canSubscribe:m.canSubscribe,isOwner:m.isOwner}}),m.canPublish||s.V.warn("Joined channel with read-only access (no publish permission)"),s.V.info("Joined dual-stream channel:",e),v}catch(e){throw s.V.error("Failed to join channel:",e),e}}async persistChannelFromPreview(e,t={}){try{const n=(0,i._k)(e);if(this.channels.has(e))return s.V.debug("Channel already in list"),this.channels.get(e);s.V.debug("Persisting channel from preview:",e);const a=t.type||"public",r=t.name||e.split("/")[1]?.replace(/-\d$/,"")||e,l="native"===a?t.classification||"personal":null,d=Array.isArray(t.messages)?t.messages:[],c=t.reactions||{},h={messageStreamId:e,ephemeralStreamId:n,streamId:e,name:r,type:a,createdAt:Date.now(),createdBy:t.createdBy||null,password:null,members:[],messages:d,reactions:c,classification:l,readOnly:t.readOnly||!1,historyLoaded:d.length>0,hasMoreHistory:!0,loadingHistory:!1,oldestTimestamp:d.length>0?d[0]?.timestamp:null};return this.channels.set(e,h),await Promise.all([this.saveChannels(),o.Z.addToChannelOrder(e)]),this.notifyHandlers("channelJoined",{streamId:e,messageStreamId:e,ephemeralStreamId:n,channel:h,fromPreview:!0}),s.V.info("Channel persisted from preview:",e),h}catch(e){throw s.V.error("Failed to persist channel from preview:",e),e}}async syncChannelFromGraph(e){const t=this.channels.get(e);if(!t)return s.V.warn("Channel not found for sync:",e),null;try{s.V.debug("Syncing channel from The Graph:",e);const[n,i,a]=await Promise.all([l.graphAPI.getStream(e),l.graphAPI.detectStreamType(e),l.graphAPI.getStreamMembers(e)]);if(!n)return s.V.warn("Stream not found in The Graph"),t;"unknown"!==i&&(t.type=i),t.members=a.map(e=>e.address);const r=a.find(e=>e.isOwner);return r&&(t.createdBy=r.address),await this.saveChannels(),s.V.debug("Channel synced:",{type:t.type,members:t.members.length,owner:t.createdBy?.slice(0,10)}),t}catch(e){return s.V.warn("Failed to sync channel from Graph:",e),t}}async addMember(e,t){const n=this.channels.get(e);if(!n)throw new Error("Channel not found");if("native"!==n.type)throw new Error("Can only add members to native encrypted channels");const a=t.toLowerCase();if(n.members.map(e=>e.toLowerCase()).includes(a))throw new Error("Address is already a member");const r=n.ephemeralStreamId||(0,i._k)(e);try{return await Promise.all([i.xA.grantPermissionsToAddresses(e,[t]),i.xA.grantPermissionsToAddresses(r,[t])]),l.graphAPI.clearCache(),n.members.push(t),await this.saveChannels(),s.V.info("Member added to dual-stream channel:",t),!0}catch(e){s.V.error("Failed to add member:",e);const t=d(e);throw new Error(t.message)}}async removeMember(e,t){const n=this.channels.get(e);if(!n)throw new Error("Channel not found");if("native"!==n.type)throw new Error("Can only remove members from native encrypted channels");const a=t.toLowerCase(),r=n.members.findIndex(e=>e.toLowerCase()===a);if(-1===r)throw new Error("Address is not a member");if(n.createdBy&&n.createdBy.toLowerCase()===a)throw new Error("Cannot remove the channel creator");const o=n.ephemeralStreamId||(0,i._k)(e);try{return await Promise.all([i.xA.revokePermissionsFromAddresses(e,[t]),i.xA.revokePermissionsFromAddresses(o,[t])]),l.graphAPI.clearCache(),n.members.splice(r,1),await this.saveChannels(),s.V.info("Member removed from dual-stream channel:",t),!0}catch(e){s.V.error("Failed to remove member:",e);const t=d(e);throw new Error(t.message)}}async getChannelMembers(e){const t=this.channels.get(e);if(!t)throw new Error("Channel not found");if("native"!==t.type)return[];const n=t.createdBy?.toLowerCase(),i=new Map;n&&i.set(n,{address:n,canGrant:!0,canEdit:!0,canDelete:!0,isOwner:!0});try{s.V.debug("Fetching members from The Graph...");const n=await l.graphAPI.getStreamMembers(e);if(s.V.debug("Graph members result:",n),n&&n.length>0){s.V.debug("Graph returned",n.length,"members");for(const e of n)if(e.address){const t=e.address.toLowerCase();i.set(t,{address:t,canGrant:e.canGrant||!1,canEdit:e.canEdit||!1,canDelete:e.canDelete||!1,isOwner:e.isOwner||!1})}}else if(s.V.debug("Graph empty, using local cache..."),t.members&&t.members.length>0)for(const e of t.members){const t=e.toLowerCase();i.has(t)||i.set(t,{address:t,canGrant:!1,canEdit:!1,canDelete:!1,isOwner:!1})}}catch(e){if(s.V.warn("Failed to get permissions:",e.message),t.members&&t.members.length>0)for(const e of t.members){const t=e.toLowerCase();i.has(t)||i.set(t,{address:t,canGrant:!1,canEdit:!1,canDelete:!1,isOwner:!1})}}const a=Array.from(i.values()).map(e=>{try{return{...e,address:ethers.getAddress(e.address)}}catch{return e}});return t.members=a.map(e=>e.address),await this.saveChannels(),a}async updateMemberPermissions(e,t,n){const a=this.channels.get(e);if(!a)throw new Error("Channel not found");if("native"!==a.type)throw new Error("Can only update permissions on native channels");try{return await i.xA.updatePermissions(e,t,n),l.graphAPI.clearCache(),s.V.info("Member permissions updated:",t,n),!0}catch(e){s.V.error("Failed to update permissions:",e);const t=d(e);throw new Error(t.message)}}isChannelOwner(e){const t=this.channels.get(e),n=a.s.getAddress();if(!n)return!1;if(t?.createdBy&&t.createdBy.toLowerCase()===n.toLowerCase())return!0;const s=(e?.split("/")[0]||"").toLowerCase(),i=n.toLowerCase();return 42===s.length&&s===i}async canAddMembers(e){if(this.isChannelOwner(e))return!0;try{const t=a.s.getAddress();if(!t)return!1;const n=(await this.getChannelMembers(e)).find(e=>e.address.toLowerCase()===t.toLowerCase());return!0===n?.canGrant}catch(e){return s.V.warn("Failed to check canAddMembers:",e),!1}}preloadDeletePermission(e){const t=this.channels.get(e);if(!t)return;const n=a.s.getAddress();n&&t._deletePermCache?.address?.toLowerCase()!==n.toLowerCase()&&i.xA.hasDeletePermission(e).then(t=>{const n=this.channels.get(e),i=a.s.getAddress();n&&i&&(n._deletePermCache={canDelete:t,address:i.toLowerCase()},s.V.debug("Cached DELETE permission:",{streamId:e.slice(-20),canDelete:t}))}).catch(e=>{s.V.warn("Failed to preload DELETE permission:",e.message)})}getCachedDeletePermission(e){const t=this.channels.get(e);if(!t?._deletePermCache)return{valid:!1,canDelete:!1};const n=a.s.getAddress();return n&&t._deletePermCache.address===n.toLowerCase()?{valid:!0,canDelete:t._deletePermCache.canDelete}:{valid:!1,canDelete:!1}}async subscribeToChannel(e,t=null){const n=this.channels.get(e),r=t||(n?n.password:null),o=n?.ephemeralStreamId||(0,i._k)(e);if(n&&!n.storageEnabled){const t=a.s.getAddress()?.toLowerCase(),r=n.createdBy?.toLowerCase();if(t&&r&&t===r){s.V.debug("Owner subscribing - trying to enable storage for messageStream:",e);try{const t=await i.xA.enableStorage(e,{storageProvider:n.storageProvider,storageDays:n.storageDays});t.success&&(n.storageEnabled=!0,n.storageProvider=t.provider,n.storageDays=t.storageDays,await this.saveChannels(),s.V.info("Storage enabled by owner for messageStream"))}catch(e){s.V.debug("Could not enable storage (may already be enabled):",e.message)}}}await i.xA.subscribeToDualStream(e,o,{onMessage:t=>this.handleTextMessage(e,t),onControl:t=>this.handleControlMessage(e,t),onMedia:t=>this.handleMediaMessage(e,t)},r,i.Oi.INITIAL_MESSAGES),s.V.debug("Subscribed to dual-stream channel:",e)}storeReaction(e,t,n,s,i="add"){e.reactions||(e.reactions={}),e.reactions[t]||(e.reactions[t]={}),e.reactions[t][n]||(e.reactions[t][n]=[]);const a=s.toLowerCase(),r=e.reactions[t][n].findIndex(e=>e.toLowerCase()===a);"remove"===i?r>=0&&(e.reactions[t][n].splice(r,1),0===e.reactions[t][n].length&&delete e.reactions[t][n],0===Object.keys(e.reactions[t]).length&&delete e.reactions[t]):r<0&&e.reactions[t][n].push(s)}getChannelReactions(e){const t=this.channels.get(e);return t?.reactions||{}}onOnlineUsersChange(e){this.onlineUsersHandlers.push(e)}notifyOnlineUsersChange(e){const t=this.getOnlineUsers(e);this.onlineUsersHandlers.forEach(n=>{try{n(e,t)}catch(e){s.V.error("Online users handler error:",e)}})}getOnlineUsers(e){const t=this.onlineUsers.get(e);if(!t)return[];const n=Date.now(),s=[];for(const[e,i]of t.entries())n-i.lastActive<this.ONLINE_TIMEOUT&&s.push({id:e,nickname:i.nickname,address:i.address,lastActive:i.lastActive});return s}handlePresenceMessage(e,t){this.onlineUsers.has(e)||this.onlineUsers.set(e,new Map),this.onlineUsers.get(e).set(t.userId,{lastActive:t.lastActive||Date.now(),nickname:t.nickname||null,address:t.address||null}),this.notifyOnlineUsersChange(e)}async publishPresence(e){const t=this.channels.get(e);if(!t)return;const n=t.ephemeralStreamId||(0,i._k)(e),o=a.s.getAddress(),l={type:"presence",userId:o,address:o,nickname:r.E.getUsername?.()||null,lastActive:Date.now()};try{await i.xA.publishControl(n,l,t.password)}catch(e){s.V.warn("Failed to publish presence:",e.message)}}startPresenceTracking(e){this.publishPresence(e),this.presenceInterval&&clearInterval(this.presenceInterval),this.presenceInterval=setInterval(()=>{if(this.currentChannel===e){this.publishPresence(e);const t=this.onlineUsers.get(e);if(t){const n=Date.now();for(const[e,s]of t.entries())n-s.lastActive>this.ONLINE_TIMEOUT&&t.delete(e);this.notifyOnlineUsersChange(e)}}},5e3)}stopPresenceTracking(){this.presenceInterval&&(clearInterval(this.presenceInterval),this.presenceInterval=null)}async handleControlMessage(e,t){if(a.s.isConnected())if("typing"===t.type)this.notifyHandlers("typing",{streamId:e,user:t.user});else if("presence"===t.type)this.handlePresenceMessage(e,t);else if("reaction"===t.type){const n=this.channels.get(e);n&&t.messageId&&t.emoji&&t.user&&this.storeReaction(n,t.messageId,t.emoji,t.user,t.action||"add"),this.notifyHandlers("reaction",{streamId:e,messageId:t.messageId,emoji:t.emoji,user:t.user,action:t.action||"add"})}else if("member_update"===t.type){const n=this.channels.get(e);n&&(n.members=t.members,await this.saveChannels())}}async handleTextMessage(e,t){if(!a.s.isConnected())return;if("presence"===t?.type||"typing"===t?.type)return;if("reaction"===t?.type)return void this.handleControlMessage(e,t);const n=t?.text,i="image"===t?.type&&t?.imageId,o="video_announce"===t?.type&&t?.metadata;if(!t?.id||!t?.sender||!t?.timestamp)return;if(!n&&!i&&!o)return void s.V.debug("Unknown message type, skipping:",t?.type);s.V.debug("handleTextMessage:",{messageId:t.id,type:t.type||"text",sender:t.sender?.slice(0,10)});const l=`${e}:${t.id}`;if(this.processingMessages.has(l))return void s.V.debug("Message already being processed, skipping:",t.id);this.processingMessages.add(l),setTimeout(()=>this.processingMessages.delete(l),5e3);const d=this.channels.get(e);if(!d)return void s.V.warn("Channel not found for streamId:",e);if(d.messages.some(e=>e.id===t.id))return void s.V.debug("Message already exists, skipping duplicate:",t.id);const c=a.s.getAddress(),h=t.sender?.toLowerCase()===c?.toLowerCase(),u=Date.now()-(t.timestamp||0)<3e4;if(h&&u)s.V.debug("Skipping own recent message (already added locally):",t.id);else{try{t.channelId||(t.channelId=e);const n=await r.E.verifyMessage(t,e,{skipTimestampCheck:!u});t.verified=n,n.valid?n.pendingVerification?s.V.debug("Message signature valid, identity pending:",t.sender):n.verifiedViaSession?s.V.debug("Message verified via session key:",n.ensName||t.sender):s.V.debug("Message verified from:",n.ensName||t.sender):(s.V.warn("Message signature verification failed:",n.error),s.V.warn("   Claimed sender:",t.sender),n.actualSigner&&s.V.warn("   Actual signer:",n.actualSigner))}catch(e){s.V.error("Verification error:",e),t.verified={valid:!1,error:e.message,trustLevel:-1}}d.messages.push(t),(!d.oldestTimestamp||t.timestamp<d.oldestTimestamp)&&(d.oldestTimestamp=t.timestamp),this.sortMessagesByTimestamp(d),this.notifyHandlers("message",{streamId:e,message:t})}}handleMediaMessage(e,t){a.s.isConnected()&&"presence"!==t?.type&&"typing"!==t?.type&&"reaction"!==t?.type&&t?.type&&(s.V.debug("Media message received:",t?.type),this.notifyHandlers("media",{streamId:e,media:t}))}async sendMessage(e,t,n=null){let o=null,l=null;try{const d=this.channels.get(e);if(!d)throw new Error("Channel not found");const c=a.s.getAddress();if(!c)throw new Error("Not authenticated");let h=!1;if(d._publishPermCache?.address?.toLowerCase()===c.toLowerCase()&&d._publishPermCache?.timestamp&&Date.now()-d._publishPermCache.timestamp<6e4)h=d._publishPermCache.canPublish;else try{h=await i.xA.hasPublishPermission(e,!0),d._publishPermCache={address:c,canPublish:h,timestamp:Date.now()},s.V.debug("Publish permission check via SDK:",{streamId:e,canPublish:h})}catch(e){s.V.warn("Failed to check publish permission via SDK:",e),h=!0}if(!h)throw new Error("You do not have permission to send messages in this channel.");if(o=await r.E.createSignedMessage(t,e,n),l=`${e}:${o.id}`,this.sendingMessages.has(l))return void s.V.warn("Message already being sent, skipping duplicate:",o.id);this.sendingMessages.add(l),o.verified={valid:!0,trustLevel:await r.E.getTrustLevel(o.sender)},o.pending=!0,d.messages.push(o),this.notifyHandlers("message",{streamId:e,message:o}),await this.publishWithRetry(e,o,d.password),o.pending=!1,this.notifyHandlers("message_confirmed",{streamId:e,messageId:o.id}),s.V.debug("Message sent to messageStream:",o.id)}catch(t){throw s.V.error("Failed to send message:",t),this.notifyHandlers("message_failed",{streamId:e,messageId:o?.id,error:t.message}),t}finally{l&&this.sendingMessages.delete(l)}}async publishWithRetry(e,t,n=null,a=0){try{await i.xA.publishMessage(e,t,n),s.V.info("Text message published to messageStream:",t.id)}catch(i){if(a<this.MAX_RETRIES)return s.V.warn(`Publish failed, retrying (${a+1}/${this.MAX_RETRIES})...`),await new Promise(e=>setTimeout(e,this.RETRY_DELAY)),this.publishWithRetry(e,t,n,a+1);throw i}}async retryPendingMessage(e,t){const n=this.channels.get(e);if(!n)return;const i=n.messages.find(e=>e.id===t&&e.pending);if(i)try{await this.publishWithRetry(e,i,n.password),i.pending=!1,this.notifyHandlers("message_confirmed",{streamId:e,messageId:i.id}),s.V.debug("Pending message sent:",t)}catch(n){s.V.error("Failed to retry message:",n),this.notifyHandlers("message_failed",{streamId:e,messageId:t,error:n.message})}else s.V.warn("Message not found or not pending:",t)}sortMessagesByTimestamp(e){e&&e.messages&&e.messages.sort((e,t)=>(e.timestamp||0)-(t.timestamp||0))}async loadMoreHistory(e){const t=this.channels.get(e);if(!t)return s.V.warn("Channel not found for loadMoreHistory:",e),{loaded:0,hasMore:!1};if(t.loadingHistory)return s.V.debug("Already loading history, skipping"),{loaded:0,hasMore:t.hasMoreHistory};if(!t.hasMoreHistory)return s.V.debug("No more history to load"),{loaded:0,hasMore:!1};if(!t.oldestTimestamp&&0===t.messages.length)return s.V.debug("No messages yet, cannot load more history"),{loaded:0,hasMore:!0};const n=t.oldestTimestamp||Date.now();t.loadingHistory=!0,this.notifyHandlers("history_loading",{streamId:e,loading:!0});try{s.V.debug("Loading more history before:",new Date(n).toISOString());const a=await i.xA.fetchOlderHistory(e,i.Oi.MESSAGE_STREAM.MESSAGES,n,i.Oi.LOAD_MORE_COUNT,t.password);if(a.messages.length>0){for(const n of a.messages)if(!t.messages.some(e=>e.id===n.id)){try{n.channelId||(n.channelId=e);const t=await r.E.verifyMessage(n,e,{skipTimestampCheck:!0});n.verified=t}catch(e){n.verified={valid:!1,error:e.message,trustLevel:-1}}t.messages.push(n),(!t.oldestTimestamp||n.timestamp<t.oldestTimestamp)&&(t.oldestTimestamp=n.timestamp)}this.sortMessagesByTimestamp(t)}return t.hasMoreHistory=a.hasMore,t.loadingHistory=!1,this.notifyHandlers("history_loaded",{streamId:e,loaded:a.messages.length,hasMore:a.hasMore}),s.V.info(`Loaded ${a.messages.length} older messages, hasMore: ${a.hasMore}`),{loaded:a.messages.length,hasMore:a.hasMore}}catch(n){return s.V.error("Failed to load more history:",n),t.loadingHistory=!1,this.notifyHandlers("history_loading",{streamId:e,loading:!1}),{loaded:0,hasMore:t.hasMoreHistory}}}async sendTypingIndicator(e){try{const t=this.channels.get(e);if(!t)return;const n=t.ephemeralStreamId||(0,i._k)(e),s={type:"typing",user:a.s.getAddress(),timestamp:Date.now()};await i.xA.publishControl(n,s,t.password)}catch(e){s.V.error("Failed to send typing indicator:",e)}}async sendReaction(e,t,n,r=!1){const o=r?"remove":"add",l=`${e}:${t}:${n}:${o}`;if(this.pendingReactions.has(l))s.V.debug("Reaction already pending, skipping duplicate:",l);else{this.pendingReactions.add(l);try{const r=this.channels.get(e);if(!r)return;const l={type:"reaction",action:o,messageId:t,emoji:n,user:a.s.getAddress(),timestamp:Date.now()};await i.xA.publishReaction(e,l,r.password),s.V.debug("Reaction",o,":",n,"to message:",t)}catch(e){s.V.error("Failed to send reaction:",e)}finally{setTimeout(()=>{this.pendingReactions.delete(l)},this.REACTION_DEBOUNCE_MS)}}}async leaveChannel(e){try{const t=this.channels.get(e),n=t?.ephemeralStreamId||(0,i._k)(e);await i.xA.unsubscribeFromDualStream(e,n),this.channels.delete(e),await this.saveChannels(),await o.Z.removeFromChannelOrder(e),this.currentChannel===e&&(this.currentChannel=null),s.V.debug("Left channel:",e)}catch(e){throw s.V.error("Failed to leave channel:",e),e}}async leaveAllChannels(){try{const e=Array.from(this.channels.keys());for(const t of e)try{await i.xA.unsubscribe(t)}catch(e){s.V.warn("Failed to unsubscribe from",t,e)}this.channels.clear(),this.currentChannel=null,this.onlineUsers.clear(),this.processingMessages.clear(),this.pendingMessages.clear(),s.V.debug("Left all channels")}catch(e){s.V.error("Failed to leave all channels:",e)}}async deleteChannel(e){try{if(!this.isChannelOwner(e))throw new Error("Only the channel owner can delete a channel");try{await i.xA.deleteStream(e),s.V.debug("Stream deleted from Streamr network:",e)}catch(e){const t=d(e);if(t.isGasError)throw new Error(t.message);s.V.warn("Could not delete from network (may not exist):",e.message)}this.channels.delete(e),await this.saveChannels(),await o.Z.removeFromChannelOrder(e),this.currentChannel===e&&(this.currentChannel=null),s.V.info("Channel removed:",e)}catch(e){throw s.V.error("Failed to delete channel:",e),e}}setCurrentChannel(e){this.currentChannel=e}getCurrentChannel(){return this.currentChannel?this.channels.get(this.currentChannel):null}getChannel(e){return this.channels.get(e)||null}getAllChannels(){return Array.from(this.channels.values())}onMessage(e){this.messageHandlers.push(e)}notifyHandlers(e,t){for(const n of this.messageHandlers)try{n(e,t)}catch(e){s.V.error("Handler error:",e)}}generateInviteLink(e){const t=this.channels.get(e);if(!t)throw new Error("Channel not found");const n={s:e,n:t.name,t:t.type};t.password&&(n.p=t.password);const s=btoa(JSON.stringify(n));return`${window.location.origin}?invite=${s}`}parseInviteLink(e){try{const t=atob(e),n=JSON.parse(t);return{streamId:n.s,name:n.n,type:n.t,password:n.p}}catch(e){return s.V.error("Failed to parse invite link:",e),null}}async getPublicChannels(){const e=new Map;try{s.V.debug("Fetching public channels from The Graph...");const t=await l.graphAPI.getPublicPomboChannels();for(const n of t)e.set(n.streamId,n);s.V.debug(`Found ${t.length} public channels from The Graph`)}catch(e){s.V.warn("Failed to fetch from The Graph:",e.message)}for(const t of this.channels.values())"public"!==t.type||e.has(t.streamId)||e.set(t.streamId,{streamId:t.streamId,name:t.name,createdBy:t.createdBy,createdAt:t.createdAt,type:"public"});const t=Array.from(e.values());return t.sort((e,t)=>(t.createdAt||0)-(e.createdAt||0)),t}}},3413(e,t,n){n.d(t,{Z:()=>s});const s=new class{constructor(){this.textEncoder=new TextEncoder,this.textDecoder=new TextDecoder}async deriveKey(e,t){const n=this.textEncoder.encode(e),s=await crypto.subtle.importKey("raw",n,"PBKDF2",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:31e4,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}generateSalt(){return crypto.getRandomValues(new Uint8Array(16))}generateIV(){return crypto.getRandomValues(new Uint8Array(12))}async encrypt(e,t){try{const n=this.generateSalt(),s=this.generateIV(),i=await this.deriveKey(t,n),a=this.textEncoder.encode(e),r=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},i,a),o=new Uint8Array(n.length+s.length+r.byteLength);return o.set(n,0),o.set(s,n.length),o.set(new Uint8Array(r),n.length+s.length),this.arrayBufferToBase64(o)}catch(e){throw console.error("Encryption failed:",e),e}}async decrypt(e,t){try{const n=this.base64ToArrayBuffer(e),s=n.slice(0,16),i=n.slice(16,28),a=n.slice(28),r=await this.deriveKey(t,s),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},r,a);return this.textDecoder.decode(o)}catch(e){throw console.error("Decryption failed:",e),e}}async encryptJSON(e,t){const n=JSON.stringify(e);return await this.encrypt(n,t)}async decryptJSON(e,t){const n=await this.decrypt(e,t);return JSON.parse(n)}arrayBufferToBase64(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return btoa(n)}base64ToArrayBuffer(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}async sha256(e){const t=this.textEncoder.encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}generateRandomHex(e=16){const t=crypto.getRandomValues(new Uint8Array(e));return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")}}},7482(e,t,n){n.d(t,{graphAPI:()=>r});var s=n(6884),i=n(1272);const a="f56ddaf00b5cbe1eeb1bc003072b5422",r=new class{constructor(){this.cache=new Map,this.CACHE_DURATION=3e4}getApiKey(){if(s.Z.isStorageUnlocked()){const e=s.Z.getGraphApiKey();if(e&&e.trim())return e.trim()}return a}async setApiKey(e){s.Z.isStorageUnlocked()&&(await s.Z.setGraphApiKey(e),i.V.info("Graph API key updated"))}isUsingDefaultKey(){return this.getApiKey()===a}getEndpoint(){return`https://gateway.thegraph.com/api/${this.getApiKey()}/subgraphs/id/EGWFdhhiWypDuz22Uy7b3F69E9MEkyfU9iAQMttkH5Rj`}async query(e,t={}){try{const n=await fetch(this.getEndpoint(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,variables:t})});if(!n.ok)throw new Error(`Graph API error: ${n.status} ${n.statusText}`);const s=await n.json();if(s.errors)throw i.V.error("GraphQL errors:",s.errors),new Error(s.errors[0]?.message||"GraphQL query failed");return s.data}catch(e){throw i.V.error("Graph API query failed:",e),e}}async getCached(e,t){const n=this.cache.get(e);if(n&&Date.now()-n.timestamp<this.CACHE_DURATION)return n.data;const s=await t();return this.cache.set(e,{data:s,timestamp:Date.now()}),s}clearCache(){this.cache.clear()}async getStream(e){const t=`stream:${e}`;return this.getCached(t,async()=>{const t=await this.query("\n                query GetStream($id: ID!) {\n                    stream(id: $id) {\n                        id\n                        metadata\n                        createdAt\n                        updatedAt\n                    }\n                }\n            ",{id:e.toLowerCase()});return t?.stream||null})}async getStreamPermissions(e){const t=`permissions:${e}`;return this.getCached(t,async()=>{const t=`\n                query GetStreamPermissions {\n                    streamPermissions(\n                        first: 100, \n                        where: { stream: "${e}" },\n                        subgraphError: allow\n                    ) {\n                        id\n                        userAddress\n                        userId\n                        canEdit\n                        canDelete\n                        canGrant\n                        publishExpiration\n                        subscribeExpiration\n                    }\n                }\n            `;i.V.debug("Querying streamPermissions for:",e),i.V.debug("Query:",t);const n=await this.query(t);return i.V.debug("Permissions response:",n),n?.streamPermissions||[]})}async detectStreamType(e){try{i.V.debug("Detecting stream type for:",e);try{const t=await this.getStream(e);if(t?.metadata){const e=JSON.parse(t.metadata||"{}"),n=JSON.parse(e.description||"{}");if("pombo"===n.app&&n.type)return i.V.debug("Type from metadata:",n.type),n.type}}catch(e){i.V.debug("Could not get type from metadata:",e.message)}const t=await this.getStreamPermissions(e);if(i.V.debug("Permissions for type detection:",t),0===t.length)return i.V.debug("No permissions found, returning unknown"),"unknown";const n=t.some(e=>{const t=e.userAddress;return null===t||"0x0000000000000000000000000000000000000000"===t})?"public":"native";return i.V.debug("Detected type from permissions:",n),n}catch(e){return i.V.warn("Failed to detect stream type:",e),"unknown"}}async getStreamMembers(e){try{const t=await this.getStreamPermissions(e);i.V.debug("Permissions for members:",t);const n=Math.floor(Date.now()/1e3);return t.filter(e=>e.userAddress&&"0x0000000000000000000000000000000000000000"!==e.userAddress).map(e=>{const t=null===e.publishExpiration||parseInt(e.publishExpiration)>n,s=null===e.subscribeExpiration||parseInt(e.subscribeExpiration)>n;return{address:e.userAddress,canPublish:t,canSubscribe:s,canGrant:e.canGrant||!1,canEdit:e.canEdit||!1,canDelete:e.canDelete||!1,isOwner:e.canGrant&&e.canEdit&&e.canDelete}})}catch(e){return i.V.warn("Failed to get stream members:",e),[]}}async getStreamOwner(e){try{const t=(await this.getStreamMembers(e)).find(e=>e.isOwner);return t?.address||null}catch(e){return i.V.warn("Failed to get stream owner:",e),null}}async searchStreams(e={}){const{owner:t,first:n=20,skip:s=0}=e;let a="";t&&(a=`, where: { permissions_: { userAddress: "${t.toLowerCase()}", canEdit: true } }`);const r=`\n            query SearchStreams {\n                streams(first: ${n}, skip: ${s}${a}, orderBy: createdAt, orderDirection: desc) {\n                    id\n                    metadata\n                    createdAt\n                    updatedAt\n                }\n            }\n        `;try{const e=await this.query(r);return e?.streams||[]}catch(e){return i.V.warn("Failed to search streams:",e),[]}}async getChannelInfo(e){const t=`channel_info:${e}`;return this.getCached(t,async()=>{const t=`\n                query GetChannelInfo {\n                    stream(id: "${e}") {\n                        id\n                        metadata\n                        createdAt\n                        updatedAt\n                    }\n                }\n            `;try{i.V.debug("Querying channel info from The Graph:",e);const n=await this.query(t),s=n?.stream;if(!s)return i.V.debug("Channel not found in The Graph:",e),null;const a=JSON.parse(s.metadata||"{}"),r=JSON.parse(a.description||"{}");return"pombo"!==r.a?(i.V.debug("Stream is not a Pombo channel:",e),null):{streamId:s.id,name:r.n||s.id.split("/")[1]?.split("_")[0]||"Unknown",type:r.t||"public",createdAt:r.ts||1e3*parseInt(s.createdAt),updatedAt:1e3*parseInt(s.updatedAt),createdBy:s.id.split("/")[0]}}catch(e){return i.V.warn("Failed to get channel info:",e),null}},6e4)}async getPublicPomboChannels(e={}){const{first:t=50,skip:n=0}=e,s=`pombo_public:${t}:${n}`;return this.getCached(s,async()=>{const e=`\n                query GetPublicPomboChannels {\n                    streams(\n                        first: ${t}, \n                        skip: ${n}, \n                        orderBy: updatedAt, \n                        orderDirection: desc,\n                        where: { permissions_: { userAddress: "0x0000000000000000000000000000000000000000" } },\n                        subgraphError: allow\n                    ) {\n                        id\n                        metadata\n                        createdAt\n                        updatedAt\n                    }\n                }\n            `;try{i.V.debug("Querying public Pombo channels from The Graph...");const t=await this.query(e),n=t?.streams||[],s=[];for(const e of n)try{if(e.id.endsWith("-2"))continue;const t=JSON.parse(e.metadata||"{}"),n=JSON.parse(t.description||"{}");"pombo"===n.a&&"visible"===n.e&&s.push({streamId:e.id,name:n.n||e.id.split("/")[1]?.split("_")[0]||"Unknown",type:n.t||"public",exposure:n.e,readOnly:n.r||!1,description:n.d||"",language:n.l||"en",category:n.c||"general",createdAt:n.ts||1e3*parseInt(e.createdAt),updatedAt:1e3*parseInt(e.updatedAt),createdBy:e.id.split("/")[0]})}catch(e){continue}return i.V.debug(`Found ${s.length} public Pombo channels`),s}catch(e){return i.V.warn("Failed to get public Pombo channels:",e),[]}})}async testConnection(){try{const e="{ _meta { block { number } } }",t=await this.query(e);return i.V.info("Graph API connected, latest block:",t?._meta?.block?.number),!0}catch(e){return i.V.error("Graph API connection failed:",e),!1}}}},1350(e,t,n){n.d(t,{E:()=>r});var s=n(5246),i=n(6884),a=n(1272);const r=new class{constructor(){this.ensCache=new Map,this.trustedContacts=new Map,this.ensProvider=null,this.username=null}async init(){this.loadTrustedContacts(),this.loadENSCache(),this.loadUsername();try{this.ensProvider=new ethers.JsonRpcProvider("https://eth.llamarpc.com"),a.V.info("ENS provider initialized")}catch(e){a.V.warn("Failed to initialize ENS provider:",e)}}getUsername(){return this.username}async setUsername(e){this.username=e?e.trim():null,await this.saveUsername()}async saveUsername(){i.Z.isStorageUnlocked()?await i.Z.setUsername(this.username):a.V.warn("Cannot save username - secure storage not unlocked")}loadUsername(){try{if(!i.Z.isStorageUnlocked())return void(this.username=null);this.username=i.Z.getUsername()||null}catch(e){a.V.error("Failed to load username:",e)}}async createSignedMessage(e,t,n=null){const i=s.s.getAddress(),a=Date.now(),r=this.generateMessageId(),o=this.createMessageHash(r,e,i,a,t),l=await s.s.signMessage(o);return{type:"text",id:r,text:e,sender:i,senderName:this.username||null,timestamp:a,channelId:t,signature:l,replyTo:n}}createMessageHash(e,t,n,s,i){const a=JSON.stringify({protocol:"POMBO",version:1,id:e,text:t,sender:n.toLowerCase(),timestamp:s,channelId:i});return ethers.keccak256(ethers.toUtf8Bytes(a))}validateTimestamp(e){const t=Date.now(),n=Math.abs(t-e);return n>3e5?{valid:!1,error:`Message timestamp too ${e<t?"old":"future"} (${Math.round(n/6e4)} min)`}:{valid:!0}}generateMessageId(){const e=crypto.getRandomValues(new Uint8Array(16));return Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}async verifyMessage(e,t=null,n={}){const{skipTimestampCheck:s=!1}=n;try{if(!e.signature)return{valid:!1,error:"No signature",trustLevel:-1};if(!s){const t=this.validateTimestamp(e.timestamp);if(!t.valid)return{valid:!1,error:t.error,trustLevel:-1,isReplayAttempt:!0}}const t=this.createMessageHash(e.id,e.text,e.sender,e.timestamp,e.channelId),n=ethers.verifyMessage(t,e.signature);if(n.toLowerCase()!==e.sender.toLowerCase())return{valid:!1,error:"Signature mismatch",claimedSender:e.sender,actualSigner:n,trustLevel:-1};return{valid:!0,recoveredAddress:n,trustLevel:await this.getTrustLevel(n),ensName:await this.resolveENS(n)}}catch(e){return a.V.error("Signature verification failed:",e),{valid:!1,error:e.message,trustLevel:-1}}}async resolveENS(e){const t=e.toLowerCase(),n=this.ensCache.get(t);if(n&&Date.now()-n.timestamp<864e5)return n.name;if(!this.ensProvider)return null;try{const n=await this.ensProvider.lookupAddress(e);return this.ensCache.set(t,{name:n,timestamp:Date.now()}),await this.saveENSCache(),n}catch(t){return a.V.warn("ENS lookup failed for",e,t),null}}async resolveAddress(e){if(!this.ensProvider)return null;try{return await this.ensProvider.resolveName(e)}catch(t){return a.V.warn("ENS resolve failed for",e,t),null}}async addTrustedContact(e,t=null,n=null){const i=e.toLowerCase();this.trustedContacts.set(i,{address:e,nickname:t||`Contact ${e.slice(0,8)}`,notes:n,addedAt:Date.now(),addedBy:s.s.getAddress()}),await this.saveTrustedContacts(),a.V.info("Added trusted contact:",e)}async removeTrustedContact(e){const t=e.toLowerCase();this.trustedContacts.delete(t),await this.saveTrustedContacts(),a.V.info("Removed trusted contact:",e)}getTrustedContact(e){return this.trustedContacts.get(e.toLowerCase())||null}getAllTrustedContacts(){return Array.from(this.trustedContacts.values())}async getTrustLevel(e){const t=e.toLowerCase();return this.trustedContacts.has(t)?2:await this.resolveENS(e)?1:0}getTrustLevelInfo(e){const t={[-1]:{label:"Invalid Signature",icon:'<svg class="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',color:"red",bgColor:"bg-red-900/30",textColor:"text-red-400"},0:{label:"Valid Signature",icon:'<svg class="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',color:"green",bgColor:"",textColor:"text-green-400"},1:{label:"ENS Verified",icon:'<svg class="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"/></svg>',color:"green",bgColor:"",textColor:"text-green-400"},2:{label:"Trusted Contact",icon:'<svg class="w-3.5 h-3.5 inline" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd"/></svg>',color:"yellow",bgColor:"",textColor:"text-yellow-400"}};return t[e]||t[0]}async saveTrustedContacts(){if(!i.Z.isStorageUnlocked())return void a.V.warn("Cannot save contacts - secure storage not unlocked");const e=Object.fromEntries(this.trustedContacts.entries());await i.Z.setTrustedContacts(e)}loadTrustedContacts(){try{if(!i.Z.isStorageUnlocked())return;const e=i.Z.getTrustedContacts();e&&"object"==typeof e&&(this.trustedContacts=new Map(Object.entries(e)))}catch(e){a.V.error("Failed to load trusted contacts:",e)}}async saveENSCache(){if(!i.Z.isStorageUnlocked())return;const e=Object.fromEntries(this.ensCache.entries());await i.Z.setENSCache(e)}loadENSCache(){try{if(!i.Z.isStorageUnlocked())return;const e=i.Z.getENSCache();e&&"object"==typeof e&&(this.ensCache=new Map(Object.entries(e)))}catch(e){a.V.error("Failed to load ENS cache:",e)}}async getDisplayName(e){const t=await this.resolveENS(e);if(t)return t;const n=this.getTrustedContact(e);return n&&n.nickname?n.nickname:`${e.slice(0,6)}...${e.slice(-4)}`}async getIdentityInfo(e,t=null){const n=t?.ensName||await this.resolveENS(e),s=t?.trustLevel??await this.getTrustLevel(e),i=this.getTrustLevelInfo(s),a=this.getTrustedContact(e),r=n||a?.nickname||`${e.slice(0,6)}...${e.slice(-4)}`;return{address:e,displayName:r,ensName:n,nickname:a?.nickname,trustLevel:s,trustInfo:i,isTrusted:s>=2,hasENS:!!n,signatureValid:t?.valid??null}}}},1272(e,t,n){n.d(t,{V:()=>s});const s={LEVELS:{NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4},currentLevel:1,error:function(e,...t){this.currentLevel>=this.LEVELS.ERROR&&console.error("",e,...t)},warn:function(e,...t){this.currentLevel>=this.LEVELS.WARN&&console.warn("",e,...t)},info:function(e,...t){this.currentLevel>=this.LEVELS.INFO&&console.log("",e,...t)},debug:function(e,...t){this.currentLevel>=this.LEVELS.DEBUG&&console.log("",e,...t)},setLevel:function(e){this.currentLevel=e,e>=this.LEVELS.INFO&&console.log(" Logger level set to:",Object.keys(this.LEVELS).find(t=>this.LEVELS[t]===e))},enableDebug:function(){this.setLevel(this.LEVELS.DEBUG)},enableProduction:function(){this.setLevel(this.LEVELS.ERROR)}};"undefined"!=typeof window&&("localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||(s.currentLevel=s.LEVELS.DEBUG),window.Logger=s)},9110(e,t,n){n.d(t,{F:()=>d});var s=n(1272),i=n(6976),a=n(5246),r=n(1350),o=n(7040);const l={IMAGE_MAX_WIDTH:1280,IMAGE_MAX_HEIGHT:720,IMAGE_QUALITY:.8,ALLOWED_IMAGE_TYPES:["image/jpeg","image/png","image/gif","image/webp"],ALLOWED_VIDEO_TYPES:["video/mp4","video/webm","video/quicktime","video/x-m4v","video/ogg"],PLAYABLE_VIDEO_TYPES:["video/mp4","video/webm","video/ogg","video/x-m4v","video/m4v"],PIECE_SIZE:65536,PIECE_SEND_DELAY:5,MAX_CONCURRENT_REQUESTS:8,PIECE_REQUEST_TIMEOUT:1e4,MAX_FILE_SIZE:524288e3,MIN_SEEDERS:1,PREFERRED_SEEDERS:3,SEEDER_REQUEST_INTERVAL:2e3,SEEDER_DISCOVERY_TIMEOUT:3e4,SEEDER_REFRESH_INTERVAL:1e4,MAX_SEEDER_REQUESTS:10,MAX_SEED_STORAGE:524288e3,SEED_FILES_EXPIRE_DAYS:7,AUTO_SEED_ON_JOIN:!0,PERSIST_PUBLIC_CHANNELS:!0,PERSIST_PRIVATE_CHANNELS:!1},d=new class{constructor(){this.imageCache=new Map,this.localFiles=new Map,this.downloadedUrls=new Map,this.incomingFiles=new Map,this.fileSeeders=new Map,this.fileWorker=null,this.handlers={onImageReceived:null,onFileAnnounced:null,onFileProgress:null,onFileComplete:null,onSeederUpdate:null},this.db=null,this.persistedStorageSize=0,this.currentOwnerAddress=null,this.pieceSendQueue=[],this.isSendingPieces=!1,this.lastPieceSentTime=0}async init(){await this.initIndexedDB(),this.initFileWorker(),s.V.info("Media controller initialized (waiting for wallet connection)")}async setOwner(e){this.currentOwnerAddress=e?.toLowerCase()||null,this.currentOwnerAddress&&(await this.loadPersistedSeedFiles(),s.V.info("Media controller: owner set to",this.currentOwnerAddress.slice(0,8)+"..."))}reset(){for(const[e,t]of this.incomingFiles)if(t.seederDiscoveryTimer&&clearTimeout(t.seederDiscoveryTimer),t.requestsInFlight)for(const[e,n]of t.requestsInFlight)n.timeoutId&&clearTimeout(n.timeoutId);for(const e of this.downloadedUrls.values())URL.revokeObjectURL(e);this.imageCache.clear(),this.localFiles.clear(),this.downloadedUrls.clear(),this.incomingFiles.clear(),this.fileSeeders.clear(),this.pieceSendQueue=[],this.isSendingPieces=!1,this.lastPieceSentTime=0,this.currentOwnerAddress=null,this.persistedStorageSize=0,s.V.info("Media controller reset")}async initIndexedDB(){return new Promise((e,t)=>{const n=indexedDB.open("PomboMediaDB",2);n.onerror=()=>{s.V.warn("IndexedDB not available, using memory only"),e()},n.onsuccess=t=>{this.db=t.target.result,s.V.debug("IndexedDB initialized (v2)"),e()},n.onupgradeneeded=e=>{const t=e.target.result;if(t.objectStoreNames.contains("pieces")||t.createObjectStore("pieces",{keyPath:["fileId","pieceIndex"]}),!t.objectStoreNames.contains("seedFiles")){const e=t.createObjectStore("seedFiles",{keyPath:"fileId"});e.createIndex("streamId","streamId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}s.V.info("IndexedDB upgraded to v2 with seedFiles store")}})}initFileWorker(){const e=`\n            async function calculateSHA256(buffer) {\n                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);\n                const hashArray = Array.from(new Uint8Array(hashBuffer));\n                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\n            }\n\n            self.onmessage = async (event) => {\n                const { fileData, tempId } = event.data;\n                const PIECE_SIZE = ${l.PIECE_SIZE};\n                const pieceHashes = [];\n                \n                const arrayBuffer = await fileData.arrayBuffer();\n                const bytes = new Uint8Array(arrayBuffer);\n                \n                // Process file in chunks\n                for (let offset = 0; offset < bytes.length; offset += PIECE_SIZE) {\n                    const chunk = bytes.slice(offset, Math.min(offset + PIECE_SIZE, bytes.length));\n                    const hash = await calculateSHA256(chunk.buffer);\n                    pieceHashes.push(hash);\n                }\n\n                const metadata = {\n                    fileId: crypto.randomUUID(),\n                    fileName: fileData.name,\n                    fileSize: fileData.size,\n                    fileType: fileData.type,\n                    pieceCount: pieceHashes.length,\n                    pieceHashes: pieceHashes\n                };\n                \n                self.postMessage({ status: 'complete', metadata, tempId });\n            };\n        `,t=new Blob([e],{type:"application/javascript"});this.fileWorker=new Worker(URL.createObjectURL(t)),this.fileWorker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.fileWorker.onerror=e=>{s.V.error("File worker error:",e)}}async handleWorkerMessage(e){const{status:t,metadata:n,tempId:i}=e;if("complete"===t){const e=this.localFiles.get(i);if(!e)return void s.V.error("Could not find temp file reference:",i);if(this.localFiles.delete(i),this.localFiles.set(n.fileId,{file:e.file,metadata:n,streamId:e.streamId,isPrivateChannel:e.isPrivateChannel,persisted:!1,callback:e.callback}),e.callback&&await e.callback(n),e.streamId&&await this.persistSeedFile(n.fileId,e.file,n,e.streamId,e.isPrivateChannel)){const e=this.localFiles.get(n.fileId);e&&(e.persisted=!0)}}}async sendImage(e,t,n=null){if(!l.ALLOWED_IMAGE_TYPES.includes(t.type))throw new Error(`Invalid image type. Allowed: ${l.ALLOWED_IMAGE_TYPES.join(", ")}`);const a=await this.resizeImage(t),d=crypto.randomUUID();this.imageCache.set(d,a);const c=await r.E.createSignedMessage("",e);c.type="image",c.imageId=d,c.imageData=a;const h=c.id;c.verified={valid:!0,trustLevel:await r.E.getTrustLevel(c.sender)};const u=o.L.getChannel(e);return u&&(u.messages.push(c),o.L.notifyHandlers("message",{streamId:e,message:c})),await i.xA.publishMessage(e,c,n),s.V.debug("Image message sent with data:",d),{messageId:h,imageId:d,data:a}}resizeImage(e){return new Promise((t,n)=>{const s=new FileReader;s.onload=e=>{const s=new Image;s.onload=()=>{let{width:n,height:i}=s;if(n<=l.IMAGE_MAX_WIDTH&&i<=l.IMAGE_MAX_HEIGHT)return void t(e.target.result);const a=l.IMAGE_MAX_WIDTH/n,r=l.IMAGE_MAX_HEIGHT/i,o=Math.min(a,r);n=Math.round(n*o),i=Math.round(i*o);const d=document.createElement("canvas");d.width=n,d.height=i,d.getContext("2d").drawImage(s,0,0,n,i),t(d.toDataURL("image/jpeg",l.IMAGE_QUALITY))},s.onerror=()=>n(new Error("Failed to load image")),s.src=e.target.result},s.onerror=()=>n(new Error("Failed to read file")),s.readAsDataURL(e)})}handleImageData(e){"image_data"===e.type&&e.imageId&&e.data&&(this.imageCache.set(e.imageId,e.data),s.V.debug("Image received:",e.imageId),this.handlers.onImageReceived&&this.handlers.onImageReceived(e.imageId,e.data))}getImage(e){return this.imageCache.get(e)||null}cacheImage(e,t){this.imageCache.has(e)||(this.imageCache.set(e,t),s.V.debug("Image cached from message:",e))}getDownloadedFile(e){return this.downloadedUrls.get(e)||null}getLocalFileUrl(e){const t=this.localFiles.get(e);if(!t||!t.file)return null;if(!this.downloadedUrls.has(e)){const n=URL.createObjectURL(t.file);this.downloadedUrls.set(e,n)}return this.downloadedUrls.get(e)}isSeeding(e){return this.localFiles.has(e)}getFileUrl(e){return this.getDownloadedFile(e)||this.getLocalFileUrl(e)}async requestImage(e,t,n=null){const a=(0,i._k)(e),r={type:"image_request",imageId:t};await i.xA.publishMedia(a,r,n),s.V.debug("Image requested:",t)}async sendVideo(e,t,n=null){if(!l.ALLOWED_VIDEO_TYPES.includes(t.type))throw new Error(`Invalid video type. Allowed: ${l.ALLOWED_VIDEO_TYPES.join(", ")}`);if(t.size>l.MAX_FILE_SIZE)throw new Error(`File too large. Max: ${l.MAX_FILE_SIZE/1024/1024}MB`);return new Promise((a,l)=>{const d="temp-"+crypto.randomUUID(),c=!!n;this.localFiles.set(d,{file:t,streamId:e,isPrivateChannel:c,callback:async t=>{try{const l=await r.E.createSignedMessage("",e);l.type="video_announce",l.metadata=t,l.verified={valid:!0,trustLevel:await r.E.getTrustLevel(l.sender)};const d=o.L.getChannel(e);d&&(d.messages.push(l),o.L.notifyHandlers("message",{streamId:e,message:l})),await i.xA.publishMessage(e,l,n),s.V.info("Video announced:",t.fileId,t.fileName),a({messageId:l.id,metadata:t})}catch(e){l(e)}}}),this.fileWorker.postMessage({fileData:t,tempId:d})})}handleMediaMessage(e,t){if(t&&t.type)switch(t.type){case"image_data":this.handleImageData(t);break;case"image_request":this.handleImageRequest(e,t);break;case"piece_request":this.handlePieceRequest(e,t);break;case"file_piece":this.handleFilePiece(e,t);break;case"source_request":this.handleSourceRequest(e,t);break;case"source_announce":this.handleSourceAnnounce(t);break;default:s.V.debug("Unknown media type:",t.type)}}async handleImageRequest(e,t){const n=this.imageCache.get(t.imageId);if(!n)return;const a=o.L.getChannel(e),r=a?.password||null,l=(0,i._k)(e),d={type:"image_data",imageId:t.imageId,data:n};await i.xA.publishMedia(l,d,r),s.V.debug("Image data sent in response to request:",t.imageId,r?"(encrypted)":"")}async startDownload(e,t,n=null){const{fileId:i,fileName:a,fileSize:r,fileType:o,pieceCount:l,pieceHashes:d}=t;if(this.incomingFiles.has(i))return void s.V.warn("Download already in progress:",i);const c={metadata:t,streamId:e,password:n,isPrivateChannel:!!n,pieceStatus:new Array(l).fill("pending"),requestsInFlight:new Map,receivedCount:0,pieces:new Array(l).fill(null),useIndexedDB:this.db&&r>10485760,seederRequestCount:0,lastSeederRequest:0,seederDiscoveryTimer:null,downloadStarted:!1};this.incomingFiles.set(i,c),this.fileSeeders.set(i,new Set),this.startSeederDiscovery(i),s.V.info("Started download:",i,a)}async startSeederDiscovery(e){const t=this.incomingFiles.get(e);if(!t)return;this.fileSeeders.get(e),await this.requestFileSources(t.streamId,e,t.password),t.seederRequestCount++,t.lastSeederRequest=Date.now();const n=async()=>{const t=this.incomingFiles.get(e);if(!t)return;const i=this.fileSeeders.get(e),a=i?.size||0,r=Date.now(),o=a<l.PREFERRED_SEEDERS,d=t.seederRequestCount<l.MAX_SEEDER_REQUESTS,c=r-t.lastSeederRequest>=l.SEEDER_REQUEST_INTERVAL;o&&d&&c&&(s.V.debug(`Requesting more seeders for ${e} (current: ${a}, requests: ${t.seederRequestCount})`),await this.requestFileSources(t.streamId,e,t.password),t.seederRequestCount++,t.lastSeederRequest=r),a>=l.MIN_SEEDERS&&!t.downloadStarted&&(t.downloadStarted=!0,s.V.info(`Starting piece download with ${a} seeders for ${e}`),this.manageDownload(e)),(!t.downloadStarted||a<l.PREFERRED_SEEDERS)&&(r-(t.downloadStartTime||r)<l.SEEDER_DISCOVERY_TIMEOUT?t.seederDiscoveryTimer=setTimeout(n,l.SEEDER_REQUEST_INTERVAL):t.downloadStarted||0!==a||(s.V.warn(`No seeders found for ${e} after ${l.SEEDER_DISCOVERY_TIMEOUT}ms`),await this.requestFileSources(t.streamId,e,t.password)))};t.downloadStartTime=Date.now(),t.seederDiscoveryTimer=setTimeout(n,l.SEEDER_REQUEST_INTERVAL)}manageDownload(e){const t=this.incomingFiles.get(e);if(!t)return;const n=this.fileSeeders.get(e);if(!n||0===n.size)return t.downloadStarted&&(s.V.debug(`Lost all seeders for ${e}, requesting more...`),this.requestFileSources(t.streamId,e,t.password)),void setTimeout(()=>this.manageDownload(e),1e3);const i=Array.from(n);let a=0;for(let n=0;n<t.pieceStatus.length&&!(t.requestsInFlight.size>=l.MAX_CONCURRENT_REQUESTS);n++)if("pending"===t.pieceStatus[n]){const t=i[a%i.length];a++,this.requestPiece(e,n,t)}const r=Date.now();t.lastSeederRequest&&r-t.lastSeederRequest>l.SEEDER_REFRESH_INTERVAL&&n.size<l.PREFERRED_SEEDERS&&t.seederRequestCount<l.MAX_SEEDER_REQUESTS&&(s.V.debug(`Refreshing seeders for slow download ${e}`),this.requestFileSources(t.streamId,e,t.password),t.seederRequestCount++,t.lastSeederRequest=r)}async requestPiece(e,t,n){const a=this.incomingFiles.get(e);if(!a)return;a.pieceStatus[t]="requested";const r=setTimeout(()=>{const n=a.pieceStatus[t];"requested"!==n&&"processing"!==n||(s.V.debug(`Piece ${t} timed out (was ${n})`),a.pieceStatus[t]="pending",a.requestsInFlight.delete(t),this.manageDownload(e))},l.PIECE_REQUEST_TIMEOUT);a.requestsInFlight.set(t,{seederId:n,timeoutId:r});const o=(0,i._k)(a.streamId),d={type:"piece_request",fileId:e,pieceIndex:t,targetSeederId:n};await i.xA.publishMedia(o,d,a.password)}async handlePieceRequest(e,t){const n=a.s.getAddress()?.toLowerCase(),i=t.targetSeederId?.toLowerCase();n&&i===n&&(this.localFiles.get(t.fileId)?(s.V.debug("Sending piece",t.pieceIndex,"of",t.fileId?.slice(0,8)),await this.sendPiece(e,t.fileId,t.pieceIndex)):s.V.warn("piece_request for unknown file:",t.fileId?.slice(0,8)))}async sendPiece(e,t,n){return new Promise(s=>{this.pieceSendQueue.push({messageStreamId:e,fileId:t,pieceIndex:n,resolve:s}),this.processPieceQueue()})}async processPieceQueue(){if(!this.isSendingPieces&&0!==this.pieceSendQueue.length){for(this.isSendingPieces=!0;this.pieceSendQueue.length>0;){const{messageStreamId:e,fileId:t,pieceIndex:n,resolve:s}=this.pieceSendQueue.shift(),i=Date.now()-this.lastPieceSentTime;i<l.PIECE_SEND_DELAY&&await new Promise(e=>setTimeout(e,l.PIECE_SEND_DELAY-i)),await this._sendPieceImmediate(e,t,n),this.lastPieceSentTime=Date.now(),s()}this.isSendingPieces=!1}}async _sendPieceImmediate(e,t,n){const a=this.localFiles.get(t);if(!a)return;const{file:r,metadata:d}=a,c=n*l.PIECE_SIZE,h=Math.min(c+l.PIECE_SIZE,r.size),u=r.slice(c,h),m=await u.arrayBuffer(),p=this.arrayBufferToBase64(m),g=o.L.getChannel(e),w=g?.password||null,v=(0,i._k)(e),y={type:"file_piece",fileId:t,pieceIndex:n,data:p};await i.xA.publishMedia(v,y,w),s.V.debug("Sent piece",n,"of",t,w?"(encrypted)":"")}async handleFilePiece(e,t){const n=a.s.getAddress()?.toLowerCase(),i=t.senderId?.toLowerCase();if(i===n)return;const r=this.incomingFiles.get(t.fileId);if(!r)return;const{fileId:o,pieceIndex:l}=t;if("done"===r.pieceStatus[l])return void s.V.debug("Piece already done, skipping:",l);if("requested"!==r.pieceStatus[l])return void s.V.debug("Piece not in requested state:",l,r.pieceStatus[l]);r.pieceStatus[l]="processing";const d=this.base64ToArrayBuffer(t.data);if(!d)return s.V.error("Failed to decode piece:",l),r.pieceStatus[l]="pending",void this.manageDownload(o);if(await this.sha256(d)!==r.metadata.pieceHashes[l])return s.V.error("Hash mismatch for piece:",l),r.pieceStatus[l]="pending",void this.manageDownload(o);const c=r.requestsInFlight.get(l);c&&(clearTimeout(c.timeoutId),r.requestsInFlight.delete(l)),r.useIndexedDB?await this.savePieceToIndexedDB(o,l,new Uint8Array(d)):r.pieces[l]=new Uint8Array(d),r.pieceStatus[l]="done",r.receivedCount++;const h=Math.round(r.receivedCount/r.metadata.pieceCount*100);this.handlers.onFileProgress&&this.handlers.onFileProgress(o,h,r.receivedCount,r.metadata.pieceCount,r.metadata.fileSize),r.pieceStatus.filter(e=>"done"===e).length===r.metadata.pieceCount?await this.assembleFile(o):this.manageDownload(o)}async assembleFile(e){const t=this.incomingFiles.get(e);if(!t)return;const n=t.pieceStatus.filter(e=>"done"===e).length,i=t.metadata.pieceCount;if(n!==i)return s.V.error(`Assembly aborted: only ${n}/${i} pieces done`),void this.manageDownload(e);let a;if(s.V.info("Assembling file:",e,`(${i} pieces, ${t.metadata.fileSize} bytes)`),t.useIndexedDB)a=await this.assembleFromIndexedDB(e,t.metadata);else{const e=t.pieces.reduce((e,t)=>e+(t?.length||0),0);e!==t.metadata.fileSize&&s.V.warn(`Size mismatch: got ${e}, expected ${t.metadata.fileSize}`);const n=new Uint8Array(e);let i=0;for(let e=0;e<t.pieces.length;e++){const a=t.pieces[e];a?(n.set(a,i),i+=a.length):s.V.error(`Missing piece at index ${e} during assembly!`)}a=new Blob([n],{type:t.metadata.fileType})}a.size!==t.metadata.fileSize?s.V.error(`Final blob size mismatch: got ${a.size}, expected ${t.metadata.fileSize}`):s.V.info(`File assembled correctly: ${a.size} bytes`);const r=URL.createObjectURL(a);if(this.downloadedUrls.set(e,r),this.handlers.onFileComplete&&this.handlers.onFileComplete(e,t.metadata,r,a),this.localFiles.set(e,{file:a,metadata:t.metadata,streamId:t.streamId,persisted:!1}),await this.announceFileSource(t.streamId,e,t.password),await this.persistSeedFile(e,a,t.metadata,t.streamId,t.isPrivateChannel)){const t=this.localFiles.get(e);t&&(t.persisted=!0)}t.seederDiscoveryTimer&&clearTimeout(t.seederDiscoveryTimer),this.incomingFiles.delete(e),this.db&&await this.clearFileFromIndexedDB(e),s.V.info("File complete:",t.metadata.fileName)}async requestFileSources(e,t,n=null){const a=(0,i._k)(e),r={type:"source_request",fileId:t};await i.xA.publishMedia(a,r,n),s.V.debug("Requested sources for:",t)}async handleSourceRequest(e,t){if(this.localFiles.has(t.fileId)){const n=o.L.getChannel(e),s=n?.password||null;await this.announceFileSource(e,t.fileId,s)}}async announceFileSource(e,t,n=null){const a=(0,i._k)(e),r={type:"source_announce",fileId:t};await i.xA.publishMedia(a,r,n),s.V.debug("Announced as source for:",t)}handleSourceAnnounce(e){const t=this.fileSeeders.get(e.fileId);if(t&&e.senderId){const n=e.senderId.toLowerCase();t.add(n),s.V.debug("Seeder announced for file:",e.fileId,"seeder:",n),this.handlers.onSeederUpdate&&this.handlers.onSeederUpdate(e.fileId,t.size)}}cancelDownload(e){const t=this.incomingFiles.get(e);if(t){t.seederDiscoveryTimer&&clearTimeout(t.seederDiscoveryTimer);for(const[,e]of t.requestsInFlight)clearTimeout(e.timeoutId);this.incomingFiles.delete(e),this.fileSeeders.delete(e),this.db&&this.clearFileFromIndexedDB(e),s.V.info("Download cancelled:",e)}}async savePieceToIndexedDB(e,t,n){if(this.db)return new Promise((s,i)=>{const a=this.db.transaction("pieces","readwrite").objectStore("pieces").put({fileId:e,pieceIndex:t,data:n});a.onsuccess=()=>s(),a.onerror=()=>i(a.error)})}async assembleFromIndexedDB(e,t){return this.db?new Promise((n,i)=>{const a=this.db.transaction("pieces","readonly").objectStore("pieces"),r=new Array(t.pieceCount).fill(null);let o=0;const l=a.openCursor();l.onsuccess=i=>{const a=i.target.result;if(a){if(a.value.fileId===e){const e=a.value.pieceIndex;e>=0&&e<t.pieceCount&&(r[e]=a.value.data,o++)}a.continue()}else{o!==t.pieceCount&&s.V.error(`IndexedDB assembly: found ${o}/${t.pieceCount} pieces`);const e=r.reduce((e,t)=>e+(t?.length||0),0);e!==t.fileSize&&s.V.warn(`IndexedDB size mismatch: got ${e}, expected ${t.fileSize}`);const i=new Uint8Array(e);let a=0;for(let e=0;e<r.length;e++){const t=r[e];t?(i.set(t,a),a+=t.length):s.V.error(`Missing piece at index ${e} in IndexedDB!`)}s.V.info(`Assembled from IndexedDB: ${e} bytes, ${o} pieces`),n(new Blob([i],{type:t.fileType}))}},l.onerror=()=>i(l.error)}):null}async clearFileFromIndexedDB(e){if(this.db)return new Promise((t,n)=>{const s=this.db.transaction("pieces","readwrite").objectStore("pieces").openCursor();s.onsuccess=n=>{const s=n.target.result;s?(s.value.fileId===e&&s.delete(),s.continue()):t()},s.onerror=()=>n(s.error)})}async loadPersistedSeedFiles(){if(this.db&&this.db.objectStoreNames.contains("seedFiles"))if(this.currentOwnerAddress)try{const e=await this.getAllSeedFiles(),t=Date.now(),n=24*l.SEED_FILES_EXPIRE_DAYS*60*60*1e3;let i=0,a=0,r=0;for(const s of e){const e=s.ownerAddress?.toLowerCase();if(!e||e!==this.currentOwnerAddress){r++;continue}if(t-s.timestamp>n){await this.removeSeedFile(s.fileId),a++;continue}const o=new Blob([s.fileData],{type:s.metadata.fileType}),l=URL.createObjectURL(o);this.localFiles.set(s.fileId,{file:o,metadata:s.metadata,streamId:s.streamId,persisted:!0}),this.downloadedUrls.set(s.fileId,l),this.persistedStorageSize+=s.metadata.fileSize,i++}(i>0||a>0||r>0)&&s.V.info(`Seed files: loaded ${i}, expired ${a}, skipped ${r} (other users/legacy), storage: ${(this.persistedStorageSize/1024/1024).toFixed(2)}MB`)}catch(e){s.V.error("Failed to load persisted seed files:",e)}else s.V.debug("No owner address set - skipping seed file load");else s.V.debug("No seedFiles store available")}async persistSeedFile(e,t,n,i,a=!1){if(!this.db||!this.db.objectStoreNames.contains("seedFiles"))return!1;if(!this.currentOwnerAddress)return s.V.debug("No owner address set - skipping persistence"),!1;if(a&&!l.PERSIST_PRIVATE_CHANNELS)return s.V.debug("Skipping persistence for private channel file:",e),!1;if(!a&&!l.PERSIST_PUBLIC_CHANNELS)return s.V.debug("Skipping persistence for public channel file:",e),!1;if(this.persistedStorageSize+n.fileSize>l.MAX_SEED_STORAGE&&await this.evictOldestSeedFiles(n.fileSize)<n.fileSize)return s.V.warn(`Cannot persist file ${e}: storage quota exceeded`),!1;try{const a={fileId:e,streamId:i,metadata:n,fileData:await t.arrayBuffer(),timestamp:Date.now(),ownerAddress:this.currentOwnerAddress};return await this.saveSeedFile(a),this.persistedStorageSize+=n.fileSize,s.V.info(`Persisted seed file: ${n.fileName} (${(n.fileSize/1024/1024).toFixed(2)}MB)`),!0}catch(e){return s.V.error("Failed to persist seed file:",e),!1}}async saveSeedFile(e){if(this.db)return new Promise((t,n)=>{const s=this.db.transaction("seedFiles","readwrite").objectStore("seedFiles").put(e);s.onsuccess=()=>t(),s.onerror=()=>n(s.error)})}async getAllSeedFiles(){return this.db?new Promise((e,t)=>{const n=this.db.transaction("seedFiles","readonly").objectStore("seedFiles").getAll();n.onsuccess=()=>e(n.result||[]),n.onerror=()=>t(n.error)}):[]}async getSeedFilesByStream(e){return this.db?new Promise((t,n)=>{const s=this.db.transaction("seedFiles","readonly").objectStore("seedFiles").index("streamId").getAll(e);s.onsuccess=()=>t(s.result||[]),s.onerror=()=>n(s.error)}):[]}async removeSeedFile(e){if(!this.db)return;const t=this.localFiles.get(e);t?.metadata?.fileSize&&(this.persistedStorageSize-=t.metadata.fileSize);const n=this.downloadedUrls.get(e);return n&&(URL.revokeObjectURL(n),this.downloadedUrls.delete(e)),this.localFiles.delete(e),new Promise((t,n)=>{const i=this.db.transaction("seedFiles","readwrite").objectStore("seedFiles").delete(e);i.onsuccess=()=>{s.V.debug("Removed seed file:",e),t()},i.onerror=()=>n(i.error)})}async evictOldestSeedFiles(e){if(!this.db)return 0;const t=await this.getAllSeedFiles();t.sort((e,t)=>e.timestamp-t.timestamp);let n=0;for(const i of t){if(n>=e)break;n+=i.metadata.fileSize,await this.removeSeedFile(i.fileId),s.V.info(`Evicted old seed file: ${i.metadata.fileName}`)}return n}async reannounceForChannel(e,t=null){if(!l.AUTO_SEED_ON_JOIN)return;let n=0;for(const[s,i]of this.localFiles)i.streamId===e&&(await this.announceFileSource(e,s,t),n++);n>0&&s.V.info(`Re-announced ${n} seed files for channel`)}getStorageStats(){return{usedBytes:this.persistedStorageSize,maxBytes:l.MAX_SEED_STORAGE,usedMB:(this.persistedStorageSize/1024/1024).toFixed(2),maxMB:(l.MAX_SEED_STORAGE/1024/1024).toFixed(0),percentUsed:Math.round(this.persistedStorageSize/l.MAX_SEED_STORAGE*100),fileCount:this.localFiles.size}}async clearAllSeedFiles(){if(!this.db)return;const e=await this.getAllSeedFiles();for(const t of e)await this.removeSeedFile(t.fileId);this.persistedStorageSize=0,s.V.info("Cleared all persisted seed files")}async clearSeedFilesForOwner(e){if(!this.db)return;const t=e?.toLowerCase();if(!t)return;const n=await this.getAllSeedFiles();let i=0;for(const e of n){const n=e.ownerAddress?.toLowerCase();n!==t&&n||(await this.removeSeedFile(e.fileId),i++)}i>0&&s.V.info(`Cleared ${i} seed files for owner: ${t.slice(0,8)}...`)}arrayBufferToBase64(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.byteLength;e++)t+=String.fromCharCode(n[e]);return btoa(t)}base64ToArrayBuffer(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}catch(e){return s.V.error("Base64 decode error:",e),null}}async sha256(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(e=>e.toString(16).padStart(2,"0")).join("")}onImageReceived(e){this.handlers.onImageReceived=e}onFileProgress(e){this.handlers.onFileProgress=e}onFileComplete(e){this.handlers.onFileComplete=e}onSeederUpdate(e){this.handlers.onSeederUpdate=e}getAllowedImageTypes(){return l.ALLOWED_IMAGE_TYPES}getAllowedVideoTypes(){return l.ALLOWED_VIDEO_TYPES}getMaxFileSize(){return l.MAX_FILE_SIZE}isVideoPlayable(e){if(!e)return s.V.warn("isVideoPlayable called with empty mimeType"),!0;const t=e.toLowerCase().trim();if(l.PLAYABLE_VIDEO_TYPES.includes(t))return s.V.debug("Video playable (known type):",t),!0;if(["video/mp4","video/x-m4v","video/m4v","video/mpeg4"].some(e=>t.includes("mp4")||t.includes("m4v")))return s.V.debug("Video playable (MP4 variant):",t),!0;if(t.includes("webm"))return s.V.debug("Video playable (WebM variant):",t),!0;const n=document.createElement("video").canPlayType(t);return s.V.debug("Video playability check:",t,"canPlay:",n),""!==n||(t.includes("quicktime")||t.includes("mov")?(s.V.debug("Video not playable (QuickTime):",t),!1):(s.V.debug("Video playability unknown, defaulting to playable:",t),!0))}getPlayableVideoTypes(){return l.PLAYABLE_VIDEO_TYPES}}},6734(e,t,n){n.d(t,{notificationManager:()=>l});var s=n(6976),i=n(5246),a=n(7040),r=n(4350),o=n(1272);const l=new class{constructor(){this.notificationStream=null,this.pendingInvites=new Map,this.initialized=!1}getStorageKey(){const e=i.s.getAddress();return e?`pombo_notifications_${e.toLowerCase()}`:"pombo_notifications_default"}getStreamId(e){return`${e.toLowerCase()}/pombo_notifications`}isEnabled(){try{const e=localStorage.getItem(this.getStorageKey());if(e)return!0===JSON.parse(e).enabled}catch(e){o.V.warn("Failed to check notification status:",e)}return!1}getSettings(){try{const e=localStorage.getItem(this.getStorageKey());if(e)return JSON.parse(e)}catch(e){}return{enabled:!1,streamId:null}}saveSettings(e){localStorage.setItem(this.getStorageKey(),JSON.stringify(e))}async enable(){const e=i.s.getAddress();if(!e)throw new Error("Not authenticated");const t=this.getStreamId(e);try{o.V.info("Creating notification stream (costs gas):",t);const e=await s.xA.client.createStream({id:t,partitions:1,description:"Pombo notification channel"}),n=window.StreamPermission||{SUBSCRIBE:"subscribe",PUBLISH:"publish"};return await e.grantPermissions({public:!0,permissions:[n.PUBLISH]}),o.V.info("Notification stream created:",t),this.saveSettings({enabled:!0,streamId:t,createdAt:Date.now()}),await this.subscribe(),!0}catch(e){throw o.V.error("Failed to enable notifications:",e),e}}disable(){const e=this.getSettings();e.enabled=!1,this.saveSettings(e),this.notificationStream&&(s.xA.unsubscribe(this.notificationStream).catch(e=>o.V.warn("Unsubscribe error:",e)),this.notificationStream=null),this.initialized=!1,o.V.info("Notifications disabled")}async subscribe(){const e=this.getSettings();if(!e.streamId)throw new Error("No notification stream configured");try{this.notificationStream=e.streamId,await s.xA.subscribeSimple(e.streamId,e=>this.handleNotification(e),null),o.V.info("Subscribed to notifications:",e.streamId)}catch(e){throw o.V.error("Failed to subscribe to notifications:",e),e}}async init(){if(i.s.getAddress())if(this.loadPendingInvites(),this.isEnabled())try{await this.subscribe(),this.initialized=!0,o.V.info("Notification system initialized")}catch(e){o.V.warn("Failed to init notifications:",e)}else o.V.info("Notifications not enabled for this wallet");else o.V.warn("Cannot init notifications: not authenticated")}async sendChannelInvite(e,t){try{const n=i.s.getAddress(),a=this.getStreamId(e),r={type:"CHANNEL_INVITE",inviteId:this.generateInviteId(),timestamp:Date.now(),from:n,to:e,channel:{streamId:t.streamId,name:t.name,type:t.type,password:t.password}};return await s.xA.publish(a,0,r,null),o.V.info("Channel invite sent to:",e),r.inviteId}catch(e){throw o.V.error("Failed to send invite:",e),e}}handleNotification(e){o.V.debug("Notification received:",e),"CHANNEL_INVITE"===e.type&&this.handleChannelInvite(e)}handleChannelInvite(e){this.pendingInvites.set(e.inviteId,e),this.savePendingInvites(),this.showInviteNotification(e)}showInviteNotification(e){const t=document.getElementById("toast-container");if(!t)return void o.V.warn("Toast container not found");const n=document.createElement("div");n.className="toast invite",n.dataset.inviteId=e.inviteId,n.style.setProperty("--toast-duration","15000ms"),n.innerHTML=`\n            <svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>\n            </svg>\n            <div class="toast-content">\n                <div class="text-[13px] font-medium text-white/90 mb-1">Channel Invite</div>\n                <div class="text-[11px] text-white/50 mb-0.5">From: ${this.formatAddress(e.from)}</div>\n                <div class="text-[12px] text-white/80 font-medium">${r.B.escapeHtml(e.channel.name)}</div>\n                <div class="mt-2.5 flex gap-2">\n                    <button class="accept-btn bg-white/90 hover:bg-white text-[#0a0a0a] px-3 py-1 rounded-md text-[11px] font-medium transition">\n                        Accept\n                    </button>\n                    <button class="dismiss-btn bg-white/10 hover:bg-white/20 text-white/70 px-3 py-1 rounded-md text-[11px] font-medium transition">\n                        Dismiss\n                    </button>\n                </div>\n            </div>\n            <span class="toast-close" title="Dismiss">\n                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n            </span>\n            <div class="toast-progress"></div>\n        `,n.querySelector(".accept-btn").addEventListener("click",()=>{this.acceptInvite(e.inviteId),n.classList.add("toast-exit"),setTimeout(()=>n.remove(),250)}),n.querySelector(".dismiss-btn").addEventListener("click",()=>{this.dismissInvite(e.inviteId),n.classList.add("toast-exit"),setTimeout(()=>n.remove(),250)}),n.querySelector(".toast-close")?.addEventListener("click",()=>{this.dismissInvite(e.inviteId),n.classList.add("toast-exit"),setTimeout(()=>n.remove(),250)}),t.appendChild(n),setTimeout(()=>{n.parentElement&&(n.classList.add("toast-exit"),setTimeout(()=>n.remove(),250))},15e3),this.playNotificationSound()}async acceptInvite(e){const t=this.pendingInvites.get(e);if(t)try{await a.L.joinChannel(t.channel.streamId,t.channel.password,{name:t.channel.name,type:t.channel.type}),this.pendingInvites.delete(e),this.savePendingInvites(),o.V.info("Invite accepted:",e),window.uiController&&window.uiController.showNotification(`Joined channel: ${t.channel.name}!`,"success")}catch(e){o.V.error("Failed to accept invite:",e),window.uiController&&window.uiController.showNotification("Failed to join channel: "+e.message,"error")}else o.V.error("Invite not found:",e)}dismissInvite(e){this.pendingInvites.delete(e),this.savePendingInvites(),o.V.info("Invite dismissed:",e)}getPendingInvites(){return Array.from(this.pendingInvites.values())}loadPendingInvites(){try{const e=i.s.getAddress();if(!e)return;const t=`pombo_invites_${e.toLowerCase()}`,n=localStorage.getItem(t);if(n){const e=JSON.parse(n);for(const t of e)this.pendingInvites.set(t.inviteId,t);o.V.info("Loaded pending invites:",e.length)}}catch(e){o.V.error("Failed to load pending invites:",e)}}savePendingInvites(){try{const e=i.s.getAddress();if(!e)return;const t=`pombo_invites_${e.toLowerCase()}`,n=Array.from(this.pendingInvites.values());localStorage.setItem(t,JSON.stringify(n))}catch(e){o.V.error("Failed to save pending invites:",e)}}generateInviteId(){return`invite_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}formatAddress(e){return e?`${e.slice(0,6)}...${e.slice(-4)}`:"Unknown"}playNotificationSound(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.value=800,t.type="sine",n.gain.value=.1,t.start(e.currentTime),t.stop(e.currentTime+.1)}catch(e){o.V.warn("Failed to play notification sound:",e)}}}},6884(e,t,n){n.d(t,{Z:()=>i});var s=n(1272);const i=new class{constructor(){this.storageKey=null,this.address=null,this.isUnlocked=!1,this.cache=null,this.isGuestMode=!1,this.STORAGE_PREFIX="pombo_secure_",this.PBKDF2_ITERATIONS=31e4}async deriveStorageKey(e,t){const n=t.toLowerCase(),i=`Pombo Secure Storage\n\nUnlock encrypted storage for:\n${n}\n\nThis signature is used to derive an encryption key.`;s.V.debug("Deriving storage encryption key...");const a=await e.signMessage(i),r=(new TextEncoder).encode(`pombo_salt_${n}`),o=await crypto.subtle.importKey("raw",(new TextEncoder).encode(a),"PBKDF2",!1,["deriveKey"]),l=await crypto.subtle.deriveKey({name:"PBKDF2",salt:r,iterations:this.PBKDF2_ITERATIONS,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return s.V.debug("Storage key derived successfully"),l}async init(e,t){this.address=t.toLowerCase();try{return this.storageKey=await this.deriveStorageKey(e,t),await this.loadFromStorage(),this.isUnlocked=!0,s.V.info(" Secure storage unlocked for:",this.address.slice(0,8)+"..."),!0}catch(e){throw s.V.error("Failed to initialize secure storage:",e),e}}initAsGuest(e){return this.address=e.toLowerCase(),this.isGuestMode=!0,this.isUnlocked=!0,this.storageKey=null,this.cache={channels:[],trustedContacts:{},ensCache:{},username:null,graphApiKey:null,sessionData:null,channelLastAccess:{},channelOrder:[],lastOpenedChannel:null,version:2},s.V.info(" Guest storage initialized (memory only):",this.address.slice(0,8)+"..."),!0}getStorageKey(){return`${this.STORAGE_PREFIX}${this.address}`}async encrypt(e){if(!this.storageKey)throw new Error("Storage not initialized");const t=crypto.getRandomValues(new Uint8Array(12)),n=(new TextEncoder).encode(JSON.stringify(e)),s=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},this.storageKey,n);return{iv:Array.from(t),ciphertext:Array.from(new Uint8Array(s))}}async decrypt(e){if(!this.storageKey)throw new Error("Storage not initialized");const t=new Uint8Array(e.iv),n=new Uint8Array(e.ciphertext),s=await crypto.subtle.decrypt({name:"AES-GCM",iv:t},this.storageKey,n);return JSON.parse((new TextDecoder).decode(s))}async loadFromStorage(){const e=this.getStorageKey(),t=localStorage.getItem(e);if(!t)return this.cache={channels:[],trustedContacts:{},ensCache:{},username:null,graphApiKey:null,sessionData:null,channelLastAccess:{},channelOrder:[],lastOpenedChannel:null,version:2},void s.V.info(" Initialized empty secure storage");try{const e=JSON.parse(t);this.cache=await this.decrypt(e),s.V.info(" Loaded and decrypted data from storage")}catch(e){s.V.error("Failed to decrypt storage - may be corrupted or from different key"),this.cache={channels:[],trustedContacts:{},ensCache:{},username:null,graphApiKey:null,sessionData:null,channelLastAccess:{},channelOrder:[],lastOpenedChannel:null,version:2}}}async saveToStorage(){if(this.isGuestMode)s.V.debug(" Guest mode - data kept in memory only");else if(this.isUnlocked&&this.cache)try{const e=await this.encrypt(this.cache);localStorage.setItem(this.getStorageKey(),JSON.stringify(e)),s.V.debug(" Saved encrypted data to storage")}catch(e){s.V.error("Failed to save to secure storage:",e)}else s.V.warn("Cannot save - storage not unlocked")}getChannels(){return this.isUnlocked&&this.cache.channels||[]}async setChannels(e){this.isUnlocked&&(this.cache.channels=e,await this.saveToStorage())}getTrustedContacts(){return this.isUnlocked&&this.cache.trustedContacts||{}}async setTrustedContacts(e){this.isUnlocked&&(this.cache.trustedContacts=e,await this.saveToStorage())}getENSCache(){return this.isUnlocked&&this.cache.ensCache||{}}async setENSCache(e){this.isUnlocked&&(this.cache.ensCache=e,await this.saveToStorage())}getUsername(){return this.isUnlocked?this.cache.username:null}async setUsername(e){this.isUnlocked&&(this.cache.username=e,await this.saveToStorage())}getNsfwEnabled(){return this.isUnlocked&&this.cache.nsfwEnabled||!1}async setNsfwEnabled(e){this.isUnlocked&&(this.cache.nsfwEnabled=e,await this.saveToStorage())}getGraphApiKey(){return this.isUnlocked&&this.cache.graphApiKey||null}async setGraphApiKey(e){this.isUnlocked&&(this.cache.graphApiKey=e,await this.saveToStorage())}getSessionData(){return this.isUnlocked?this.cache.sessionData:null}async setSessionData(e){this.isUnlocked&&(this.cache.sessionData=e,await this.saveToStorage())}async clearSessionData(){this.isUnlocked&&(this.cache.sessionData=null,await this.saveToStorage())}getChannelLastAccess(e){return this.isUnlocked&&this.cache.channelLastAccess?.[e]||null}async setChannelLastAccess(e,t=Date.now()){this.isUnlocked&&(this.cache.channelLastAccess||(this.cache.channelLastAccess={}),this.cache.channelLastAccess[e]=t,await this.saveToStorage())}getAllChannelLastAccess(){return this.isUnlocked&&this.cache.channelLastAccess||{}}getChannelOrder(){return this.isUnlocked&&this.cache.channelOrder||[]}async setChannelOrder(e){this.isUnlocked&&(this.cache.channelOrder=e,await this.saveToStorage())}async removeFromChannelOrder(e){this.isUnlocked&&this.cache.channelOrder&&(this.cache.channelOrder=this.cache.channelOrder.filter(t=>t!==e),await this.saveToStorage())}async addToChannelOrder(e){this.isUnlocked&&(this.cache.channelOrder||(this.cache.channelOrder=[]),this.cache.channelOrder.includes(e)||(this.cache.channelOrder.push(e),await this.saveToStorage()))}getLastOpenedChannel(){return this.isUnlocked&&this.cache.lastOpenedChannel||null}async setLastOpenedChannel(e){this.isUnlocked&&(this.cache.lastOpenedChannel=e,await this.saveToStorage())}lock(){this.storageKey=null,this.cache=null,this.isUnlocked=!1,this.address=null,this.isGuestMode=!1,s.V.info(" Secure storage locked")}isStorageUnlocked(){return this.isUnlocked}getCurrentAddress(){return this.address}async deriveKeyFromPassword(e,t){const n=await crypto.subtle.importKey("raw",(new TextEncoder).encode(e),"PBKDF2",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:this.PBKDF2_ITERATIONS,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async exportEncrypted(e){if(!this.isUnlocked||!this.cache)throw new Error("Storage not unlocked");const t=crypto.getRandomValues(new Uint8Array(16)),n=crypto.getRandomValues(new Uint8Array(12)),i=await this.deriveKeyFromPassword(e,t),a={version:2,exportedAt:(new Date).toISOString(),address:this.address,data:{channels:this.cache.channels||[],trustedContacts:this.cache.trustedContacts||{},ensCache:this.cache.ensCache||{},username:this.cache.username,graphApiKey:this.cache.graphApiKey}},r=(new TextEncoder).encode(JSON.stringify(a)),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},i,r);return s.V.info(" Exported encrypted backup"),{format:"pombo-encrypted-backup",version:2,salt:Array.from(t),iv:Array.from(n),ciphertext:Array.from(new Uint8Array(o))}}async importEncrypted(e,t,n=!0){if(!this.isUnlocked)throw new Error("Storage not unlocked");if("pombo-encrypted-backup"!==e.format)throw new Error("Invalid backup format");const i=new Uint8Array(e.salt),a=new Uint8Array(e.iv),r=new Uint8Array(e.ciphertext),o=await this.deriveKeyFromPassword(t,i);let l;try{const e=await crypto.subtle.decrypt({name:"AES-GCM",iv:a},o,r);l=JSON.parse((new TextDecoder).decode(e))}catch(e){throw new Error("Incorrect password or corrupted backup")}const d={channelsImported:0,contactsImported:0,fromAddress:l.address,exportedAt:l.exportedAt},c=l.data;if(c.channels&&c.channels.length>0)if(n){const e=new Set((this.cache.channels||[]).map(e=>e.streamId));for(const t of c.channels)e.has(t.streamId)||(this.cache.channels.push(t),d.channelsImported++)}else this.cache.channels=c.channels,d.channelsImported=c.channels.length;if(c.trustedContacts){const e=Object.keys(c.trustedContacts).length;if(n)for(const[e,t]of Object.entries(c.trustedContacts))this.cache.trustedContacts[e]||(this.cache.trustedContacts[e]=t,d.contactsImported++);else this.cache.trustedContacts=c.trustedContacts,d.contactsImported=e}return c.ensCache&&(this.cache.ensCache={...this.cache.ensCache,...c.ensCache}),c.username&&!this.cache.username&&(this.cache.username=c.username),c.graphApiKey&&!this.cache.graphApiKey&&(this.cache.graphApiKey=c.graphApiKey),await this.saveToStorage(),s.V.info(" Imported encrypted backup:",d),d}getStats(){return this.isUnlocked&&this.cache?{channels:(this.cache.channels||[]).length,contacts:Object.keys(this.cache.trustedContacts||{}).length,ensEntries:Object.keys(this.cache.ensCache||{}).length,hasUsername:!!this.cache.username,hasApiKey:!!this.cache.graphApiKey,version:this.cache.version}:null}async exportAccountBackup(e,t,n=null){if(!this.isUnlocked||!this.cache)throw new Error("Storage not unlocked");const i={version:3,exportedAt:(new Date).toISOString(),address:this.address,data:{channels:this.cache.channels||[],trustedContacts:this.cache.trustedContacts||{},ensCache:this.cache.ensCache||{},username:this.cache.username,graphApiKey:this.cache.graphApiKey}},a=ethers.randomBytes(32),r=ethers.randomBytes(16),o=131072;let l;s.V.debug("Deriving backup encryption key with scrypt..."),l=n?await ethers.scrypt(t,a,o,8,1,32,e=>{n(.5*e)}):await ethers.scrypt(t,a,o,8,1,32);const d=ethers.getBytes(l),c=await crypto.subtle.importKey("raw",d,{name:"AES-GCM"},!1,["encrypt"]);n&&n(.6);const h=(new TextEncoder).encode(JSON.stringify(i)),u=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},c,h);return n&&n(.9),s.V.info(" Account backup created with scrypt encryption"),{format:"pombo-account-backup",version:3,exportedAt:(new Date).toISOString(),keystore:e,encryptedData:{kdf:"scrypt",kdfparams:{n:o,r:8,p:1,dklen:32,salt:ethers.hexlify(a)},cipher:"aes-256-gcm",cipherparams:{iv:ethers.hexlify(r)},ciphertext:ethers.hexlify(new Uint8Array(u))}}}async importAccountBackup(e,t,n=null){if("pombo-account-backup"!==e.format||3!==e.version)throw new Error("Invalid backup format. Expected pombo-account-backup v3");let i;s.V.debug("Decrypting keystore from backup...");try{i=n?await ethers.Wallet.fromEncryptedJson(JSON.stringify(e.keystore),t,e=>n(.4*e)):await ethers.Wallet.fromEncryptedJson(JSON.stringify(e.keystore),t)}catch(e){throw new Error("Incorrect password or corrupted backup")}const a=e.encryptedData,r=ethers.getBytes(a.kdfparams.salt),o=ethers.getBytes(a.cipherparams.iv),l=ethers.getBytes(a.ciphertext);let d;s.V.debug("Deriving data decryption key with scrypt..."),d=n?await ethers.scrypt(t,r,a.kdfparams.n,a.kdfparams.r,a.kdfparams.p,a.kdfparams.dklen,e=>n(.4+.4*e)):await ethers.scrypt(t,r,a.kdfparams.n,a.kdfparams.r,a.kdfparams.p,a.kdfparams.dklen);const c=ethers.getBytes(d),h=await crypto.subtle.importKey("raw",c,{name:"AES-GCM"},!1,["decrypt"]);let u;n&&n(.85);try{const e=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},h,l);u=JSON.parse((new TextDecoder).decode(e))}catch(e){throw new Error("Failed to decrypt backup data")}return n&&n(1),s.V.info(" Account backup decrypted successfully"),{wallet:i,keystore:e.keystore,data:u.data,address:u.address,exportedAt:u.exportedAt}}}},6976(e,t,n){n.d(t,{Oi:()=>a,_k:()=>r,xA:()=>d});var s=n(1272),i=n(3413);const a={NODE_ADDRESS:null,LOGSTORE_NODE:"0x17f98084757a75add72bf6c5b5a6f69008c28a57",STORAGE_PROVIDERS:{STREAMR:{id:"streamr",name:"Streamr Germany",description:"Official Streamr storage with configurable retention",supportsTTL:!0,defaultDays:180,getNodeAddress:()=>a.NODE_ADDRESS},LOGSTORE:{id:"logstore",name:"LogStore",description:"Optimized cache with potential permanent storage",supportsTTL:!1,defaultDays:null,getNodeAddress:()=>a.LOGSTORE_NODE}},DEFAULT_STORAGE_PROVIDER:"streamr",INITIAL_MESSAGES:30,LOAD_MORE_COUNT:30,MESSAGE_STREAM:{SUFFIX:"-1",PARTITIONS:1,MESSAGES:0},EPHEMERAL_STREAM:{SUFFIX:"-2",PARTITIONS:2,CONTROL:0,MEDIA:1}};function r(e){return e?e.replace(/-1$/,"-2"):null}function o(e){return e&&e.endsWith("-1")}function l(e){return e&&e.endsWith("-2")}const d=new class{constructor(){this.client=null,this.subscriptions=new Map,this.channels=new Map,this.address=null}async init(e){try{if(!window.StreamrClient)throw new Error("StreamrClient not found. Make sure the Streamr SDK is loaded.");if(!e.privateKey)throw new Error("Signer must have a privateKey");return this.client=new StreamrClient({auth:{privateKey:e.privateKey},contracts:{ethereumNetwork:{chainId:137,highGasPriceStrategy:!1},rpcs:[{url:"https://rpc.ankr.com/polygon"},{url:"https://polygon.drpc.org"},{url:"https://polygon-bor-rpc.publicnode.com"}],rpcQuorum:1}}),window.STREAMR_STORAGE_NODE_GERMANY?(a.NODE_ADDRESS=window.STREAMR_STORAGE_NODE_GERMANY,s.V.debug("Using Streamr official storage node")):(a.NODE_ADDRESS=a.LOGSTORE_NODE,s.V.debug("Using LogStore storage node (fallback)")),this.address=await this.client.getAddress(),s.V.info("Streamr client initialized with address:",this.address),!0}catch(e){throw s.V.error("Failed to initialize Streamr client:",e),e}}async getAddress(){if(!this.client)throw new Error("Streamr client not initialized");return this.address}sanitizeStreamPath(e){if(!e)return"channel";let t=e.replace(/\s+/g,"-").replace(/[^a-zA-Z0-9_-]/g,"").replace(/-+/g,"-").replace(/^-|-$/g,"");return t||(t="channel"),t.length>50&&(t=t.substring(0,50)),t}async createStream(e,t,n="public",r=[],o={}){if(!this.client)throw new Error("Streamr client not initialized");const l=this.address,d=`${l}/${i.Z.generateRandomHex(8)}`,c=`${d}-1`,h=`${d}-2`;try{s.V.debug("Creating dual-stream channel:",{messageStreamId:c,ephemeralStreamId:h}),s.V.debug("   Owner address:",l),s.V.debug("   Original name:",e),s.V.debug("   Type:",n);const t=o.exposure||"hidden",i=o.readOnly||!1,d=JSON.stringify({a:"pombo",v:"1",n:"hidden"===t?null:e,t:n,e:t,r:i,d:"visible"===t?o.description||"":void 0,l:"visible"===t?o.language||"en":void 0,c:"visible"===t?o.category||"general":void 0,ts:Date.now()}),u=JSON.stringify({a:"pombo",v:"1",ln:c}),m=async(e,t,n,i,a=7)=>{for(let n=1;n<=a;n++)try{s.V.info(`Creating stream (attempt ${n}/${a})...`);const r=await this.client.createStream({id:e,description:t,partitions:i});return s.V.info(` Stream created: ${r.id}`),r}catch(t){s.V.warn(`Stream creation attempt ${n} failed:`,t.message);try{const t=await this.client.getStream(e);if(t)return s.V.info(` Stream exists (created despite error): ${t.id}`),t}catch(e){}if(!(n<a))throw t;{const e=3e3*n;s.V.info(`Retrying in ${e/1e3}s...`),await new Promise(t=>setTimeout(t,e))}}};s.V.info("Creating message stream...");const p=Date.now(),g=await m(c,d,"message",a.MESSAGE_STREAM.PARTITIONS);s.V.info("Creating ephemeral stream...");const w=await m(h,u,"ephemeral",a.EPHEMERAL_STREAM.PARTITIONS),v=((Date.now()-p)/1e3).toFixed(1);s.V.info(` Both streams created in ${v}s`),s.V.info("Setting permissions on both streams...");const y=Date.now();if("public"===n||"password"===n){const e=i?e=>this.grantPublicReadOnlyPermissions(e):e=>this.grantPublicPermissions(e);try{await e(g),s.V.info(" Message stream: public permissions set")}catch(e){s.V.error(" Message stream permissions failed:",e.message)}try{await e(w),s.V.info(" Ephemeral stream: public permissions set")}catch(e){s.V.error(" Ephemeral stream permissions failed:",e.message)}const t=((Date.now()-y)/1e3).toFixed(1);s.V.info(`Permissions configured in ${t}s`)}else if("native"===n){try{await this.setStreamPermissions(g.id,{public:!1,members:r}),s.V.info(" Message stream: permissions set")}catch(e){s.V.error(" Message stream permissions failed:",e.message)}try{await this.setStreamPermissions(w.id,{public:!1,members:r}),s.V.info(" Ephemeral stream: permissions set")}catch(e){s.V.error(" Ephemeral stream permissions failed:",e.message)}const e=((Date.now()-y)/1e3).toFixed(1);s.V.info(`Permissions configured in ${e}s`)}const f=((Date.now()-p)/1e3).toFixed(1);return s.V.info(` Channel creation complete in ${f}s total`),{messageStreamId:g.id,ephemeralStreamId:w.id,type:n,name:e}}catch(t){s.V.warn("Create stream error:",t.message);try{let t=null,i=null;try{t=await this.client.getStream(c),s.V.debug("Message stream exists")}catch(e){s.V.debug("Message stream does not exist")}try{i=await this.client.getStream(h),s.V.debug("Ephemeral stream exists")}catch(e){s.V.debug("Ephemeral stream does not exist")}if(t){s.V.info("Configuring permissions on existing stream(s)...");const o=readOnly?e=>this.grantPublicReadOnlyPermissions(e):e=>this.grantPublicPermissions(e);if("public"===n||"password"===n?(await o(t).catch(e=>s.V.warn("Message perm error:",e.message)),i&&await o(i).catch(e=>s.V.warn("Ephemeral perm error:",e.message))):"native"===n&&(await this.setStreamPermissions(c,{public:!1,members:r}).catch(e=>s.V.warn("Perm error:",e.message)),i&&await this.setStreamPermissions(h,{public:!1,members:r}).catch(e=>s.V.warn("Perm error:",e.message))),i)return s.V.info("Both streams exist with permissions configured"),{messageStreamId:t.id,ephemeralStreamId:i.id,type:n,name:e};s.V.info("Attempting to create missing ephemeral stream...");try{const i=await this.client.createStream({id:h,description:ephemeralMetadata,partitions:a.EPHEMERAL_STREAM.PARTITIONS});return"public"===n||"password"===n?await o(i).catch(e=>s.V.warn("Ephemeral perm error:",e.message)):"native"===n&&await this.setStreamPermissions(h,{public:!1,members:r}).catch(e=>s.V.warn("Perm error:",e.message)),s.V.info(" Ephemeral stream created successfully on retry"),{messageStreamId:t.id,ephemeralStreamId:i.id,type:n,name:e}}catch(i){return s.V.warn("Failed to create ephemeral stream on retry:",i.message),s.V.warn("Channel created in degraded mode (no ephemeral stream)"),{messageStreamId:t.id,ephemeralStreamId:null,type:n,name:e}}}}catch(e){s.V.debug("Recovery attempt failed:",e.message)}throw s.V.error("Failed to create streams:",t),t}}async setStreamPermissions(e,t={},n=7){if(!this.client)throw new Error("Streamr client not initialized");const i=[];if(t.public&&i.push({public:!0,permissions:["subscribe","publish"]}),t.members&&t.members.length>0){s.V.debug("Granting permissions to",t.members.length,"members...");for(const e of t.members){const t=e.toLowerCase();s.V.debug("Granting permissions to member:",t),i.push({userId:t,permissions:["subscribe","publish"]})}s.V.debug("All member permissions granted")}if(0!==i.length)for(let t=1;t<=n;t++)try{return s.V.debug(`Setting permissions (attempt ${t}/${n})...`),await this.client.setPermissions({streamId:e,assignments:i}),void s.V.debug("Permissions set successfully (batch)")}catch(i){if(s.V.warn(`Permission attempt ${t} failed:`,i.message),!(t<n))throw s.V.error("All permission attempts failed for:",e),i;{const e=3e3*t;s.V.debug(`Retrying in ${e/1e3}s...`),await new Promise(t=>setTimeout(t,e))}}else s.V.debug("No permissions to set (owner-only)")}async grantPublicPermissions(e,t=7){const n="string"==typeof e?e:e.id;for(let e=1;e<=t;e++)try{return s.V.debug(`Granting public permissions (attempt ${e}/${t})...`),await this.client.setPermissions({streamId:n,assignments:[{public:!0,permissions:["subscribe","publish"]}]}),void s.V.debug("Public permissions granted successfully")}catch(i){if(s.V.warn(`Permission attempt ${e} failed:`,i.message),!(e<t))throw s.V.error("All permission attempts failed for:",n),i;{const t=3e3*e;s.V.debug(`Retrying in ${t/1e3}s...`),await new Promise(e=>setTimeout(e,t))}}}async grantPublicReadOnlyPermissions(e,t=7){const n="string"==typeof e?e:e.id;for(let e=1;e<=t;e++)try{return s.V.debug(`Granting public read-only permissions (attempt ${e}/${t})...`),await this.client.setPermissions({streamId:n,assignments:[{public:!0,permissions:["subscribe"]}]}),void s.V.debug("Public read-only permissions granted successfully")}catch(i){if(s.V.warn(`Read-only permission attempt ${e} failed:`,i.message),!(e<t))throw s.V.error("All read-only permission attempts failed for:",n),i;{const t=3e3*e;s.V.debug(`Retrying in ${t/1e3}s...`),await new Promise(e=>setTimeout(e,t))}}}async grantPermissionsToAddresses(e,t,n=7){if(!this.client)throw new Error("Streamr client not initialized");if(!t||0===t.length)return void s.V.debug("No addresses to grant permissions to");const i=[];for(const e of t){const t=e.toLowerCase();i.push({userId:t,permissions:["subscribe","publish"]})}for(let a=1;a<=n;a++)try{return s.V.debug(`Granting permissions to addresses (attempt ${a}/${n}):`,t),await this.client.setPermissions({streamId:e,assignments:i}),void s.V.info("All permissions granted to addresses:",t)}catch(t){if(s.V.warn(`Grant permissions attempt ${a} failed:`,t.message),!(a<n))throw s.V.error("All grant permission attempts failed for:",e),t;{const e=3e3*a;s.V.debug(`Retrying in ${e/1e3}s...`),await new Promise(t=>setTimeout(t,e))}}}async revokePermissionsFromAddresses(e,t,n=7){if(!this.client)throw new Error("Streamr client not initialized");if(!t||0===t.length)return void s.V.debug("No addresses to revoke permissions from");const i=[];for(const e of t){const t=e.toLowerCase();i.push({userId:t,permissions:[]})}for(let a=1;a<=n;a++)try{return s.V.debug(`Revoking permissions from addresses (attempt ${a}/${n}):`,t),await this.client.setPermissions({streamId:e,assignments:i}),void s.V.debug("Permissions revoked from addresses:",t)}catch(t){if(s.V.warn(`Revoke permissions attempt ${a} failed:`,t.message),!(a<n))throw s.V.error("All revoke permission attempts failed for:",e),t;{const e=3e3*a;s.V.debug(`Retrying in ${e/1e3}s...`),await new Promise(t=>setTimeout(t,e))}}}async updatePermissions(e,t,n,i=7){if(!this.client)throw new Error("Streamr client not initialized");if(!t||"string"!=typeof t||!t.match(/^0x[a-fA-F0-9]{40}$/))throw new Error("Invalid Ethereum address: "+t);const a=t.toLowerCase();s.V.debug("Updating permissions for:",a,"canGrant:",n.canGrant);const r=n.canGrant?["subscribe","publish","grant"]:["subscribe","publish"];for(let t=1;t<=i;t++)try{return s.V.debug(`Updating permissions (attempt ${t}/${i})...`),await this.client.setPermissions({streamId:e,assignments:[{userId:a,permissions:r}]}),void s.V.debug(`Permissions updated for ${a}`)}catch(n){if(s.V.warn(`Update permissions attempt ${t} failed:`,n.message),!(t<i))throw s.V.error("All update permission attempts failed for:",e),n;{const e=3e3*t;s.V.debug(`Retrying in ${e/1e3}s...`),await new Promise(t=>setTimeout(t,e))}}}async getStreamPermissions(e){if(!this.client)throw new Error("Streamr client not initialized");try{const t=await this.client.getStream(e),n=[];if("function"==typeof t.getPermissions){const e=t.getPermissions();if(e&&"function"==typeof e[Symbol.asyncIterator])for await(const t of e)n.push(t);else if(e&&"function"==typeof e.then){const t=await e;if(Array.isArray(t))return t}else if(Array.isArray(e))return e}return 0===n.length?(s.V.debug("getPermissions not available, using fallback"),[]):n}catch(e){throw s.V.error("Failed to get stream permissions:",e),e}}async hasDeletePermission(e){if(!this.client)return!1;try{const t=await this.client.getStream(e),n=window.StreamPermission;if(!n){s.V.warn("StreamPermission not available, falling back to streamId check");const t=await this.client.getAddress();if(t){const n=e.split("/")[0]?.toLowerCase();return n===t.toLowerCase()}return!1}const i=await this.client.getAddress();if(!i)return!1;const a=await t.hasPermission({permission:n.DELETE,userId:i,allowPublic:!1});return s.V.debug("hasDeletePermission check:",{streamId:e,currentAddress:i.slice(0,10),hasDelete:a}),a}catch(e){return s.V.error("Failed to check DELETE permission:",e),!1}}async hasPublishPermission(e,t=!0){if(!this.client)return!1;try{const n=await this.client.getStream(e),i=window.StreamPermission;if(!i)return s.V.warn("StreamPermission not available"),!1;const a=await this.client.getAddress();if(!a)return!1;const r=await n.hasPermission({permission:i.PUBLISH,userId:a,allowPublic:t});return s.V.debug("hasPublishPermission check:",{streamId:e,currentAddress:a.slice(0,10),hasPublish:r,allowPublic:t}),r}catch(e){return s.V.error("Failed to check PUBLISH permission:",e),!1}}async hasSubscribePermission(e,t=!0){if(!this.client)return!1;try{const n=await this.client.getStream(e),i=window.StreamPermission;if(!i)return s.V.warn("StreamPermission not available"),!1;const a=await this.client.getAddress();if(!a)return!1;const r=await n.hasPermission({permission:i.SUBSCRIBE,userId:a,allowPublic:t});return s.V.debug("hasSubscribePermission check:",{streamId:e,currentAddress:a.slice(0,10),hasSubscribe:r,allowPublic:t}),r}catch(e){return s.V.error("Failed to check SUBSCRIBE permission:",e),!1}}async checkPermissions(e){if(!this.client)return{canPublish:!1,canSubscribe:!1,canGrant:!1,canEdit:!1,canDelete:!1,isOwner:!1};try{const t=await this.client.getStream(e),n=window.StreamPermission,i=await this.client.getAddress();if(!n||!i)return s.V.warn("StreamPermission or address not available"),{canPublish:!1,canSubscribe:!1,canGrant:!1,canEdit:!1,canDelete:!1,isOwner:!1};const[a,r,o,l,d]=await Promise.all([t.hasPermission({permission:n.PUBLISH,userId:i,allowPublic:!0}),t.hasPermission({permission:n.SUBSCRIBE,userId:i,allowPublic:!0}),t.hasPermission({permission:n.GRANT,userId:i,allowPublic:!1}),t.hasPermission({permission:n.EDIT,userId:i,allowPublic:!1}),t.hasPermission({permission:n.DELETE,userId:i,allowPublic:!1})]),c=o&&l&&d;return s.V.debug("checkPermissions result:",{streamId:e,currentAddress:i.slice(0,10),canPublish:a,canSubscribe:r,canGrant:o,canEdit:l,canDelete:d,isOwner:c}),{canPublish:a,canSubscribe:r,canGrant:o,canEdit:l,canDelete:d,isOwner:c}}catch(e){return s.V.error("Failed to check permissions:",e),{canPublish:!1,canSubscribe:!1,canGrant:!1,canEdit:!1,canDelete:!1,isOwner:!1}}}async deleteStream(e,t=7){if(!this.client)throw new Error("Streamr client not initialized");let n,i;if(o(e))n=e,i=r(e);else{if(!l(e))throw new Error("Invalid stream ID format - must end with -1 or -2");i=e,n=function(e){return e?e.replace(/-2$/,"-1"):null}(e)}const a=async(e,n)=>{for(let i=1;i<=t;i++)try{return s.V.debug(`Deleting ${n} (attempt ${i}/${t})...`),await this.client.deleteStream(e),s.V.info(` ${n} deleted:`,e),{success:!0}}catch(a){if(s.V.warn(`Delete ${n} attempt ${i} failed:`,a.message),!(i<t))return s.V.error(`All delete attempts failed for ${n}:`,e),{success:!1,error:a};{const e=3e3*i;s.V.debug(`Retrying in ${e/1e3}s...`),await new Promise(t=>setTimeout(t,e))}}};try{s.V.info("Deleting channel streams...",{messageStreamId:n,ephemeralStreamId:i}),await this.unsubscribeFromDualStream(n).catch(e=>s.V.warn("Unsubscribe warning:",e.message));const e=await a(n,"message stream");if(i&&await a(i,"ephemeral stream"),!e.success)throw e.error}catch(e){throw s.V.error("Failed to delete streams:",e),e}}async subscribeSimple(e,t,n=null){if(!this.client)throw new Error("Streamr client not initialized");return await this.subscribeToPartition(e,0,t,n)}async publish(e,t,n,a=null){if(!this.client)throw new Error("Streamr client not initialized");try{let r=n;a&&(r=await i.Z.encryptJSON(n,a)),await this.client.publish({streamId:e,partition:t},r),s.V.debug(`Published to ${e} partition ${t}`)}catch(e){throw s.V.error("Failed to publish:",e),e}}async publishMessage(e,t,n=null){return s.V.debug("publishMessage called - sending to messageStream partition 0:",{messageStreamId:e,messageId:t?.id}),await this.publish(e,a.MESSAGE_STREAM.MESSAGES,t,n)}async publishControl(e,t,n=null){return await this.publish(e,a.EPHEMERAL_STREAM.CONTROL,t,n)}async publishReaction(e,t,n=null){return s.V.debug("publishReaction called - sending to messageStream partition 0:",{messageStreamId:e,messageId:t?.messageId}),await this.publish(e,a.MESSAGE_STREAM.MESSAGES,t,n)}async publishMedia(e,t,n=null){return await this.publish(e,a.EPHEMERAL_STREAM.MEDIA,t,n)}async unsubscribe(e){const t=this.subscriptions.get(e);if(t){for(const e in t)await t[e].unsubscribe();this.subscriptions.delete(e),s.V.debug("Unsubscribed from stream:",e)}}async subscribeToPartition(e,t,n,a=null){if(!this.client)throw new Error("Streamr client not initialized");let r=this.subscriptions.get(e);return r||(r={},this.subscriptions.set(e,r)),r[t]?(s.V.debug(`Already subscribed to ${e} partition ${t}`),r[t]):(r[t]=await this.client.subscribe({streamId:e,partition:t},async(e,r)=>{try{let t=e;if(a&&"string"==typeof e&&(t=await i.Z.decryptJSON(e,a)),r&&"object"==typeof t){const e="function"==typeof r.getPublisherId?r.getPublisherId():r.publisherId;e&&(t.senderId=e)}n(t)}catch(e){s.V.error(`Failed to process partition ${t} message:`,e)}}),s.V.debug(`Subscribed to ${e} partition ${t}`),r[t])}async unsubscribeFromPartition(e,t){const n=this.subscriptions.get(e);if(n&&n[t])try{await n[t].unsubscribe(),delete n[t],s.V.debug(`Unsubscribed from ${e} partition ${t}`),0===Object.keys(n).length&&this.subscriptions.delete(e)}catch(e){s.V.warn(`Failed to unsubscribe from partition ${t}:`,e)}}isSubscribedToPartition(e,t){const n=this.subscriptions.get(e);return n&&void 0!==n[t]}async ensureMediaSubscription(e,t,n=null){const s=a.EPHEMERAL_STREAM.MEDIA;if(!this.isSubscribedToPartition(e,s))return this.subscribeToPartition(e,s,t,n)}async disconnect(){if(this.client){for(const e of this.subscriptions.keys())await this.unsubscribe(e);await this.client.destroy(),this.client=null,s.V.info("Streamr client disconnected")}this.address=null}async enableStorage(e,t={},n=7){if(!this.client)throw new Error("Client not initialized");if(!o(e))return s.V.warn("enableStorage called on non-message stream, ignoring:",e),{success:!1,provider:null,storageDays:null};const i=t.storageProvider||a.DEFAULT_STORAGE_PROVIDER,r="logstore"===i?a.STORAGE_PROVIDERS.LOGSTORE:a.STORAGE_PROVIDERS.STREAMR,l=r.getNodeAddress()||a.LOGSTORE_NODE,d=r.supportsTTL?t.storageDays||r.defaultDays:null;s.V.debug("Enabling storage:",{streamId:e,provider:i,nodeAddress:l.slice(0,12)+"...",storageDays:d});for(let t=1;t<=n;t++)try{s.V.debug(`Adding to storage node (attempt ${t}/${n})...`);const a=await this.client.getStream(e);if(await a.addToStorageNode(l),d&&r.supportsTTL)try{await a.setStorageDayCount(d),s.V.debug("Storage days set to:",d)}catch(e){s.V.warn("Could not set storage days (continuing):",e.message)}return s.V.info("Storage enabled:",{stream:e,provider:i,days:d}),{success:!0,provider:i,storageDays:d,nodeAddress:l}}catch(a){if(s.V.warn(`Storage attempt ${t} failed:`,a.message),!(t<n))return s.V.error("All storage attempts failed for:",e),{success:!1,provider:i,storageDays:null};{const e=3e3*t;s.V.debug(`Retrying in ${e/1e3}s...`),await new Promise(t=>setTimeout(t,e))}}return{success:!1,provider:i,storageDays:null}}async setStorageDays(e,t){if(!this.client)throw new Error("Client not initialized");try{const n=await this.client.getStream(e);return await n.setStorageDayCount(t),s.V.info("Storage days updated:",{streamId:e,days:t}),!0}catch(e){return s.V.error("Failed to set storage days:",e.message),!1}}async getStorageDays(e){if(!this.client)throw new Error("Client not initialized");try{const t=await this.client.getStream(e);return await t.getStorageDayCount()}catch(e){return s.V.warn("Failed to get storage days:",e.message),null}}async fetchHistory(e,t=0,n=a.INITIAL_MESSAGES){if(!this.client)throw new Error("Client not initialized");const i=[];try{const a=await this.client.resend(e,{last:n,partition:t});for await(const e of a)i.push(e.content);return s.V.debug(`Fetched ${i.length} messages from partition ${t}`),i}catch(e){return s.V.warn("History fetch error:",e.message),i}}async fetchOlderHistory(e,t=0,n,r=a.LOAD_MORE_COUNT,o=null){if(!this.client)throw new Error("Client not initialized");const l=["presence","typing"],d=e=>"text"===e?.type||!(!(e?.id&&e?.text&&e?.sender&&e?.timestamp)||e?.type)||"reaction"===e?.type||!("image"!==e?.type||!e?.imageId)||!("video_announce"!==e?.type||!e?.metadata);try{s.V.debug(`Fetching ${r} older messages before ${new Date(n).toISOString()}`);const a=await this.client.resend(e,{partition:t,from:{timestamp:0},to:{timestamp:n-1}}),c=[];for await(const e of a)try{let n=e.content||e;if(o&&"string"==typeof n)try{n=await i.Z.decryptJSON(n,o)}catch(e){continue}if(n?.type&&l.includes(n.type))continue;if(0===t&&!d(n))continue;c.push(n)}catch(e){s.V.warn("Error processing historical message:",e.message)}const h=Math.max(0,c.length-r),u=c.slice(h),m=c.length>r;return s.V.info(`Loaded ${u.length} older messages (hasMore: ${m})`),{messages:u,hasMore:m}}catch(e){return s.V.warn("Older history fetch error:",e.message),{messages:[],hasMore:!1}}}async subscribeWithHistory(e,t,n,r=a.INITIAL_MESSAGES,o=null){if(!this.client)throw new Error("Client not initialized");const l=await this.client.subscribe({streamId:e,partition:t},async(e,t)=>{try{let s=e;if(o&&"string"==typeof e&&(s=await i.Z.decryptJSON(e,o)),t&&"object"==typeof s){const e="function"==typeof t.getPublisherId?t.getPublisherId():t.publisherId;e&&(s.senderId=e)}n(s)}catch(e){s.V.error("Failed to process message:",e)}});return s.V.debug("Subscribed to",e,"partition",t),r>0&&this.fetchHistoryAsync(e,t,r,n,o),l}async fetchHistoryAsync(e,t,n,a,r=null){try{s.V.debug(`Fetching ${n} historical messages for partition ${t}${r?" (encrypted)":""}...`);const o=await this.client.resend(e,{last:n,partition:t});s.V.debug(`Resend object received for partition ${t}:`,typeof o);let l=0,d=0,c=0;const h=["presence","typing"],u=e=>"text"===e?.type||"message"===e?.type||!(!(e?.id&&e?.text&&e?.sender&&e?.timestamp)||e?.type),m=e=>"reaction"===e?.type,p=e=>"image"===e?.type&&e?.imageId,g=e=>"video_announce"===e?.type&&e?.metadata,w=e=>u(e)||m(e)||p(e)||g(e);for await(const e of o){c++;try{let n=e.content||e;if(r&&"string"==typeof n)try{n=await i.Z.decryptJSON(n,r)}catch(e){c<=3&&s.V.debug(`Failed to decrypt message ${c}:`,e.message),d++;continue}if(c<=3&&s.V.debug(`History message ${c} from partition ${t}:`,JSON.stringify(n).slice(0,200)),n?.type&&h.includes(n.type)){d++;continue}if(0===t&&!w(n)){d++;continue}a(n),l++}catch(e){s.V.warn("Error processing historical message:",e.message)}}l>0?s.V.info(`Loaded ${l} historical messages for partition ${t}`+(d>0?` (skipped ${d} ephemeral)`:"")):s.V.debug(`No historical messages for partition ${t}`+(d>0?` (skipped ${d} ephemeral)`:"")+` (raw received: ${c})`)}catch(e){s.V.warn(`History fetch failed for partition ${t} (may be CORS on localhost):`,e.message)}}async subscribeToDualStream(e,t,n,i=null,r=a.INITIAL_MESSAGES){if(!this.client)throw new Error("Streamr client not initialized");o(e)||s.V.warn("Invalid messageStreamId (should end with -1):",e),l(t)||s.V.warn("Invalid ephemeralStreamId (should end with -2):",t);try{if(!this.subscriptions.has(e)){const t={};n.onMessage&&(s.V.debug("Subscribing to messageStream partition 0 (messages) with history"),t[a.MESSAGE_STREAM.MESSAGES]=await this.subscribeWithHistory(e,a.MESSAGE_STREAM.MESSAGES,n.onMessage,r,i)),this.subscriptions.set(e,t),s.V.info("Subscribed to message stream:",e)}if(!this.subscriptions.has(t)){const e={};n.onControl&&(s.V.debug("Subscribing to ephemeralStream partition 0 (control) - no history"),e[a.EPHEMERAL_STREAM.CONTROL]=await this.subscribeWithHistory(t,a.EPHEMERAL_STREAM.CONTROL,n.onControl,0,i)),n.onMedia&&(s.V.debug("Subscribing to ephemeralStream partition 1 (media) - no history"),e[a.EPHEMERAL_STREAM.MEDIA]=await this.subscribeWithHistory(t,a.EPHEMERAL_STREAM.MEDIA,n.onMedia,0,i)),this.subscriptions.set(t,e),s.V.info("Subscribed to ephemeral stream:",t)}return!0}catch(e){throw s.V.error("Failed to subscribe to dual-stream:",e),e}}async unsubscribeFromDualStream(e,t){await Promise.allSettled([this.unsubscribe(e),this.unsubscribe(t)]),s.V.debug("Unsubscribed from dual-stream:",e)}}},302(e,t,n){n.d(t,{D:()=>c});var s=n(6976),i=n(7040),a=n(6884),r=n(5246),o=n(1350),l=n(9110),d=n(1272);const c=new class{constructor(){this.activeChannelId=null,this.previewChannelId=null,this.previewPresenceInterval=null,this.backgroundPoller=null,this.channelActivity=new Map,this.activityHandlers=[],this.config={POLL_INTERVAL:3e4,POLL_BATCH_SIZE:3,POLL_STAGGER_DELAY:2e3,MIN_POLL_INTERVAL:1e4,MAX_CONCURRENT_SUBS:1,ACTIVITY_CHECK_MESSAGES:3},this.pollIndex=0,this.isPolling=!1}async setActiveChannel(e,t=null){if(e)if(this.activeChannelId!==e){d.V.info("Setting active channel:",e),this.activeChannelId&&await this.downgradeToBackground(this.activeChannelId),this.activeChannelId=e;try{await i.L.subscribeToChannel(e,t),d.V.info("Active channel subscription complete:",e)}catch(e){throw d.V.error("Failed to subscribe to active channel:",e),e}}else d.V.debug("Channel already active:",e);else d.V.warn("setActiveChannel called with null streamId")}async downgradeToBackground(e){if(e)try{const t=i.L.getChannel(e);if(t&&t.messages?.length>0){const n=t.messages[t.messages.length-1];this.channelActivity.set(e,{lastMessageTime:n.timestamp||Date.now(),unreadCount:0,lastChecked:Date.now()})}const n=t?.ephemeralStreamId||(0,s._k)(e);await s.xA.unsubscribeFromDualStream(e,n),d.V.debug("Downgraded to background:",e)}catch(t){d.V.warn("Failed to downgrade channel:",e,t.message)}}async clearActiveChannel(){this.activeChannelId&&(await this.downgradeToBackground(this.activeChannelId),this.activeChannelId=null)}async setPreviewChannel(e){if(e)if(this.previewChannelId!==e){d.V.info("Setting preview channel:",e),this.previewChannelId&&await this.clearPreviewChannel(),this.activeChannelId&&(await this.downgradeToBackground(this.activeChannelId),this.activeChannelId=null),this.previewChannelId=e;try{const t=(0,s._k)(e);await s.xA.subscribeToDualStream(e,t,{onMessage:e=>this._handlePreviewMessage(e),onControl:e=>this._handlePreviewEphemeral(e),onMedia:t=>this._handlePreviewMedia(e,t)},null,s.Oi.INITIAL_MESSAGES),d.V.info("Preview subscription active:",e),this._startPreviewPresence(e,t)}catch(e){throw d.V.error("Failed to subscribe to preview channel:",e),this.previewChannelId=null,e}}else d.V.debug("Already previewing this channel:",e);else d.V.warn("setPreviewChannel called with null streamId")}_handlePreviewMessage(e){const t=this.previewChannelId||this.activeChannelId;t&&i.L.getChannel(t)?i.L.handleTextMessage(t,e):(d.V.debug("Preview message callback:",e?.id,e?.type||"text"),window.uiController&&window.uiController.handlePreviewMessage?window.uiController.handlePreviewMessage(e):d.V.warn("uiController.handlePreviewMessage not available"))}_handlePreviewEphemeral(e){const t=this.previewChannelId||this.activeChannelId;t&&(d.V.debug("Preview ephemeral:",e.type),"presence"===e.type?i.L.handlePresenceMessage(t,e):"typing"===e.type&&i.L.notifyHandlers("typing",{streamId:t,user:e.user}))}_handlePreviewMedia(e,t){t?.type&&(d.V.debug("Preview media:",t.type),l.F.handleMediaMessage(e,t))}_startPreviewPresence(e,t){this._stopPreviewPresence();const n=async()=>{if(this.previewChannelId!==e)return;const n=r.s.getAddress(),i={type:"presence",userId:n,address:n,nickname:o.E?.getUsername?.()||null,lastActive:Date.now()};try{await s.xA.publishControl(t,i)}catch(e){d.V.warn("Failed to publish preview presence:",e.message)}};n(),this.previewPresenceInterval=setInterval(n,2e4)}_stopPreviewPresence(){this.previewPresenceInterval&&(clearInterval(this.previewPresenceInterval),this.previewPresenceInterval=null)}async clearPreviewChannel(){if(!this.previewChannelId)return;const e=this.previewChannelId;d.V.info("Clearing preview channel:",e),this._stopPreviewPresence();try{const t=(0,s._k)(e);await s.xA.unsubscribeFromDualStream(e,t)}catch(e){d.V.warn("Error unsubscribing from preview:",e.message)}this.previewChannelId=null}async promotePreviewToActive(e){this.previewChannelId===e?(d.V.info("Promoting preview to active (keeping subscription):",e),this._stopPreviewPresence(),this.activeChannelId=e,this.previewChannelId=null,d.V.debug("Preview promoted - subscription reused, handlers auto-forward")):d.V.warn("Cannot promote - not the current preview channel")}isInPreviewMode(){return null!==this.previewChannelId}getPreviewChannelId(){return this.previewChannelId}startBackgroundPoller(){this.backgroundPoller?d.V.debug("Background poller already running"):(d.V.info("Starting background activity poller"),this.initializeActivityState(),this.backgroundPoller=setInterval(async()=>{await this.pollBackgroundChannels()},this.config.POLL_INTERVAL),setTimeout(()=>this.pollBackgroundChannels(),5e3))}initializeActivityState(){const e=i.L.getAllChannels(),t=a.Z.getAllChannelLastAccess();for(const n of e){const e=n.messageStreamId||n.streamId;if(!this.channelActivity.has(e)){const s=t[e]||t[n.streamId]||0;this.channelActivity.set(e,{lastMessageTime:s,unreadCount:0,lastChecked:0})}}}async pollBackgroundChannels(){if(this.isPolling)d.V.debug("Poll already in progress, skipping");else{this.isPolling=!0;try{const e=i.L.getAllChannels().filter(e=>(e.messageStreamId||e.streamId)!==this.activeChannelId);if(0===e.length)return void d.V.debug("No background channels to poll");const t=Math.min(this.config.POLL_BATCH_SIZE,e.length),n=[];for(let s=0;s<t;s++){const t=(this.pollIndex+s)%e.length;n.push(e[t])}this.pollIndex=(this.pollIndex+t)%e.length;for(let e=0;e<n.length;e++){const t=n[e],s=t.messageStreamId||t.streamId,i=this.channelActivity.get(s);if(!(Date.now()-(i?.lastChecked||0)<this.config.MIN_POLL_INTERVAL)){try{await this.checkChannelActivity(t)}catch(e){d.V.debug("Activity check failed for:",s,e.message)}e<n.length-1&&await new Promise(e=>setTimeout(e,this.config.POLL_STAGGER_DELAY))}}}finally{this.isPolling=!1}}}async checkChannelActivity(e){const t=e.messageStreamId||e.streamId,n=e.password||null,i=this.channelActivity.get(t)||{lastMessageTime:0,unreadCount:0,lastChecked:0};try{const e=(await s.xA.fetchOlderHistory(t,s.Oi.MESSAGE_STREAM.MESSAGES,Date.now(),this.config.ACTIVITY_CHECK_MESSAGES,n)).messages||[];let a=0,r=i.lastMessageTime;for(const t of e)t.timestamp>i.lastMessageTime&&(a++,t.timestamp>r&&(r=t.timestamp));const o={lastMessageTime:r,unreadCount:i.unreadCount+a,lastChecked:Date.now()};this.channelActivity.set(t,o),a>0&&(d.V.debug("New activity detected:",t,a,"messages"),this.notifyActivityHandlers(t,o))}catch(e){throw i.lastChecked=Date.now(),this.channelActivity.set(t,i),e}}onActivity(e){"function"==typeof e&&this.activityHandlers.push(e)}offActivity(e){this.activityHandlers=this.activityHandlers.filter(t=>t!==e)}notifyActivityHandlers(e,t){for(const n of this.activityHandlers)try{n(e,t)}catch(e){d.V.warn("Activity handler error:",e)}}getChannelActivity(e){return this.channelActivity.get(e)||null}getUnreadCount(e){const t=this.channelActivity.get(e);return t?.unreadCount||0}clearUnreadCount(e){const t=this.channelActivity.get(e);t&&(t.unreadCount=0,this.channelActivity.set(e,t))}async removeChannel(e){d.V.debug("Removing channel from subscription manager:",e),this.channelActivity.delete(e),this.activeChannelId===e&&(this.activeChannelId=null),a.Z.getLastOpenedChannel()===e&&await a.Z.setLastOpenedChannel(null)}stopBackgroundPoller(){this.backgroundPoller&&(clearInterval(this.backgroundPoller),this.backgroundPoller=null,d.V.debug("Background poller stopped"))}async cleanup(){d.V.info("Subscription manager cleanup"),this.stopBackgroundPoller(),this.previewChannelId&&await this.clearPreviewChannel(),this.activeChannelId=null,this.channelActivity.clear(),this.pollIndex=0,this.isPolling=!1,this.activityHandlers=[]}isActiveChannel(e){return this.activeChannelId===e}getActiveChannelId(){return this.activeChannelId}async forcePollChannel(e){const t=i.L.getChannel(e);if(t&&e!==this.activeChannelId)try{await this.checkChannelActivity(t)}catch(t){d.V.debug("Force poll failed:",e,t.message)}}updateConfig(e){this.config={...this.config,...e},d.V.debug("Subscription manager config updated:",this.config)}}},4350(e,t,n){n.d(t,{B:()=>O});var s=n(7040),i=n(5246),a=n(1350),r=n(6734),o=n(7482),l=n(6884),d=n(1272),c=n(9110),h=n(6976),u=n(302);const m=new class{constructor(){this.isNavigating=!1,this.initialized=!1,this.onNavigate=null,this._handlePopState=this._handlePopState.bind(this)}init(e){this.initialized||(this.onNavigate=e,window.addEventListener("popstate",this._handlePopState),this.initialized=!0,d.V.info("History manager initialized"))}pushState(e,t=!1){if(this.isNavigating)return;const n=this._stateToUrl(e),s={...e,timestamp:Date.now()};t?(window.history.replaceState(s,"",n),d.V.debug("History replaced:",n)):(window.history.pushState(s,"",n),d.V.debug("History pushed:",n))}replaceState(e){this.pushState(e,!0)}back(){window.history.back()}forward(){window.history.forward()}parseUrl(e=window.location.hash){if(!e||"#"===e||"#/"===e)return{view:"explore"};const t=e.replace(/^#\/?/,"").split("/");if(0===t.length)return{view:"explore"};switch(t[0]){case"explore":return{view:"explore",filter:t[1]||"all",category:t[2]||null};case"channel":return t.length>=2?{view:"channel",streamId:t.slice(1).join("/")}:{view:"explore"};case"preview":return t.length>=2?{view:"preview",streamId:t.slice(1).join("/")}:{view:"explore"};case"settings":return{view:"settings"};default:return{view:"explore"}}}getInitialState(){return this.parseUrl(window.location.hash)}_stateToUrl(e){const t=window.location.pathname;switch(e.view){case"channel":return`${t}#/channel/${e.streamId}`;case"preview":return`${t}#/preview/${e.streamId}`;case"explore":return e.filter&&"all"!==e.filter?`${t}#/explore/${e.filter}`:`${t}#/explore`;case"settings":return`${t}#/settings`;default:return`${t}#/explore`}}_handlePopState(e){d.V.debug("Popstate event:",e.state);const t=e.state||this.parseUrl();if(this.onNavigate){this.isNavigating=!0;try{this.onNavigate(t)}finally{setTimeout(()=>{this.isNavigating=!1},100)}}}destroy(){window.removeEventListener("popstate",this._handlePopState),this.initialized=!1}},p={RPC_URLS:["https://rpc.ankr.com/polygon","https://polygon.drpc.org","https://polygon-bor-rpc.publicnode.com"],currentRpcIndex:0,GAS_UNITS:{createStream:42e4,setPublicPermissions:8e4,setPermissionsBatch:21e4,addStorageNode:165e3},cachedGasPrice:null,cacheTime:0,CACHE_DURATION:6e4,async rpcCall(e,t=[]){let n=null;const s=this.currentRpcIndex;for(let i=0;i<this.RPC_URLS.length;i++){const a=(s+i)%this.RPC_URLS.length,r=this.RPC_URLS[a];try{const n=new AbortController,s=setTimeout(()=>n.abort(),5e3),i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",method:e,params:t,id:1}),signal:n.signal});if(clearTimeout(s),!i.ok)throw new Error(`HTTP ${i.status}`);const o=await i.json();if(o.error)throw new Error(o.error.message||"RPC error");return this.currentRpcIndex=a,o}catch(e){n=e,d.V.debug(`RPC ${r} failed: ${e.message}`);continue}}throw n||new Error("All RPCs failed")},async getGasPrice(){const e=Date.now();if(this.cachedGasPrice&&e-this.cacheTime<this.CACHE_DURATION)return this.cachedGasPrice;try{const t=await this.rpcCall("eth_gasPrice"),n=parseInt(t.result,16);return this.cachedGasPrice=n,this.cacheTime=e,n}catch(e){return d.V.warn("Failed to fetch gas price:",e),3e10}},formatPOL(e){const t=e/1e18;return t<1e-4?"< 0.0001 POL":t<.01?`~${t.toFixed(4)} POL`:`~${t.toFixed(3)} POL`},formatGwei:e=>`${(e/1e9).toFixed(1)} gwei`,async estimateCosts(){const e=await this.getGasPrice(),t=e*(this.GAS_UNITS.createStream+this.GAS_UNITS.setPublicPermissions+this.GAS_UNITS.addStorageNode),n=e*(this.GAS_UNITS.createStream+this.GAS_UNITS.setPermissionsBatch+this.GAS_UNITS.addStorageNode);return{public:t,password:t,native:n,gasPrice:e,formatted:{public:this.formatPOL(t),password:this.formatPOL(t),native:this.formatPOL(n),gasPrice:this.formatGwei(e)}}},async getBalance(e){try{const t=await this.rpcCall("eth_getBalance",[e,"latest"]);return parseInt(t.result,16)}catch(e){return d.V.warn("Failed to fetch balance:",e),null}},formatBalancePOL(e){if(null==e)return"Error";const t=e/1e18;return 0===t?"0 POL":t<1e-4?"< 0.0001 POL":t<1?`${t.toFixed(4)} POL`:t<100?`${t.toFixed(3)} POL`:`${t.toFixed(2)} POL`}};var g=n(6684);const w={success:'<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',error:'<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',info:'<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',warning:'<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>'},v=new class{constructor(){this.currentLoadingToast=null}showLoading(e){const t=document.getElementById("loading-overlay"),n=document.getElementById("loading-text");t&&n&&(n.textContent=e||"Loading...",t.classList.add("active"))}hideLoading(){const e=document.getElementById("loading-overlay");e&&e.classList.remove("active")}showNotification(e,t="info",n=3e3){const s=document.getElementById("toast-container");if(!s)return void d.V.debug(`[${t}] ${e}`);const i=document.createElement("div");i.className=`toast ${t}`,i.style.setProperty("--toast-duration",`${n}ms`),i.innerHTML=`\n            ${w[t]||w.info}\n            <div class="toast-content">\n                <span class="toast-message">${(0,g.ZD)(e)}</span>\n            </div>\n            <span class="toast-close" title="Dismiss">\n                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n            </span>\n            <div class="toast-progress"></div>\n        `;const a=i.querySelector(".toast-close");a?.addEventListener("click",()=>{i.classList.add("toast-exit"),setTimeout(()=>i.remove(),250)}),s.appendChild(i),setTimeout(()=>{i.parentElement&&(i.classList.add("toast-exit"),setTimeout(()=>i.remove(),250))},n)}showLoadingToast(e,t="This may take a moment..."){const n=document.getElementById("toast-container");if(!n)return d.V.debug(`[loading] ${e}`),null;n.querySelectorAll(".toast.loading").forEach(e=>e.remove());const s=document.createElement("div");return s.className="toast loading",s.innerHTML=`\n            <svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>\n            </svg>\n            <div class="toast-content">\n                <span class="toast-message">${(0,g.ZD)(e)}</span>\n                ${t?`<span class="text-[11px] text-white/40 block mt-0.5">${(0,g.ZD)(t)}</span>`:""}\n            </div>\n            <div class="toast-progress"></div>\n        `,n.appendChild(s),this.currentLoadingToast=s,s}hideLoadingToast(e=null){const t=e||this.currentLoadingToast;t&&t.parentElement&&(t.classList.add("toast-exit"),setTimeout(()=>t.remove(),250)),this.currentLoadingToast=null}showLoadingMoreIndicator(e){this.hideLoadingMoreIndicator();const t=document.createElement("div");t.id="loading-more-indicator",t.className="flex justify-center py-3",t.innerHTML='\n            <div class="flex items-center gap-2 text-gray-400 text-sm">\n                <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24">\n                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>\n                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n                </svg>\n                <span>Loading older messages...</span>\n            </div>\n        ',e?.prepend(t)}hideLoadingMoreIndicator(){const e=document.getElementById("loading-more-indicator");e&&e.remove()}},y=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],f=new class{constructor(){this.messageReactions=null,this.reactionPickerTimeout=null,this.deps={}}setDependencies(e){this.deps={...this.deps,...e}}init(){this.messageReactions||(this.messageReactions=new Map)}clear(){this.messageReactions&&this.messageReactions.clear()}loadFromChannelState(e){this.init(),this.clear();for(const[t,n]of Object.entries(e))this.messageReactions.set(t,n)}getReactions(e){return this.messageReactions?.get(e)}exportAsObject(){if(!this.messageReactions)return{};const e={};for(const[t,n]of this.messageReactions.entries())e[t]=n;return e}toggleReaction(e,t){this.init();const n=this.deps.getCurrentAddress?.();if(!n)return{isRemoving:!1};this.messageReactions.has(e)||this.messageReactions.set(e,{});const s=this.messageReactions.get(e);s[t]||(s[t]=[]);const i=s[t].findIndex(e=>e.toLowerCase()===n.toLowerCase()),a=i>=0;return a?(s[t].splice(i,1),0===s[t].length&&delete s[t]):s[t].push(n),this.updateReactionUI(e),this.deps.onSendReaction&&this.deps.onSendReaction(e,t,a),{isRemoving:a}}handleIncomingReaction(e,t,n,s="add"){this.init(),this.messageReactions.has(e)||this.messageReactions.set(e,{});const i=this.messageReactions.get(e);i[t]||(i[t]=[]);const a=n.toLowerCase(),r=i[t].findIndex(e=>e.toLowerCase()===a);"remove"===s?r>=0&&(i[t].splice(r,1),0===i[t].length&&delete i[t],this.updateReactionUI(e)):r<0&&(i[t].push(n),this.updateReactionUI(e))}updateReactionUI(e){const t=document.querySelector(`[data-reactions-for="${e}"]`);if(!t)return;const n=this.messageReactions?.get(e),s=this.getCurrentAddress?.()?.toLowerCase();if(t.innerHTML="",n)for(const[i,a]of Object.entries(n))if(a.length>0){const n=a.some(e=>e.toLowerCase()===s),r=document.createElement("span");r.className="reaction-badge "+(n?"user-reacted":""),r.dataset.emoji=i,r.dataset.msgId=e,r.innerHTML=`<span class="reaction-emoji">${i}</span>${a.length}`,r.addEventListener("click",()=>this.toggleReaction(e,i)),t.appendChild(r)}}showReactionPicker(e,t,n){const s=document.getElementById("reaction-picker");if(!s)return;this.reactionPickerTimeout&&(clearTimeout(this.reactionPickerTimeout),this.reactionPickerTimeout=null);const i=e.target.getBoundingClientRect();s.style.visibility="hidden",s.style.display="flex";const a=s.offsetWidth,r=s.offsetHeight,o=window.innerWidth,l=window.innerHeight;let d=i.left,c=i.bottom+5;d+a>o-10&&(d=o-a-10),c+r>l-10&&(c=i.top-r-5),d=Math.max(10,d),s.style.left=`${d}px`,s.style.top=`${c}px`,s.style.visibility="visible",s.dataset.currentMsgId=t,s.querySelectorAll("span").forEach(e=>{e.onclick=()=>{this.toggleReaction(t,e.dataset.emoji),s.style.display="none"}});const h=()=>{this.reactionPickerTimeout=setTimeout(()=>{s.style.display="none"},150)};s.onmouseleave=h,s.onmouseenter=()=>{this.reactionPickerTimeout&&(clearTimeout(this.reactionPickerTimeout),this.reactionPickerTimeout=null)},n&&(n.onmouseleave=h)}initEmojiPicker(e){const t=document.getElementById("emoji-picker"),n=document.getElementById("emoji-btn");t&&n&&(t.innerHTML=y.map(e=>`<span>${e}</span>`).join(""),t.querySelectorAll("span").forEach(t=>{t.addEventListener("click",()=>{e&&(e.value+=t.textContent,e.focus())})}),n.addEventListener("click",e=>{e.stopPropagation(),t.style.display="flex"===t.style.display?"none":"flex"}),document.addEventListener("click",e=>{t.contains(e.target)||e.target===n||(t.style.display="none");const s=document.getElementById("reaction-picker");s&&!s.contains(e.target)&&(s.style.display="none");const i=document.getElementById("attach-menu"),a=document.getElementById("attach-btn");i&&!i.contains(e.target)&&e.target!==a&&i.classList.add("hidden")}))}attachReactionListeners(e,t,n){document.querySelectorAll(".react-btn").forEach(e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("mouseenter",e=>{const n=t.dataset.msgId;this.showReactionPicker(e,n,t)}),t.addEventListener("click",e=>{e.stopPropagation();const n=t.dataset.msgId;this.showReactionPicker(e,n,t)})}),document.querySelectorAll(".reply-btn").forEach(t=>{const n=t.cloneNode(!0);t.parentNode.replaceChild(n,t),n.addEventListener("click",t=>{t.stopPropagation();const s=n.dataset.msgId;e&&e(s)})}),document.querySelectorAll(".reply-preview").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.replyToId;t&&n&&n(t)})}),document.querySelectorAll(".reaction-badge").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.msgId,n=e.dataset.emoji;this.toggleReaction(t,n)})}),document.querySelectorAll(".download-file-btn").forEach(e=>{e.addEventListener("click",async n=>{n.stopPropagation();const s=e.dataset.fileId;t&&await t(s)})})}};var b=n(9423);const x=new class{constructor(){this.deps={}}setDependencies(e){this.deps={...this.deps,...e}}updateOnlineUsers(e,t,n){if(e&&(e.textContent=n.length),t)if(0===n.length)t.innerHTML='<div class="text-gray-400 text-sm text-center">No one online</div>';else{const e=this.deps.getCurrentAddress?.()?.toLowerCase();t.innerHTML=n.map(t=>{const n=t.address||t.id,s=n?.toLowerCase()===e,i=t.nickname,a=(0,g.M0)(n),r=i?(0,g.ZD)(i):a;let o="";i?o=s?`${a} (you)`:a:s&&(o="(you)");const l=(0,b.Y0)(n,28,.22);return`\n                        <div class="user-item-wrapper" data-user-address="${(0,g.dc)(n)}">\n                            <div class="user-item cursor-pointer hover:bg-[#2a2a2a] rounded px-2 py-1.5 -mx-2">\n                                <div class="user-avatar-small flex-shrink-0" style="width:28px;height:28px;border-radius:6px;overflow:hidden;">${l}</div>\n                                <div class="flex flex-col min-w-0 flex-1">\n                                    <span class="text-gray-300 truncate text-sm ${s?"font-semibold":""}">${r}</span>\n                                    ${o?`<span class="text-gray-500 text-xs truncate">${o}</span>`:""}\n                                </div>\n                                <button class="user-menu-btn ml-auto text-gray-500 hover:text-gray-300 p-1" title="Options">\n                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">\n                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>\n                                    </svg>\n                                </button>\n                            </div>\n                        </div>\n                    `}).join(""),this.attachUserMenuListeners()}}attachUserMenuListeners(){document.querySelectorAll(".user-menu-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.closest(".user-item-wrapper"),s=n?.dataset.userAddress,i=s?.toLowerCase()===this.deps.getCurrentAddress?.()?.toLowerCase();this.closeUserDropdown();const a=document.createElement("div");a.id="user-dropdown-menu",a.className="fixed bg-[#1e1e1e] border border-gray-700 rounded-lg shadow-xl py-1 z-[9999] min-w-[160px]";const r=(0,g.dc)(s);a.innerHTML=`\n                    <button class="user-action w-full text-left px-3 py-2 hover:bg-[#2a2a2a] text-sm text-gray-300" data-action="copy-address" data-address="${r}">\n                         Copy Address\n                    </button>\n                    ${i?"":`\n                    <button class="user-action w-full text-left px-3 py-2 hover:bg-[#2a2a2a] text-sm text-gray-300" data-action="add-contact" data-address="${r}">\n                         Add to Contacts\n                    </button>\n                    <button class="user-action w-full text-left px-3 py-2 hover:bg-[#2a2a2a] text-sm text-red-400" data-action="start-dm" data-address="${r}">\n                         Start DM\n                    </button>\n                    `}\n                `,document.body.appendChild(a);const o=e.getBoundingClientRect(),l=a.getBoundingClientRect();let d=o.left-l.width-8,c=o.top;d<8&&(d=o.right+8),c+l.height>window.innerHeight-8&&(c=window.innerHeight-l.height-8),a.style.left=`${d}px`,a.style.top=`${c}px`,a.querySelectorAll(".user-action").forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const n=e.dataset.action,s=e.dataset.address;this.closeUserDropdown(),this.deps.onUserMenuAction&&await this.deps.onUserMenuAction(n,s)})}),setTimeout(()=>{document.addEventListener("click",this.closeUserDropdown.bind(this),{once:!0})},0)})})}closeUserDropdown(){const e=document.getElementById("user-dropdown-menu");e&&e.remove()}},C=new class{constructor(){this.deps={}}setDependencies(e){this.deps={...this.deps,...e}}showChannelDropdown(e,t,n){if(!n)return;this.closeChannelDropdown();const s=document.createElement("div");s.id="channel-dropdown-menu",s.className="fixed bg-[#141414] border border-white/10 rounded-xl shadow-2xl py-1 z-[9999] min-w-[180px] overflow-hidden",s.innerHTML='\n            <button class="channel-action w-full text-left px-4 py-2.5 hover:bg-white/5 text-sm text-white/70 hover:text-white transition flex items-center gap-2" data-action="copy-stream-id">\n                <span class="w-4 h-4 flex items-center justify-center font-semibold text-base">#</span>\n                Copy Channel ID\n            </button>\n            <button class="channel-action w-full text-left px-4 py-2.5 hover:bg-white/5 text-sm text-white/70 hover:text-white transition flex items-center gap-2" data-action="channel-settings">\n                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>\n                Channel Settings\n            </button>\n            <div class="my-1 border-t border-white/5"></div>\n            <button class="channel-action w-full text-left px-4 py-2.5 hover:bg-red-500/10 text-sm text-white/50 hover:text-red-400 transition flex items-center gap-2" data-action="leave-channel">\n                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/></svg>\n                Leave Channel\n            </button>\n        ',document.body.appendChild(s);const i=t.getBoundingClientRect(),a=s.getBoundingClientRect();let r=i.left,o=i.bottom+4;r+a.width>window.innerWidth-8&&(r=i.right-a.width),o+a.height>window.innerHeight-8&&(o=i.top-a.height-4),s.style.left=`${r}px`,s.style.top=`${o}px`,s.querySelectorAll(".channel-action").forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const n=e.dataset.action;this.closeChannelDropdown(),this.deps.onChannelMenuAction&&await this.deps.onChannelMenuAction(n)})}),setTimeout(()=>{document.addEventListener("click",this.closeChannelDropdown.bind(this),{once:!0})},0)}closeChannelDropdown(){const e=document.getElementById("channel-dropdown-menu");e&&e.remove()}closeAllDropdowns(){this.closeChannelDropdown();const e=document.getElementById("user-dropdown-menu");e&&e.remove()}},L=new class{constructor(){this.mediaCache=new Map,this.mediaIdCounter=0,this.deps={}}setDependencies(e){this.deps={...this.deps,...e}}registerMedia(e,t="image"){if(!(0,g.cP)(e))return d.V.warn("Invalid media URL rejected:",e?.substring(0,50)),null;const n="media_"+ ++this.mediaIdCounter;return this.mediaCache.set(n,{url:e,type:t}),n}getMedia(e){return this.mediaCache.get(e)}openLightboxById(e){const t=this.mediaCache.get(e);t&&this.openLightbox(t.url,t.type)}openLightbox(e,t="image"){const n=document.getElementById("media-lightbox-modal"),s=document.getElementById("lightbox-image"),i=document.getElementById("lightbox-video");n&&(s&&s.classList.add("hidden"),i&&(i.classList.add("hidden"),i.pause(),i.src=""),"image"===t&&s?(s.src=e,s.classList.remove("hidden")):"video"===t&&i&&(i.src=e,i.classList.remove("hidden")),n.classList.remove("hidden"))}closeLightbox(){const e=document.getElementById("media-lightbox-modal"),t=document.getElementById("lightbox-video");t&&t.pause(),e&&e.classList.add("hidden")}attachLightboxListeners(){document.querySelectorAll(".lightbox-trigger[data-media-id]").forEach(e=>{e.dataset.lightboxBound||(e.dataset.lightboxBound="true",e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.mediaId;n&&this.openLightboxById(n)}))})}async handleFileDownload(e,t,n){if(!t)return;const s=t.messages.find(t=>t.metadata?.fileId===e);if(!s||!s.metadata)return void(this.deps.showNotification&&this.deps.showNotification("File not found","error"));const i=document.querySelector(`[data-progress-overlay="${e}"]`);i&&i.classList.remove("hidden");const a=document.querySelector(`[data-progress-text="${e}"]`);a&&(a.textContent="Starting...");const r=document.querySelector(`.download-file-btn[data-file-id="${e}"]`);if(r){const e=r.querySelector(".download-play-icon"),t=r.querySelector(".download-loading-icon");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),r.disabled=!0,r.classList.add("cursor-not-allowed")}try{await n.startDownload(t.streamId,s.metadata,t.password)}catch(t){this.deps.showNotification&&this.deps.showNotification("Download failed: "+t.message,"error"),this.resetDownloadUI(e)}}resetDownloadUI(e){const t=document.querySelector(`[data-progress-overlay="${e}"]`);t&&t.classList.add("hidden");const n=document.querySelector(`.download-file-btn[data-file-id="${e}"]`);if(n){const e=n.querySelector(".download-play-icon"),t=n.querySelector(".download-loading-icon");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n.disabled=!1,n.classList.remove("cursor-not-allowed","opacity-50")}}clearCache(){this.mediaCache.clear(),this.mediaIdCounter=0}},I="single",E="first",k="middle",S="last";function M(e,t){return!(!e||!t)&&(e.sender?.toLowerCase()===t.sender?.toLowerCase()&&(!(Math.abs(t.timestamp-e.timestamp)>12e4)&&new Date(e.timestamp).toDateString()===new Date(t.timestamp).toDateString()))}const A="stack",B="ping-pong",P="same-side",$=new class{constructor(){this.deps={}}setDependencies(e){this.deps={...this.deps,...e}}isEmojiOnly(e){if(!e)return!1;const t=/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu,n=e.replace(/\s/g,""),s=n.match(t);return!(!s||0===s.length)&&(!(n.replace(t,"").replace(/[\uFE0F\u200D]/g,"").length>0)&&(s.length<=3?"true":"many"))}wrapInlineEmojis(e){return e.replace(/([\p{Emoji_Presentation}\p{Extended_Pictographic}][\uFE0F\u200D]?)/gu,'<span class="inline-emoji">$1</span>')}formatFileSize(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":e<1073741824?(e/1048576).toFixed(2)+" MB":(e/1073741824).toFixed(2)+" GB"}renderDateSeparator(e){const t=new Date,n=new Date(t);let s;if(n.setDate(n.getDate()-1),e.toDateString()===t.toDateString())s="Today";else if(e.toDateString()===n.toDateString())s="Yesterday";else{const n=e.toLocaleDateString("en-US",{month:"long"}),i=e.getDate(),a=e.getFullYear();s=a===t.getFullYear()?`${n} ${i}`:`${n} ${i}, ${a}`}return`\n            <div class="date-separator">\n                <span class="date-pill">${s}</span>\n            </div>\n        `}renderReactions(e,t){const n=this.deps.getMessageReactions?.(e);if(!n||0===Object.keys(n).length)return`<div class="reactions-container" data-reactions-for="${(0,g.dc)(e)}"></div>`;const s=this.deps.getCurrentAddress?.()?.toLowerCase();let i=`<div class="reactions-container" data-reactions-for="${(0,g.dc)(e)}">`;for(const[t,a]of Object.entries(n))a.length>0&&(i+=`<span class="reaction-badge ${a.some(e=>e.toLowerCase()===s)?"user-reacted":""}" data-emoji="${(0,g.dc)(t)}" data-msg-id="${(0,g.dc)(e)}"><span class="reaction-emoji">${t}</span>${a.length}</span>`);return i+="</div>",i}renderReplyPreview(e){if(!e)return"";const t=e.senderName||(0,g.M0)(e.sender),n=e.text?(0,g.ZD)(e.text.substring(0,50))+(e.text.length>50?"...":""):"[Message]";return`\n            <div class="reply-preview" data-reply-to-id="${(0,g.dc)(e.id)}">\n                <span class="reply-preview-name">${(0,g.ZD)(t)}</span>\n                <span class="reply-preview-text">${n}</span>\n            </div>\n        `}renderImageContent(e){let t=this.deps.getImage?.(e.imageId);if(!t&&e.imageData&&(t=e.imageData,this.deps.cacheImage?.(e.imageId,t)),t){const e=this.deps.registerMedia?.(t,"image");return e?`\n                <div class="relative inline-block max-w-xs group">\n                    <img src="${t}" \n                         class="max-w-full max-h-60 rounded-lg cursor-pointer object-contain lightbox-trigger" \n                         data-media-id="${e}"\n                         alt="Image"/>\n                    <button class="absolute top-1 right-1 bg-black/60 hover:bg-black/80 text-white p-1 rounded transition opacity-0 group-hover:opacity-100 lightbox-trigger"\n                            data-media-id="${e}"\n                            title="Maximize">\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>\n                        </svg>\n                    </button>\n                </div>\n            `:'<div class="text-red-400 text-sm">Invalid image data</div>'}{const t=this.deps.getCurrentChannel?.();return t&&this.deps.requestImage?.(t.streamId,e.imageId,t.password),`\n                <div data-image-id="${(0,g.dc)(e.imageId)}" class="bg-[#1a1a1a] rounded-lg p-4 max-w-xs">\n                    <div class="flex items-center gap-2">\n                        <div class="animate-spin w-4 h-4 border-2 border-gray-600 border-t-white rounded-full"></div>\n                        <span class="text-gray-500 text-sm">Loading image...</span>\n                    </div>\n                </div>\n            `}}renderVideoContent(e){const t=e.metadata;if(!t)return(0,g.ZD)(e.text||"");const n=this.deps.getCurrentAddress?.(),s=(e.sender?.toLowerCase(),n?.toLowerCase(),this.deps.getFileUrl?.(t.fileId)),i=this.deps.isSeeding?.(t.fileId),a=(0,g.dc)(t.fileId),r=(0,g.ZD)(t.fileName),o=(0,g.ZD)(t.fileType);if(s){const e=this.deps.isVideoPlayable?.(t.fileType),n=this.deps.registerMedia?.(s,"video");return e&&n?`\n                    <div data-file-id="${a}" class="video-container">\n                        <div class="relative rounded-lg overflow-hidden bg-black">\n                            <video src="${s}" \n                                   class="w-full max-h-56 cursor-pointer video-player-${a}" \n                                   controls\n                                   preload="metadata"\n                                   playsinline>\n                                <source src="${s}" type="${o}">\n                            </video>\n                            <button class="absolute top-1 right-1 bg-black/60 hover:bg-black/80 text-white p-1 rounded transition lightbox-trigger"\n                                    data-media-id="${n}"\n                                    title="Fullscreen">\n                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>\n                                </svg>\n                            </button>\n                            ${i?'\n                            <div class="absolute bottom-1 left-1 bg-green-600/80 text-white text-[10px] px-1.5 py-0.5 rounded-full flex items-center gap-1">\n                                <svg class="w-2.5 h-2.5 animate-pulse" fill="currentColor" viewBox="0 0 20 20">\n                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>\n                                </svg>\n                                Seeding\n                            </div>\n                            ':""}\n                        </div>\n                        <div class="flex items-center gap-2 mt-1 px-0.5 text-[11px] text-gray-500">\n                            <span class="truncate flex-1">${r}</span>\n                            <span class="text-gray-600">${this.formatFileSize(t.fileSize)}</span>\n                            <a href="${s}" download="${r}" class="text-blue-400 hover:text-blue-300">Save</a>\n                        </div>\n                    </div>\n                `:`\n                    <div data-file-id="${a}" class="video-container">\n                        <div class="flex items-center gap-2 bg-[#1a1a1a] rounded-lg p-2">\n                            <svg class="w-8 h-8 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/>\n                            </svg>\n                            <div class="flex-1 min-w-0">\n                                <div class="text-sm text-white truncate">${r}</div>\n                                <div class="text-[10px] text-yellow-500/80">Format not playable  ${this.formatFileSize(t.fileSize)}</div>\n                            </div>\n                            <a href="${s}" download="${r}" class="bg-blue-600 hover:bg-blue-500 text-white px-2.5 py-1 rounded text-xs flex-shrink-0 transition">\n                                Save\n                            </a>\n                        </div>\n                        ${i?'\n                        <div class="flex items-center gap-1 mt-1 px-0.5">\n                            <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>\n                            <span class="text-[10px] text-green-400">Seeding</span>\n                        </div>\n                        ':""}\n                    </div>\n                `}return`\n            <div data-file-id="${a}" class="video-container">\n                <div class="relative rounded-lg overflow-hidden bg-[#1a1a1a] cursor-pointer group"\n                     style="aspect-ratio: 16/9; width: 220px;">\n                    <div class="absolute inset-0 flex items-center justify-center">\n                        <svg class="w-10 h-10 text-purple-500/20" fill="currentColor" viewBox="0 0 24 24">\n                            <path d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/>\n                        </svg>\n                    </div>\n                    <button class="download-file-btn absolute inset-0 flex items-center justify-center bg-black/30 hover:bg-black/40 transition-all" \n                            data-file-id="${a}">\n                        <div class="play-btn-container transform group-hover:scale-105 transition-transform">\n                            <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center border border-white/30">\n                                <svg class="w-5 h-5 text-white ml-0.5 download-play-icon" fill="currentColor" viewBox="0 0 24 24">\n                                    <path d="M8 5v14l11-7z"/>\n                                </svg>\n                                <div class="download-loading-icon hidden">\n                                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </button>\n                    <div data-progress-overlay="${a}" class="hidden absolute inset-0 bg-black/70 flex flex-col items-center justify-center">\n                        <div class="text-white text-sm font-medium" data-progress-percent="${a}">0%</div>\n                        <div class="w-2/3 bg-gray-700 rounded-full h-1.5 mt-1.5">\n                            <div data-progress-fill="${a}" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>\n                        </div>\n                        <div class="text-[10px] text-gray-400 mt-1" data-progress-text="${a}">Starting...</div>\n                    </div>\n                    <div class="absolute top-1.5 left-1.5 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1">\n                        <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20">\n                            <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm12.553 1.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>\n                        </svg>\n                        ${this.formatFileSize(t.fileSize)}\n                    </div>\n                    <div class="absolute top-1.5 right-1.5 bg-black/60 text-gray-400 text-[10px] px-1.5 py-0.5 rounded" data-seeder-count="${a}"></div>\n                </div>\n                <div class="mt-1 px-0.5 text-[11px] text-gray-500 truncate" title="${(0,g.ZD)(t.fileName)}">\n                    ${(0,g.ZD)(t.fileName)}\n                </div>\n            </div>\n        `}renderMessageContent(e){switch(e.type||"text"){case"image":return this.renderImageContent(e);case"video_announce":return this.renderVideoContent(e);default:const t=(0,g.ZD)(e.text||""),n=(0,g.Bu)(t).replace(/\n/g,"<br>");return this.wrapInlineEmojis(n)}}buildMessageHTML(e,t,n,s,i,a="msg-group-single",r=I,o=""){const l=e.id||e.timestamp,d=this.renderReactions(l,t),c=this.renderMessageContent(e),h=this.renderReplyPreview(e.replyTo),u=e.type||"text",m="text"===u&&this.isEmojiOnly(e.text),p=m?` data-emoji-only="${m}"`:"",w=(v=r)===I||v===E;var v;const y=(0,g.po)(e.sender),f=w?`\n                    <div class="message-sender-row flex items-center gap-1 mb-1">\n                        ${s.html}\n                        <span class="text-xs font-medium" style="color: ${y}">${(0,g.ZD)(i)}</span>\n                    </div>`:"",x=`<div class="${r===S||r===I?"message-avatar":"message-avatar message-avatar-hidden"}">${(0,b.Y0)(e.sender,46,.22)}</div>`;return`\n            <div class="message-entry ${t?"own-message":"other-message"} ${a} ${o}" data-msg-id="${(0,g.dc)(l)}" data-sender="${(0,g.dc)(e.sender||"")}" data-type="${(0,g.dc)(u)}"${p}>\n                ${t?"":x}\n                <div class="message-bubble">\n                    ${f}\n                    ${h}\n                    <div class="message-content">${c}</div>\n                    <div class="message-footer">\n                        ${d}\n                        <span class="message-time text-xs text-gray-500">${n}</span>\n                    </div>\n                    ${!e.verified?.valid&&e.signature?'<div class="text-xs text-red-400 mt-1"> Invalid signature</div>':""}\n                    <span class="reply-trigger reply-btn" data-msg-id="${(0,g.dc)(l)}" title="Reply"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 17l-5-5 5-5"/><path d="M4 12h11a4 4 0 0 1 4 4v4"/></svg></span>\n                    <span class="react-trigger react-btn" data-msg-id="${(0,g.dc)(l)}" title="React"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span>\n                </div>\n                ${t?x:""}\n            </div>\n        `}},T=new class{constructor(){this.pendingData={},this.deps={}}setDependencies(e){this.deps={...this.deps,...e}}show(e,t={}){const n=document.getElementById(e);if(n&&(n.classList.remove("hidden"),t.clearInputs&&n.querySelectorAll("input").forEach(e=>{"checkbox"===e.type?e.checked=!1:e.value=""}),t.focusElement)){const e=n.querySelector(t.focusElement);e?.focus()}}hide(e){const t=document.getElementById(e);t&&t.classList.add("hidden")}toggle(e){const t=document.getElementById(e);t&&t.classList.toggle("hidden")}isVisible(e){const t=document.getElementById(e);return t&&!t.classList.contains("hidden")}setPendingData(e,t){this.pendingData[e]=t}getPendingData(e){return this.pendingData[e]}clearPendingData(e){e?delete this.pendingData[e]:this.pendingData={}}showJoinChannelModal(e,t,n,s){e?.classList.remove("hidden"),t&&(t.value=""),n&&(n.value=""),s?.classList.add("hidden");const i=document.getElementById("join-has-password");i&&(i.checked=!1)}showJoinClosedChannelModal(e=""){const t=document.getElementById("join-closed-channel-modal"),n=document.getElementById("join-closed-stream-id-input"),s=document.getElementById("join-closed-name-input");n&&(n.value=e),s&&(s.value=""),t?.classList.remove("hidden")}showAddContactModal(e){const t=document.getElementById("add-contact-nickname-modal"),n=document.getElementById("add-contact-modal-address"),s=document.getElementById("add-contact-modal-nickname");t&&n&&s&&(this.setPendingData("contactAddress",e),n.textContent=e,s.value="",t.classList.remove("hidden"),s.focus())}hideAddContactModal(){this.hide("add-contact-nickname-modal"),this.clearPendingData("contactAddress")}showRemoveContactModal(e,t=null){const n=document.getElementById("remove-contact-modal"),s=document.getElementById("remove-contact-modal-address");n&&s&&(this.setPendingData("removeContactAddress",e),this.setPendingData("removeContactCallback",t),s.textContent=e,n.classList.remove("hidden"))}hideRemoveContactModal(){this.hide("remove-contact-modal"),this.clearPendingData("removeContactAddress"),this.clearPendingData("removeContactCallback")}hideNewChannelModal(){this.hide("new-channel-modal")}},V=new class{constructor(){this.deps={}}setDependencies(e){this.deps={...this.deps,...e}}get authManager(){return this.deps.authManager}get secureStorage(){return this.deps.secureStorage}get channelManager(){return this.deps.channelManager}get streamrController(){return this.deps.streamrController}get mediaController(){return this.deps.mediaController}get identityManager(){return this.deps.identityManager}get graphAPI(){return this.deps.graphAPI}get Logger(){return this.deps.Logger}get modalManager(){return this.deps.modalManager}showNotification(e,t){this.deps.showNotification?.(e,t)}showProgressModal(e,t){const n=document.createElement("div");return n.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50",n.innerHTML=`\n            <div class="bg-[#111111] rounded-xl w-[300px] overflow-hidden shadow-2xl border border-[#222]">\n                <div class="px-5 pt-5 pb-2">\n                    <h3 class="text-[14px] font-medium text-white">${e}</h3>\n                    <p class="text-[11px] text-[#666] mt-0.5">${t}</p>\n                </div>\n                <div class="px-5 pb-5 pt-3">\n                    <div class="flex items-center justify-between mb-1.5">\n                        <span class="text-[10px] text-[#666]">Progress</span>\n                        <span class="text-[10px] font-medium text-white" id="progress-label">0%</span>\n                    </div>\n                    <div class="h-1.5 bg-[#1a1a1a] rounded-full overflow-hidden">\n                        <div id="progress-bar" class="h-full bg-white transition-all duration-300 ease-out" style="width: 0%"></div>\n                    </div>\n                    <p class="text-[10px] text-[#555] text-center mt-3">This may take a few seconds...</p>\n                </div>\n            </div>\n        `,document.body.appendChild(n),n}updateProgressModal(e,t){const n=Math.round(100*t),s=e.querySelector("#progress-bar"),i=e.querySelector("#progress-label");s&&(s.style.width=`${n}%`),i&&(i.textContent=`${n}%`)}hideProgressModal(e){e&&e.parentNode&&document.body.removeChild(e)}initExportPrivateKeyUI(){const e=document.getElementById("export-key-password"),t=document.getElementById("unlock-private-key-btn"),n=document.getElementById("export-key-step1"),s=document.getElementById("export-key-step2"),i=document.getElementById("private-key-display"),a=document.getElementById("toggle-key-visibility"),r=document.getElementById("copy-private-key-btn"),o=document.getElementById("copy-key-progress"),l=document.getElementById("copy-key-text"),d=document.getElementById("lock-private-key-btn");let c=null,h=null,u=!1;if(t&&t.addEventListener("click",async()=>{const a=e?.value;if(a)try{t.disabled=!0,t.textContent=" Verifying...",c=await this.authManager.getPrivateKey(a),n?.classList.add("hidden"),s?.classList.remove("hidden"),i&&(i.value=c,i.type="password",u=!1),this.showNotification("Private key unlocked!","success")}catch(e){this.showNotification(e.message||"Failed to unlock","error")}finally{t.disabled=!1,t.textContent="Unlock Key",e&&(e.value="")}else this.showNotification("Please enter your password","error")}),a&&a.addEventListener("click",()=>{i&&(u=!u,i.type=u?"text":"password",a.innerHTML=u?'<svg class="w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"/></svg>':'<svg class="w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>')}),r){const e=()=>{c&&(o?.classList.remove("-translate-x-full"),o?.classList.add("translate-x-0"),l&&(l.textContent="Keep holding..."),h=setTimeout(async()=>{try{await navigator.clipboard.writeText(c),this.showNotification("Private key copied!","success"),l&&(l.textContent="Copied!"),setTimeout(()=>{l&&(l.textContent="Hold to Copy Private Key (2s)")},2e3)}catch(e){this.showNotification("Failed to copy","error")}t()},2e3))},t=()=>{h&&(clearTimeout(h),h=null),o?.classList.remove("translate-x-0"),o?.classList.add("-translate-x-full"),l&&"Keep holding..."===l.textContent&&(l.textContent="Hold to Copy Private Key (2s)")};r.addEventListener("mousedown",e),r.addEventListener("touchstart",e),r.addEventListener("mouseup",t),r.addEventListener("mouseleave",t),r.addEventListener("touchend",t),r.addEventListener("touchcancel",t)}d&&d.addEventListener("click",()=>{c=null,s?.classList.add("hidden"),n?.classList.remove("hidden"),i&&(i.value="",i.type="password"),u=!1,a&&(a.innerHTML='<svg class="w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>'),this.showNotification("Private key locked","info")})}initBackupRestoreUI(e){const t=document.getElementById("export-all-data-btn"),n=document.getElementById("import-data-btn"),s=document.getElementById("import-data-file");t&&t.addEventListener("click",async()=>{try{if(!this.secureStorage.isStorageUnlocked())return void this.showNotification("Please unlock account first","error");const t=await e("Export Account Backup","Enter your account password to create a backup.",!1);if(!t)return;const n=this.authManager.getAddress(),s=this.authManager.exportKeystore(n);if(!s)return void this.showNotification("No keystore found for this account","error");const i=JSON.parse(s),a=this.showProgressModal("Creating Backup","Encrypting with scrypt (same as Keystore V3)...");try{const e=await this.secureStorage.exportAccountBackup(i,t,e=>this.updateProgressModal(a,e));this.hideProgressModal(a);const n=JSON.stringify(e,null,2),s=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(s),o=(new Date).toISOString().slice(0,10),l=document.createElement("a");l.href=r,l.download=`pombo-account-backup-${o}.json`,l.click(),URL.revokeObjectURL(r),this.showNotification("Account backup exported!","success")}catch(e){this.hideProgressModal(a),this.showNotification("Failed to export: "+e.message,"error")}}catch(e){this.Logger?.error("Export failed:",e),this.showNotification("Failed to export: "+e.message,"error")}}),n&&s&&(n.addEventListener("click",()=>{s.click()}),s.addEventListener("change",async t=>{const n=t.target.files?.[0];if(n)try{const t=await n.text(),s=JSON.parse(t);if("pombo-account-backup"===s.format&&3===s.version)await this.handleAccountBackupImport(s,e);else if("pombo-full-backup"===s.format&&2===s.version)await this.handleEncryptedImport(s,e);else if("pombo-encrypted-backup"===s.format)await this.handleEncryptedDataImport(s,e);else{if("pombo-keystores"!==s.format)throw new Error("Unknown backup format");await this.handleKeystoresImport(s)}}catch(e){this.Logger?.error("Import failed:",e),this.showNotification("Failed to import: "+e.message,"error")}finally{s.value=""}}))}initDeleteAccountUI(){const e=document.getElementById("delete-account-password"),t=document.getElementById("verify-delete-account-btn"),n=document.getElementById("delete-account-step1"),s=document.getElementById("delete-account-step2"),i=document.getElementById("delete-account-btn"),a=document.getElementById("delete-account-progress"),r=document.getElementById("delete-account-text"),o=document.getElementById("cancel-delete-account-btn");let l=!1,d=null;if(t&&t.addEventListener("click",async()=>{const i=e?.value;if(i)try{t.disabled=!0,t.textContent=" Verifying...",await this.authManager.getPrivateKey(i),l=!0,n?.classList.add("hidden"),s?.classList.remove("hidden"),this.showNotification("Password verified","success")}catch(e){this.showNotification("Incorrect password","error")}finally{t.disabled=!1,t.textContent="Verify Password",e&&(e.value="")}else this.showNotification("Please enter your password","error")}),o&&o.addEventListener("click",()=>{l=!1,s?.classList.add("hidden"),n?.classList.remove("hidden")}),i){const e=()=>{l&&(a?.classList.remove("-translate-x-full"),a?.classList.add("translate-x-0"),r&&(r.textContent="Keep holding..."),d=setTimeout(async()=>{try{const e=this.authManager.getAddress();if(!e)throw new Error("No account connected");this.channelManager.stopPresenceTracking(),await this.channelManager.leaveAllChannels(),await this.streamrController.disconnect(),await this.mediaController.clearSeedFilesForOwner(e),this.mediaController.reset();const t=`pombo_secure_${e.toLowerCase()}`;localStorage.removeItem(t),this.secureStorage.lock(),this.authManager.deleteWallet(e),this.showNotification("Account deleted successfully","success"),this.modalManager?.hide("settings-modal"),this.deps.updateWalletInfo?.(null),this.deps.updateNetworkStatus?.("Disconnected",!1),this.deps.renderChannelList?.(),this.deps.resetToDisconnectedState?.(),this.authManager.hasSavedWallet()&&setTimeout(()=>{window.ethChat?.connectWallet()},500)}catch(e){this.Logger?.error("Failed to delete account:",e),this.showNotification("Failed to delete: "+e.message,"error")}t()},2e3))},t=()=>{d&&(clearTimeout(d),d=null),a?.classList.remove("translate-x-0"),a?.classList.add("-translate-x-full"),r&&"Keep holding..."===r.textContent&&(r.textContent="Hold to Delete (2s)")};i.addEventListener("mousedown",e),i.addEventListener("touchstart",e),i.addEventListener("mouseup",t),i.addEventListener("mouseleave",t),i.addEventListener("touchend",t),i.addEventListener("touchcancel",t)}}async handleAccountBackupImport(e,t){if(!this.secureStorage.isStorageUnlocked())return void this.showNotification("Please unlock account to import data","error");const n=await t("Decrypt Backup","Enter the password used for this backup.",!1);if(!n)return;const s=this.showProgressModal("Decrypting Backup","Using scrypt decryption...");try{const t=await this.secureStorage.importAccountBackup(e,n,e=>this.updateProgressModal(s,e));this.hideProgressModal(s);const i=this.authManager.getAddress()?.toLowerCase(),a=t.address?.toLowerCase();if(a&&i&&a!==i&&!confirm(`This backup is from a different account:\n\nBackup: ${a.slice(0,8)}...${a.slice(-6)}\nCurrent: ${i.slice(0,8)}...${i.slice(-6)}\n\nImport channels and contacts to your current account?`))return;const r=t.data;let o=0,l=0;if(r.channels&&r.channels.length>0){const e=new Set((this.secureStorage.cache.channels||[]).map(e=>e.messageStreamId||e.streamId));for(const t of r.channels){const n=t.messageStreamId||t.streamId;n&&!e.has(n)&&(this.secureStorage.cache.channels.push(t),o++)}}if(r.trustedContacts)for(const[e,t]of Object.entries(r.trustedContacts))this.secureStorage.cache.trustedContacts[e]||(this.secureStorage.cache.trustedContacts[e]=t,l++);r.username&&!this.secureStorage.cache.username&&(this.secureStorage.cache.username=r.username),await this.secureStorage.saveToStorage(),this.showNotification(`Imported: ${o} channels, ${l} contacts`,"success"),o>0&&(this.channelManager.loadChannels(),this.deps.renderChannelList?.()),l>0&&this.identityManager?.loadTrustedContacts?.()}catch(e){this.hideProgressModal(s),this.Logger?.error("Account backup import failed:",e),this.showNotification("Failed to import: "+e.message,"error")}}async handleEncryptedImport(e,t){const n=Object.keys(e.keystores?.keystores||{}).length,s=await t("Decrypt Backup","Enter the password used to encrypt this backup.",!1);if(!s)return;if(!this.secureStorage.isStorageUnlocked())return void this.showNotification("Please unlock account to import data","error");let i={keystoresImported:0};e.keystores&&n>0&&(i=this.authManager.importKeystores(e.keystores,!0));const a=await this.secureStorage.importEncrypted(e.encryptedData,s,!0);this.showNotification(`Imported: ${i.keystoresImported} wallets, ${a.channelsImported} channels, ${a.contactsImported} contacts`,"success"),a.channelsImported>0&&(this.channelManager.loadChannels(),this.deps.renderChannelList?.())}async handleEncryptedDataImport(e,t){const n=await t("Decrypt Backup","Enter the password used to encrypt this backup.",!1);if(!n)return;if(!this.secureStorage.isStorageUnlocked())return void this.showNotification("Please unlock account to import data","error");const s=await this.secureStorage.importEncrypted(e,n,!0);this.showNotification(`Imported: ${s.channelsImported} channels, ${s.contactsImported} contacts`,"success"),s.channelsImported>0&&(this.channelManager.loadChannels(),this.deps.renderChannelList?.())}async handleKeystoresImport(e){if(!confirm(`Import wallets from backup?\n\nWallets found: ${Object.keys(e.keystores||{}).length}\n\nThis will merge with existing wallets.`))return;const t=this.authManager.importKeystores(e,!0);this.showNotification(`Imported ${t.keystoresImported} wallets`,"success")}async updateGraphApiStatus(e){if(!e||!this.graphAPI)return;const t=await this.graphAPI.validateKey();this.graphAPI.isUsingDefaultKey()?(e.textContent="Using default key",e.className="text-xs text-yellow-500"):t?(e.textContent="Valid",e.className="text-xs text-green-500"):(e.textContent="Invalid key",e.className="text-xs text-red-500")}resetExportKeyUI(){document.getElementById("export-key-step1")?.classList.remove("hidden"),document.getElementById("export-key-step2")?.classList.add("hidden");const e=document.getElementById("export-key-password");e&&(e.value="")}resetDeleteAccountUI(){document.getElementById("delete-account-step1")?.classList.remove("hidden"),document.getElementById("delete-account-step2")?.classList.add("hidden");const e=document.getElementById("delete-account-password");e&&(e.value="")}},D=new class{constructor(){this.browseTypeFilter="public",this.browseCategoryFilter="",this.browseLanguageFilterValue="",this.cachedPublicChannels=null,this.deps={}}setDependencies(e){this.deps={...this.deps,...e}}getTemplate(e=!1){return`\n            <div class="explore-view flex flex-col h-full bg-[#161616]">\n                \x3c!-- Filters Section --\x3e\n                <div class="px-5 pt-3 pb-3 space-y-3">\n                    \x3c!-- Search + Language Filter --\x3e\n                    <div class="flex gap-3">\n                        <div class="flex-1 relative">\n                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>\n                            </svg>\n                            <input\n                                type="text"\n                                id="explore-search-input"\n                                placeholder="Search channels..."\n                                class="w-full bg-white/5 border border-white/10 text-white pl-10 pr-4 py-2.5 rounded-xl text-sm focus:outline-none focus:border-white/30 transition placeholder:text-white/30"\n                            />\n                        </div>\n                        <select id="explore-language-filter" class="bg-white/5 border border-white/10 text-white/80 px-3 py-2.5 rounded-xl text-sm focus:outline-none focus:border-white/30 transition cursor-pointer">\n                            <option value="" selected>All Languages</option>\n                            <option value="en">English</option>\n                            <option value="pt">Portugus</option>\n                            <option value="es">Espaol</option>\n                            <option value="fr">Franais</option>\n                            <option value="de">Deutsch</option>\n                            <option value="it">Italiano</option>\n                            <option value="zh"></option>\n                            <option value="ja"></option>\n                            <option value="ko"></option>\n                            <option value="ru"></option>\n                            <option value="ar"></option>\n                            <option value="other">Other</option>\n                        </select>\n                    </div>\n\n                    \x3c!-- Category Chips (collapsible) --\x3e\n                    <div class="relative">\n                        <div id="explore-category-chips" class="flex flex-wrap gap-1.5 overflow-hidden max-h-[26px] transition-all duration-200" data-expanded="false">\n                            <button type="button" data-category="" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white text-black">All</button>\n                            <button type="button" data-category="general" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">General</button>\n                            <button type="button" data-category="politics" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Politics</button>\n                            <button type="button" data-category="news" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">News</button>\n                            <button type="button" data-category="tech" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Tech & AI</button>\n                            <button type="button" data-category="crypto" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Crypto</button>\n                            <button type="button" data-category="finance" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Finance</button>\n                            <button type="button" data-category="science" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Science</button>\n                            <button type="button" data-category="gaming" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Gaming</button>\n                            <button type="button" data-category="entertainment" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Entertainment</button>\n                            <button type="button" data-category="sports" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Sports</button>\n                            <button type="button" data-category="health" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Health</button>\n                            <button type="button" data-category="education" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Education</button>\n                            <button type="button" data-category="comedy" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Comedy</button>\n                            ${e?'<button type="button" data-category="nsfw" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">NSFW</button><button type="button" data-category="adult" class="explore-category-chip px-2.5 py-1 rounded-md text-xs font-medium transition bg-white/5 text-white/60 hover:bg-white/10 hover:text-white/80">Adult</button>':""}\n                        </div>\n                        <button id="explore-toggle-categories-btn" type="button" class="hidden absolute right-0 top-0 h-[26px] px-2 items-center bg-gradient-to-l from-[#161616] via-[#161616] to-transparent pl-6 text-white/40 hover:text-white/60 transition">\n                            <svg id="explore-toggle-categories-icon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"/>\n                            </svg>\n                        </button>\n                    </div>\n                </div>\n\n                \x3c!-- Subtle separator --\x3e\n                <div class="mx-5 border-t border-[#333]"></div>\n\n                \x3c!-- Channel List --\x3e\n                <div id="explore-channels-list" class="flex-1 overflow-y-auto px-5 py-3 space-y-2">\n                    <div class="flex flex-col items-center justify-center py-12 text-white/40">\n                        <div class="spinner mb-3" style="width: 28px; height: 28px;"></div>\n                        <p class="text-sm">Loading channels...</p>\n                    </div>\n                </div>\n            </div>\n        `}setupListeners(){const e=document.getElementById("explore-search-input");e?.addEventListener("input",e=>{this.filterChannels(e.target.value)}),document.querySelectorAll("#explore-type-tabs .browse-filter-tab").forEach(t=>{t.addEventListener("click",()=>{this.browseTypeFilter=t.dataset.browseFilter,this.updateFilterTabs(),this.filterChannels(e?.value||"")})}),document.querySelectorAll(".explore-category-chip").forEach(t=>{t.addEventListener("click",()=>{this.browseCategoryFilter=t.dataset.category,this.updateCategoryChips(),this.filterChannels(e?.value||"")})}),document.getElementById("explore-toggle-categories-btn")?.addEventListener("click",()=>{this.toggleCategoriesExpand()}),this.checkCategoriesOverflow();const t=document.getElementById("explore-language-filter");t?.addEventListener("change",t=>{this.browseLanguageFilterValue=t.target.value,this.filterChannels(e?.value||"")})}resetFilters(){this.browseTypeFilter="public",this.browseCategoryFilter="",this.browseLanguageFilterValue="";const e=document.getElementById("explore-language-filter");e&&(e.value=this.browseLanguageFilterValue),this.updateFilterTabs(),this.updateCategoryChips()}async loadChannels(){const e=document.getElementById("explore-channels-list");if(e){e.innerHTML='\n            <div class="flex flex-col items-center justify-center py-12 text-white/40">\n                <div class="spinner mb-3" style="width: 28px; height: 28px;"></div>\n                <p class="text-sm">Loading channels...</p>\n            </div>\n        ';try{if(!this.deps.getPublicChannels)throw new Error("getPublicChannels dependency not set");const e=await this.deps.getPublicChannels();this.cachedPublicChannels=e,this.filterChannels("")}catch(t){console.error("Failed to load explore channels:",t),e.innerHTML=`\n                <div class="flex flex-col items-center justify-center py-12 text-white/40">\n                    <svg class="w-12 h-12 mb-3 text-red-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>\n                    </svg>\n                    <p class="text-sm">Failed to load channels</p>\n                    <p class="text-xs text-white/30 mt-1">${(0,g.ZD)(t.message)}</p>\n                </div>\n            `}}}filterChannels(e){if(!this.cachedPublicChannels)return;let t=this.cachedPublicChannels;this.browseTypeFilter&&(t=t.filter(e=>e.type===this.browseTypeFilter)),this.browseCategoryFilter&&(t=t.filter(e=>e.category===this.browseCategoryFilter));const n=!!this.deps.getNsfwEnabled&&this.deps.getNsfwEnabled();if("nsfw"===this.browseCategoryFilter||"adult"===this.browseCategoryFilter||n||(t=t.filter(e=>"nsfw"!==e.category&&"adult"!==e.category)),this.browseLanguageFilterValue&&(t=t.filter(e=>e.language===this.browseLanguageFilterValue)),e){const n=e.toLowerCase();t=t.filter(e=>e.name.toLowerCase().includes(n)||e.streamId.toLowerCase().includes(n)||e.description&&e.description.toLowerCase().includes(n))}this.renderChannelsList(t)}renderChannelsList(e){const t=document.getElementById("explore-channels-list");if(!t)return;if(0===e.length)return void(t.innerHTML='\n                <div class="flex flex-col items-center justify-center py-12 text-white/40">\n                    <svg class="w-12 h-12 mb-3 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>\n                    </svg>\n                    <p class="text-sm">No channels found</p>\n                    <p class="text-xs text-white/30 mt-1">Try adjusting your filters</p>\n                </div>\n            ');const n={politics:"Politics",news:"News",tech:"Tech & AI",crypto:"Crypto",finance:"Finance",science:"Science",gaming:"Gaming",entertainment:"Entertainment",sports:"Sports",health:"Health",education:"Education",comedy:"Comedy",general:"General",other:"Other",nsfw:"NSFW",adult:"Adult"},s={en:"EN",pt:"PT",es:"ES",fr:"FR",de:"DE",it:"IT",zh:"",ja:"",ko:"",ru:"RU",ar:"",other:"Other"};t.innerHTML=e.map(e=>{const t=e.readOnly?'<span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-amber-500/15 text-amber-400/80 text-[9px] font-medium rounded">RO</span>':"",i=e.category&&"general"!==e.category?`<span class="px-1.5 py-0.5 bg-white/5 text-white/50 text-[9px] font-medium rounded">${(0,g.ZD)(n[e.category]||e.category)}</span>`:"",a=e.language?`<span class="px-1.5 py-0.5 bg-white/5 text-white/40 text-[9px] font-medium rounded">${(0,g.ZD)(s[e.language]||e.language.toUpperCase())}</span>`:"",r=e.description?`<p class="text-xs text-white/40 mt-1 line-clamp-2">${(0,g.ZD)(e.description)}</p>`:"";return`\n            <div class="p-3 bg-white/5 border border-white/5 rounded-xl hover:bg-white/[0.07] hover:border-white/10 transition cursor-pointer explore-channel-item group" data-stream-id="${(0,g.dc)(e.streamId)}" data-type="${(0,g.dc)(e.type||"public")}">\n                <div class="flex items-start justify-between gap-3">\n                    <div class="flex-1 min-w-0">\n                        <div class="flex items-center gap-2 flex-wrap">\n                            <h4 class="text-sm font-medium text-white/90 truncate">${(0,g.ZD)(e.name)}</h4>\n                            ${t}\n                        </div>\n                        ${r}\n                    </div>\n                    <svg class="w-4 h-4 text-white/20 group-hover:text-white/40 flex-shrink-0 mt-0.5 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>\n                    </svg>\n                </div>\n                <div class="flex items-center gap-1.5 mt-2">\n                    ${i}\n                    ${a}\n                </div>\n            </div>\n            `}).join(""),t.querySelectorAll(".explore-channel-item").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.streamId,n=e.dataset.type;if(!t)return;const s=this.cachedPublicChannels?.find(e=>e.streamId===t);"password"===n||"native"===n?this.deps.joinPublicChannel&&await this.deps.joinPublicChannel(t,s):await this.deps.enterPreviewMode(t,s)})})}updateFilterTabs(){document.querySelectorAll("#explore-type-tabs .browse-filter-tab").forEach(e=>{e.dataset.browseFilter===this.browseTypeFilter?(e.classList.add("text-[#F6851B]","border-[#F6851B]"),e.classList.remove("text-white/40","hover:text-white/60","border-transparent")):(e.classList.remove("text-[#F6851B]","border-[#F6851B]"),e.classList.add("text-white/40","hover:text-white/60","border-transparent"))})}updateCategoryChips(){document.querySelectorAll(".explore-category-chip").forEach(e=>{e.dataset.category===this.browseCategoryFilter?(e.classList.add("bg-white","text-black"),e.classList.remove("bg-white/5","text-white/60","hover:bg-white/10","hover:text-white/80")):(e.classList.remove("bg-white","text-black"),e.classList.add("bg-white/5","text-white/60","hover:bg-white/10","hover:text-white/80"))})}toggleCategoriesExpand(){const e=document.getElementById("explore-category-chips"),t=document.getElementById("explore-toggle-categories-icon"),n=document.getElementById("explore-toggle-categories-btn");e&&("true"===e.dataset.expanded?(e.classList.add("max-h-[26px]"),e.classList.remove("max-h-[200px]"),e.dataset.expanded="false",t?.classList.remove("rotate-180"),n?.classList.remove("bg-transparent")):(e.classList.remove("max-h-[26px]"),e.classList.add("max-h-[200px]"),e.dataset.expanded="true",t?.classList.add("rotate-180"),n?.classList.add("bg-transparent")))}checkCategoriesOverflow(){const e=document.getElementById("explore-category-chips"),t=document.getElementById("explore-toggle-categories-btn");e&&t&&(e.scrollHeight>e.clientHeight?(t.classList.remove("hidden"),t.classList.add("flex")):(t.classList.add("hidden"),t.classList.remove("flex")))}},N=new class{constructor(){this.deps=null,this.elements=null}setDependencies(e){this.deps=e}setElements(e){this.elements=e}async show(){const{channelManager:e,streamrController:t,authManager:n}=this.deps,s=e.getCurrentChannel();if(!s)return void this.deps.showNotification("No channel selected","error");this.elements.channelSettingsName.textContent=s.name,this.elements.channelSettingsType.innerHTML=this.deps.getChannelTypeLabel(s.type,s.readOnly),this.elements.channelSettingsId.textContent=s.streamId;const i="native"===s.type,a=e.getCachedDeletePermission(s.streamId),r=a.valid?a.canDelete:await t.hasDeletePermission(s.streamId);d.V.debug("Channel settings:",{canDelete:r,fromCache:a.valid,currentAddress:n.getAddress()?.slice(0,10)});const o=!!i&&await e.canAddMembers(s.streamId);this.elements.nonNativeMessage.classList.toggle("hidden",i);const l=document.querySelector('[data-channel-tab="members"]');l?.classList.toggle("hidden",!i),this.elements.addMemberForm?.classList.toggle("hidden",!o),this.elements.permissionsSection?.classList.toggle("hidden",!r||!i),!i&&this.elements.membersList&&(this.elements.membersList.innerHTML=""),this.initTabs();const c=document.getElementById("danger-tab-divider"),h=document.getElementById("danger-tab-btn");c?.classList.toggle("hidden",!r),h?.classList.toggle("hidden",!r),this.selectTab("info"),T.show("channel-settings-modal"),i&&(await this.loadMembers(),r&&this.loadPermissions())}initTabs(){this.elements.channelSettingsTabs&&(this.elements.channelSettingsTabs.forEach(e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",()=>{const e=t.dataset.channelTab;this.selectTab(e)})}),this.elements.channelSettingsTabs=document.querySelectorAll(".channel-settings-tab"))}selectTab(e){document.querySelectorAll(".channel-settings-tab").forEach(t=>{const n=t.dataset.channelTab===e;t.classList.toggle("bg-white/10",n),t.classList.toggle("text-white",n),t.classList.toggle("text-white/60",!n&&"danger"!==t.dataset.channelTab)}),document.querySelectorAll(".channel-settings-panel").forEach(t=>{const n=t.id.replace("channel-panel-","");t.classList.toggle("hidden",n!==e)})}hide(){T.hide("channel-settings-modal"),this.elements.addMemberInput.value=""}showDeleteModal(){const e=this.deps.channelManager.getCurrentChannel();e&&(this.elements.deleteChannelName.textContent=e.name,T.show("delete-channel-modal"))}hideDeleteModal(){T.hide("delete-channel-modal")}async handleDelete(){const{channelManager:e,subscriptionManager:t,showNotification:n,showLoading:s,hideLoading:i,renderChannelList:a,selectChannel:r,showConnectedNoChannelState:o}=this.deps,l=e.getCurrentChannel();if(!l)return;const d=l.name,c=l.streamId;try{s("Deleting channel..."),this.hideDeleteModal(),this.hide(),await t.removeChannel(c),await e.deleteChannel(c),i(),n(`Channel "${d}" deleted successfully`,"success");const l=e.getAllChannels();l.length>0?(a(),await r(l[0].streamId)):(a(),o())}catch(e){i(),n("Failed to delete channel: "+e.message,"error")}}showLeaveModal(){const e=this.deps.channelManager.getCurrentChannel();if(!e)return;this.hideLeaveModal();const t=document.createElement("div");t.id="leave-channel-modal",t.className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60]",t.innerHTML=`\n            <div class="bg-[#141414] rounded-2xl w-[380px] max-w-[95vw] mx-4 shadow-2xl border border-white/5 overflow-hidden">\n                <div class="p-6">\n                    <div class="flex items-center gap-3 mb-4">\n                        <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-lg"></div>\n                        <h3 class="text-lg font-medium text-white/90">Leave Channel</h3>\n                    </div>\n                    <p class="text-sm text-white/50 mb-4">\n                        Are you sure you want to leave <span class="text-white/80 font-medium">"${(0,g.ZD)(e.name)}"</span>?\n                    </p>\n                    <p class="text-xs text-white/30 bg-white/5 rounded-lg px-3 py-2">\n                        You can rejoin later if you have the invite link.\n                    </p>\n                </div>\n                <div class="flex border-t border-white/5">\n                    <button id="cancel-leave-btn" class="flex-1 px-4 py-3 text-sm text-white/60 hover:text-white hover:bg-white/5 transition">\n                        Cancel\n                    </button>\n                    <button id="confirm-leave-btn" class="flex-1 px-4 py-3 text-sm text-red-400 hover:text-red-300 hover:bg-red-500/10 border-l border-white/5 transition">\n                        Leave\n                    </button>\n                </div>\n            </div>\n        `,document.body.appendChild(t),t.querySelector("#cancel-leave-btn").addEventListener("click",()=>this.hideLeaveModal()),t.querySelector("#confirm-leave-btn").addEventListener("click",()=>this.confirmLeave()),t.addEventListener("click",e=>{e.target===t&&this.hideLeaveModal()})}hideLeaveModal(){const e=document.getElementById("leave-channel-modal");e&&e.remove()}async confirmLeave(){const{channelManager:e,subscriptionManager:t,showNotification:n,renderChannelList:s,selectChannel:i,showConnectedNoChannelState:a}=this.deps,r=e.getCurrentChannel();if(!r)return;const o=r.name,l=r.streamId;this.hideLeaveModal(),this.hide();try{await t.removeChannel(l),await e.leaveChannel(l),n(`Left "${o}"`,"info");const r=e.getAllChannels();r.length>0?(s(),await i(r[0].streamId)):(s(),a())}catch(e){n("Failed to leave channel: "+e.message,"error")}}async loadMembers(){const e=this.deps.channelManager.getCurrentChannel();if(e&&"native"===e.type){this.elements.membersList.innerHTML='<div class="text-center text-white/30 py-4 text-sm">Loading...</div>';try{const t=await this.deps.channelManager.getChannelMembers(e.streamId);this.renderMembersList(t,e)}catch(e){this.elements.membersList.innerHTML=`<div class="text-center text-red-400/80 py-4 text-sm">Failed to load: ${e.message}</div>`}}}renderMembersList(e,t){const{authManager:n,channelManager:s,showLoading:i,hideLoading:a,showNotification:r}=this.deps;if(!e||0===e.length)return void(this.elements.membersList.innerHTML='<div class="text-center text-white/30 py-4 text-sm">No members found</div>');const o=n.getAddress()?.toLowerCase(),l=t.createdBy?.toLowerCase(),d=s.isChannelOwner(t.streamId),c=e.find(e=>("string"==typeof e?e:e.address)?.toLowerCase()===o),h="object"==typeof c&&c.canGrant;this.elements.membersList.innerHTML=e.map(e=>{const t="string"==typeof e?e:e.address,n="object"==typeof e&&e.canGrant,s="object"==typeof e&&e.isOwner,i=t.toLowerCase(),a=i===l,r=i===o,c=`${t.slice(0,8)}...${t.slice(-6)}`;let u="";a||s?u+='<span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded-full">Owner</span>':n&&(u+='<span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full">Admin</span>'),r&&(u+='<span class="text-xs text-white/60 ml-1">(you)</span>');const m=r||!d&&(!h||s||a||!s&&!a&&n)?"":`<button class="member-menu-btn text-white/30 hover:text-white/60 p-1.5 rounded-lg hover:bg-white/5 transition" \n                          data-address="${(0,g.dc)(t)}" data-can-grant="${n}" data-current-is-owner="${d}" title="Manage member">\n                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">\n                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>\n                    </svg>\n                   </button>`;return`\n                <div class="flex items-center justify-between p-2.5 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition group">\n                    <div class="flex items-center gap-2 min-w-0 flex-1">\n                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs text-white/60 font-mono">\n                            ${t.slice(2,4)}\n                        </div>\n                        <div class="flex flex-col min-w-0">\n                            <span class="font-mono text-xs text-white/70 truncate">${c}</span>\n                            <div class="flex items-center gap-1 mt-0.5">${u}</div>\n                        </div>\n                    </div>\n                    ${m}\n                </div>\n            `}).join(""),this.elements.membersList.querySelectorAll(".member-menu-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n="true"===e.dataset.currentIsOwner;this.showMemberDropdown(e,e.dataset.address,"true"===e.dataset.canGrant,n)})})}showMemberDropdown(e,t,n,s=!1){this.closeMemberDropdown();const i=`${t.slice(0,8)}...${t.slice(-6)}`,a=s?`\n            <button class="member-action w-full text-left px-4 py-2.5 hover:bg-white/5 text-sm transition flex items-center justify-between" data-action="toggle-grant">\n                <span class="flex items-center gap-2 ${n?"text-purple-400":"text-white/70"}">\n                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/></svg>\n                    <span>Can add members</span>\n                </span>\n                <span class="text-xs ${n?"text-purple-400":"text-white/30"}">${n?"ON":"OFF"}</span>\n            </button>\n            <div class="my-1 border-t border-white/5"></div>\n        `:"",r=document.createElement("div");r.id="member-dropdown-menu",r.className="fixed bg-[#141414] border border-white/10 rounded-xl shadow-2xl py-1 z-[9999] min-w-[200px] overflow-hidden",r.innerHTML=`\n            <div class="px-3 py-2 border-b border-white/5">\n                <div class="text-xs text-white/40">Member</div>\n                <div class="text-sm text-white/80 font-mono">${i}</div>\n            </div>\n            ${a}\n            <button class="member-action w-full text-left px-4 py-2.5 hover:bg-red-500/10 text-sm text-white/50 hover:text-red-400 transition flex items-center gap-2" data-action="remove">\n                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>\n                <span>Remove from channel</span>\n            </button>\n        `,document.body.appendChild(r);const o=e.getBoundingClientRect();let l=o.right-r.offsetWidth,d=o.bottom+4;l<8&&(l=8),d+r.offsetHeight>window.innerHeight-8&&(d=o.top-r.offsetHeight-4),r.style.left=`${l}px`,r.style.top=`${d}px`,r.querySelectorAll(".member-action").forEach(e=>{e.addEventListener("click",async s=>{s.stopPropagation();const i=e.dataset.action;this.closeMemberDropdown(),await this.handleMemberAction(i,t,n)})}),setTimeout(()=>{document.addEventListener("click",this.closeMemberDropdown.bind(this),{once:!0})},0)}closeMemberDropdown(){const e=document.getElementById("member-dropdown-menu");e&&e.remove()}async handleMemberAction(e,t,n){const{channelManager:s,showLoading:i,hideLoading:a,showNotification:r}=this.deps,o=s.getCurrentChannel();if(o)switch(e){case"toggle-grant":const e=!n;try{i(e?"Granting admin permission...":"Revoking admin permission..."),await s.updateMemberPermissions(o.streamId,t,{canGrant:e}),a(),r(e?"Member can now add others!":"Admin permission removed","success"),await this.loadMembers()}catch(e){a(),r("Failed to update permission: "+e.message,"error")}break;case"remove":this.showRemoveMemberModal(t)}}async handleAddMember(){const{channelManager:e,showLoading:t,hideLoading:n,showNotification:s}=this.deps,i=this.elements.addMemberInput.value.trim();if(!i)return void s("Please enter an address","error");if(!i.match(/^0x[a-fA-F0-9]{40}$/))return void s("Invalid Ethereum address","error");const a=e.getCurrentChannel();if(a)try{t("Adding member (on-chain transaction)..."),await e.addMember(a.streamId,i),n(),this.elements.addMemberInput.value="",s("Member added successfully!","success"),await this.loadMembers()}catch(e){n(),s("Failed to add member: "+e.message,"error")}}async handleBatchAddMembers(){const{channelManager:e,showLoading:t,hideLoading:n,showNotification:s}=this.deps,i=(this.elements.batchMembersInput?.value||"").split("\n").map(e=>e.trim()).filter(e=>e);if(0===i.length)return void s("Please enter at least one address","error");const a=[],r=[];for(const e of i)e.match(/^0x[a-fA-F0-9]{40}$/)?a.push(e):r.push(e);if(r.length>0)return void s(`${r.length} invalid address(es) found`,"error");const o=e.getCurrentChannel();if(o)try{t(`Adding ${a.length} members (on-chain transactions)...`);let i=0,r=0;for(const t of a)try{await e.addMember(o.streamId,t),i++}catch(e){d.V.error("Failed to add:",t,e),r++}n(),this.elements.batchMembersInput.value="",r>0?s(`Added ${i} members, ${r} failed`,"warning"):s(`${i} members added successfully!`,"success"),await this.loadMembers()}catch(e){n(),s("Failed to add members: "+e.message,"error")}}showRemoveMemberModal(e){const t=`${e.slice(0,8)}...${e.slice(-6)}`;this.hideRemoveMemberModal();const n=document.createElement("div");n.id="remove-member-modal",n.className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[70]",n.innerHTML=`\n            <div class="bg-[#141414] rounded-2xl w-[380px] max-w-[95vw] mx-4 shadow-2xl border border-white/5 overflow-hidden">\n                <div class="p-6">\n                    <div class="flex items-center gap-3 mb-4">\n                        <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center text-lg"></div>\n                        <h3 class="text-lg font-medium text-white/90">Remove Member</h3>\n                    </div>\n                    <p class="text-sm text-white/50 mb-2">\n                        Remove <span class="text-white/80 font-mono">${t}</span> from this channel?\n                    </p>\n                    <p class="text-xs text-white/30 bg-white/5 rounded-lg px-3 py-2">\n                        This will revoke their access via an on-chain transaction.\n                    </p>\n                </div>\n                <div class="flex border-t border-white/5">\n                    <button id="cancel-remove-member-btn" class="flex-1 px-4 py-3 text-sm text-white/60 hover:text-white hover:bg-white/5 transition">\n                        Cancel\n                    </button>\n                    <button id="confirm-remove-member-btn" class="flex-1 px-4 py-3 text-sm text-red-400 hover:text-red-300 hover:bg-red-500/10 border-l border-white/5 transition" data-address="${(0,g.dc)(e)}">\n                        Remove\n                    </button>\n                </div>\n            </div>\n        `,document.body.appendChild(n),n.querySelector("#cancel-remove-member-btn").addEventListener("click",()=>this.hideRemoveMemberModal()),n.querySelector("#confirm-remove-member-btn").addEventListener("click",e=>{const t=e.currentTarget.dataset.address;this.hideRemoveMemberModal(),this.executeRemoveMember(t)}),n.addEventListener("click",e=>{e.target===n&&this.hideRemoveMemberModal()})}hideRemoveMemberModal(){const e=document.getElementById("remove-member-modal");e&&e.remove()}async executeRemoveMember(e){const{channelManager:t,showLoading:n,hideLoading:s,showNotification:i}=this.deps,a=t.getCurrentChannel();if(a)try{n("Removing member (on-chain transaction)..."),await t.removeMember(a.streamId,e),s(),i("Member removed successfully!","success"),await this.loadMembers()}catch(e){s(),i("Failed to remove member: "+e.message,"error")}}async loadPermissions(){const{channelManager:e}=this.deps,t=e.getCurrentChannel();if(t&&"native"===t.type&&this.elements.permissionsList){this.elements.permissionsList.innerHTML='<div class="text-white/30">Loading...</div>';try{const{graphAPI:e}=await Promise.resolve().then(n.bind(n,7482));let s=[];try{s=await e.getStreamPermissions(t.streamId)}catch(e){d.V.debug("Could not fetch permissions from The Graph:",e.message)}if(0===s.length){const e=t.members||[],n=t.createdBy;let s="";n&&(s+=`<div class="flex justify-between items-center py-1.5 px-2.5 bg-white/5 rounded-lg">\n                        <span class="font-mono text-white/60">${n.slice(0,8)}...${n.slice(-4)}</span>\n                        <span class="text-xs text-yellow-400/80">Owner</span>\n                    </div>`);for(const t of e)s+=`<div class="flex justify-between items-center py-1.5 px-2.5 bg-white/5 rounded-lg">\n                        <span class="font-mono text-white/60">${t.slice(0,8)}...${t.slice(-4)}</span>\n                        <span class="text-white/40 flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></span>\n                    </div>`;s||(s='<div class="text-white/30">Owner only (private)</div>');const i='<div class="text-white/20 mt-2 pt-2 border-t border-white/5 text-[10px] flex items-center gap-1">\n                    <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/></svg>\n                    Showing local cache. Check Stream Explorer for on-chain permissions.\n                </div>';return void(this.elements.permissionsList.innerHTML=s+i)}const i=t.createdBy?.toLowerCase(),a=Math.floor(Date.now()/1e3),r=s.map(e=>{let t,n=!1;const s=e.userAddress;if(s&&"0x0000000000000000000000000000000000000000"!==s){const e=`${s.slice(0,8)}...${s.slice(-4)}`;n=i&&s.toLowerCase()===i,t=`<span class="font-mono text-white/60">${e}${n?' <span class="text-yellow-400/80"><svg class="w-3 h-3 inline" fill="currentColor" viewBox="0 0 24 24"><path d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"/></svg></span>':""}</span>`}else t='<span class="text-yellow-400/80 inline-flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3"/></svg>PUBLIC</span>';const r=[];return(null===e.subscribeExpiration||parseInt(e.subscribeExpiration)>a)&&r.push('<svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>'),(null===e.publishExpiration||parseInt(e.publishExpiration)>a)&&r.push('<svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>'),e.canEdit&&r.push('<svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>'),e.canDelete&&r.push('<svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>'),e.canGrant&&r.push('<svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/></svg>'),`<div class="flex justify-between items-center py-1.5 px-2.5 bg-white/5 rounded-lg">\n                    <span>${t}</span>\n                    <span class="text-white/40">${r.join(" ")}</span>\n                </div>`}).join(""),o='<div class="text-white/20 mt-2 pt-2 border-t border-white/5 text-[10px] flex items-center gap-2 flex-wrap">\n                <span class="flex items-center gap-0.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>sub</span>\n                <span class="flex items-center gap-0.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>pub</span>\n                <span class="flex items-center gap-0.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>edit</span>\n                <span class="flex items-center gap-0.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>del</span>\n                <span class="flex items-center gap-0.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/></svg>grant</span>\n            </div>';this.elements.permissionsList.innerHTML=r+o}catch(e){this.elements.permissionsList.innerHTML=`<div class="text-red-400/80 text-sm">Error: ${e.message}</div>`}}}},F=new class{constructor(){this.deps=null,this.elements=null,this.contextMenuTarget=null}setDependencies(e){this.deps=e}setElements(e){this.elements=e}init(){this.elements.contactsModal=document.getElementById("contacts-modal"),this.elements.contactsList=document.getElementById("contacts-list"),this.elements.addContactBtn=document.getElementById("add-contact-btn"),this.elements.addContactAddress=document.getElementById("add-contact-address"),this.elements.addContactNickname=document.getElementById("add-contact-nickname"),this.elements.closeContactsBtn=document.getElementById("close-contacts-btn"),this.elements.contextMenu=document.getElementById("message-context-menu"),this.elements.addContactBtn&&this.elements.addContactBtn.addEventListener("click",()=>this.handleAddContact()),this.elements.closeContactsBtn&&this.elements.closeContactsBtn.addEventListener("click",()=>this.hide()),this.elements.contextMenu&&(document.addEventListener("click",()=>this.hideContextMenu()),this.elements.contextMenu.querySelectorAll(".context-menu-item").forEach(e=>{e.addEventListener("click",e=>this.handleContextMenuAction(e))})),document.addEventListener("contextmenu",e=>this.handleMessageRightClick(e))}show(){this.elements.contactsModal||this.init(),this.renderList(),T.show("contacts-modal")}hide(){T.hide("contacts-modal"),this.elements.addContactAddress&&(this.elements.addContactAddress.value=""),this.elements.addContactNickname&&(this.elements.addContactNickname.value="")}renderList(){const{identityManager:e}=this.deps,t=e.getAllTrustedContacts();0!==t.length?(this.elements.contactsList.innerHTML=t.map(e=>`\n                <div class="flex items-center justify-between p-3 bg-[#1a1a1a] border border-[#282828] rounded-lg">\n                    <div class="flex items-center gap-3 flex-1 min-w-0">\n                        <div class="flex-shrink-0" style="width:32px;height:32px;border-radius:6px;overflow:hidden;">${(0,b.Y0)(e.address,32,.22)}</div>\n                        <div class="flex-1 min-w-0">\n                            <span class="text-[13px] font-medium text-white truncate block">${(0,g.ZD)(e.nickname)}</span>\n                            <div class="text-[10px] text-[#666] font-mono truncate mt-0.5">${e.address}</div>\n                        </div>\n                    </div>\n                    <button \n                        class="remove-contact-btn ml-2 text-[#555] hover:text-red-400 p-1.5 transition"\n                        data-address="${(0,g.dc)(e.address)}"\n                        title="Remove contact"\n                    >\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                        </svg>\n                    </button>\n                </div>\n            `).join(""),this.elements.contactsList.querySelectorAll(".remove-contact-btn").forEach(e=>{e.addEventListener("click",async e=>{const t=e.currentTarget.dataset.address;this.deps.showRemoveContactModal(t,()=>{this.renderList()})})})):this.elements.contactsList.innerHTML='\n                <div class="text-center text-[#555] py-8 text-[13px]">No trusted contacts yet</div>\n            '}async handleAddContact(){const{identityManager:e,showNotification:t,showLoading:n,hideLoading:s}=this.deps,i=this.elements.addContactAddress?.value.trim(),a=this.elements.addContactNickname?.value.trim();if(i)try{let r=i;if(i.endsWith(".eth")&&(n("Resolving ENS..."),r=await e.resolveAddress(i),s(),!r))return void t("Could not resolve ENS name","error");if(!r.match(/^0x[a-fA-F0-9]{40}$/))return void t("Invalid Ethereum address","error");await e.addTrustedContact(r,a||null),this.renderList(),t("Contact added!","success"),this.elements.addContactAddress.value="",this.elements.addContactNickname.value=""}catch(e){s(),t("Failed to add contact: "+e.message,"error")}else t("Please enter an address or ENS name","error")}handleMessageRightClick(e){const{Logger:t}=this.deps,n=e.target.closest(".message-entry");if(!n||!this.elements.messagesArea?.contains(n))return;e.preventDefault();const s=n.dataset.sender;s?(this.contextMenuTarget={element:n,sender:s},this.showContextMenu(e.clientX,e.clientY)):t.warn("No sender address found for message")}showContextMenu(e,t){if(this.elements.contextMenu||this.init(),this.elements.contextMenu){this.elements.contextMenu.style.visibility="hidden",this.elements.contextMenu.classList.remove("hidden");const n=this.elements.contextMenu.offsetWidth,s=this.elements.contextMenu.offsetHeight,i=window.innerWidth,a=window.innerHeight;e+n>i-10&&(e=i-n-10),t+s>a-10&&(t=a-s-10),e=Math.max(10,e),t=Math.max(10,t),this.elements.contextMenu.style.left=`${e}px`,this.elements.contextMenu.style.top=`${t}px`,this.elements.contextMenu.style.visibility="visible"}}hideContextMenu(){this.elements.contextMenu?.classList.add("hidden")}async handleContextMenuAction(e){const{showNotification:t,showAddContactModal:n,showRemoveContactModal:s}=this.deps,i=e.currentTarget.dataset.action,a=this.contextMenuTarget;if(!a?.sender)return void this.hideContextMenu();const r=a.sender;switch(this.hideContextMenu(),i){case"add-contact":n(r);break;case"copy-address":try{await navigator.clipboard.writeText(r),t("Address copied!","success")}catch{t("Failed to copy","error")}break;case"remove-contact":s(r)}}},R=new class{constructor(){this.elements={},this.currentFilter="all",this.channelManager=null,this.secureStorage=null,this.onChannelSelect=null}setDependencies({channelManager:e,secureStorage:t,onChannelSelect:n}){this.channelManager=e,this.secureStorage=t,this.onChannelSelect=n}setElements(e){this.elements=e}setFilter(e){this.currentFilter=e}getFilter(){return this.currentFilter}render(){if(!this.channelManager||!this.elements.channelList)return void d.V.warn("ChannelListUI: Missing dependencies or elements");let e=this.channelManager.getAllChannels();if(d.V.debug("ChannelListUI.render - Total channels:",e.length),e=this._applyFilter(e),0===e.length)return void this._renderEmptyState();const t=this.secureStorage.getChannelOrder();t.length>0&&(e=this._sortByOrder(e,t));const n=this.channelManager.getCurrentChannel(),s=n?.streamId;this.elements.channelList.innerHTML=e.map(e=>this._renderChannelItem(e,s)).join(""),this._attachClickListeners(),this._setupDragAndDrop(),d.V.debug("ChannelListUI: Render complete")}_applyFilter(e){switch(this.currentFilter){case"personal":return e.filter(e=>"native"===e.type&&"personal"===e.classification);case"community":return e.filter(e=>"native"!==e.type||"community"===e.classification);default:return e}}_renderEmptyState(){const e="all"===this.currentFilter?"No channels yet":`No ${this.currentFilter} channels`;this.elements.channelList.innerHTML=`\n            <div class="p-4 text-center text-[#555] text-[13px]">\n                ${e}\n            </div>\n        `,d.V.debug("ChannelListUI: No channels to render")}_renderChannelItem(e,t){const n=this.secureStorage.getChannelLastAccess(e.streamId)||0,s=e.messages.filter(e=>e.timestamp>n).length,i=s>0,a=i?"text-white bg-[#F6851B]/20":"text-[#666] bg-[#252525]",r=i?s>=30?"+30":s:"";return`\n            <div\n                class="channel-item px-3 py-3 mx-2 rounded-lg cursor-pointer bg-[#151515] border border-[#222] hover:bg-[#1e1e1e] hover:border-[#333] transition group ${e.streamId===t?"border-l-2 border-l-[#F6851B] bg-[#1a1a1a]":"border-l-2 border-l-transparent"}"\n                data-stream-id="${(0,g.dc)(e.streamId)}"\n                draggable="true"\n            >\n                <div class="flex items-center justify-between">\n                    \x3c!-- Drag handle (6 dots) - visible on hover --\x3e\n                    <div class="drag-handle flex-shrink-0 mr-2 cursor-grab opacity-0 group-hover:opacity-100 transition-opacity text-[#555] hover:text-[#888]" title="Drag to reorder">\n                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">\n                            <circle cx="8" cy="6" r="1.5"/>\n                            <circle cx="16" cy="6" r="1.5"/>\n                            <circle cx="8" cy="12" r="1.5"/>\n                            <circle cx="16" cy="12" r="1.5"/>\n                            <circle cx="8" cy="18" r="1.5"/>\n                            <circle cx="16" cy="18" r="1.5"/>\n                        </svg>\n                    </div>\n                    <div class="flex-1 min-w-0 pl-1">\n                        <h3 class="text-[13px] font-medium text-white truncate">${(0,g.ZD)(e.name)}</h3>\n                    </div>\n                    <div class="flex items-center gap-1.5 ml-2">\n                        ${i?`<span class="channel-msg-count text-[10px] ${a} px-1.5 py-0.5 rounded" data-channel-count="${(0,g.dc)(e.streamId)}">${r}</span>`:`<span class="channel-msg-count text-[10px] text-[#666] bg-[#252525] px-1.5 py-0.5 rounded hidden" data-channel-count="${(0,g.dc)(e.streamId)}">0</span>`}\n                        <svg class="w-3.5 h-3.5 text-[#444]" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.25 4.5l7.5 7.5-7.5 7.5"></path>\n                        </svg>\n                    </div>\n                </div>\n            </div>\n        `}_sortByOrder(e,t){const n=new Map(t.map((e,t)=>[e,t]));return[...e].sort((e,t)=>(n.has(e.streamId)?n.get(e.streamId):1/0)-(n.has(t.streamId)?n.get(t.streamId):1/0))}_attachClickListeners(){document.querySelectorAll(".channel-item").forEach(e=>{e.addEventListener("click",e=>{if(e.target.closest(".drag-handle"))return;const t=e.currentTarget.dataset.streamId;d.V.debug("ChannelListUI: Channel clicked:",t),this.onChannelSelect&&this.onChannelSelect(t)})})}_setupDragAndDrop(){const e=document.querySelectorAll(".channel-item");let t=null,n=null;e.forEach(e=>{e.addEventListener("dragstart",s=>{t=e,n=e.dataset.streamId,e.classList.add("dragging"),s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/plain",n),setTimeout(()=>{e.style.opacity="0.5"},0)}),e.addEventListener("dragend",()=>{e.classList.remove("dragging"),e.style.opacity="",t=null,n=null,document.querySelectorAll(".channel-item").forEach(e=>{e.classList.remove("drag-over")})}),e.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.dropEffect="move",e!==t&&e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",async s=>{if(s.preventDefault(),e.classList.remove("drag-over"),!t||e===t)return;const i=e.dataset.streamId;await this._handleDrop(n,i)})})}async _handleDrop(e,t){let n=this.secureStorage.getChannelOrder();const s=this.channelManager.getAllChannels();0===n.length&&(n=s.map(e=>e.streamId)),s.forEach(e=>{n.includes(e.streamId)||n.push(e.streamId)});const i=n.indexOf(e),a=n.indexOf(t);-1!==i&&-1!==a&&(n.splice(i,1),n.splice(a,0,e),await this.secureStorage.setChannelOrder(n),this.render(),d.V.debug("ChannelListUI: Channel order updated"))}updateUnreadBadge(e,t){const n=document.querySelector(`[data-channel-count="${e}"]`);n&&(t>0?(n.textContent=t>=30?"+30":t,n.classList.remove("hidden","text-[#666]","bg-[#252525]"),n.classList.add("text-white","bg-[#F6851B]/20")):(n.textContent="0",n.classList.add("hidden"),n.classList.remove("text-white","bg-[#F6851B]/20"),n.classList.add("text-[#666]","bg-[#252525]")))}setActiveChannel(e){document.querySelectorAll(".channel-item").forEach(t=>{const n=t.dataset.streamId===e;t.classList.toggle("border-l-[#F6851B]",n),t.classList.toggle("bg-[#1a1a1a]",n),t.classList.toggle("border-l-transparent",!n)})}},O=new class{constructor(){this.elements={},this.isLoadingMore=!1,this.scrollThreshold=100,this.replyingTo=null,this.isSending=!1,this.currentChannelFilter="all",this.previewChannel=null,this._setupModuleCallbacks()}_setupModuleCallbacks(){f.setDependencies({getCurrentAddress:()=>i.s.getAddress(),onSendReaction:(e,t,n)=>{const i=s.L.getCurrentChannel();i&&s.L.sendReaction(i.streamId,e,t,n)}}),x.setDependencies({getCurrentAddress:()=>i.s.getAddress(),onUserMenuAction:(e,t)=>this.handleUserMenuAction(e,t)}),C.setDependencies({onChannelMenuAction:e=>this.handleChannelMenuAction(e)}),L.setDependencies({showNotification:(e,t)=>this.showNotification(e,t)}),$.setDependencies({getCurrentAddress:()=>i.s.getAddress(),getMessageReactions:e=>f.getReactions(e),registerMedia:(e,t)=>this.registerMedia(e,t),getImage:e=>c.F.getImage(e),cacheImage:(e,t)=>c.F.cacheImage(e,t),requestImage:(e,t,n)=>c.F.requestImage(e,t,n),getCurrentChannel:()=>s.L.getCurrentChannel(),getFileUrl:e=>c.F.getFileUrl(e),isSeeding:e=>c.F.isSeeding(e),isVideoPlayable:e=>c.F.isVideoPlayable(e)}),V.setDependencies({authManager:i.s,secureStorage:l.Z,channelManager:s.L,streamrController:h.xA,mediaController:c.F,identityManager:a.E,graphAPI:o.graphAPI,Logger:d.V,modalManager:T,showNotification:(e,t)=>this.showNotification(e,t),updateWalletInfo:(e,t)=>this.updateWalletInfo(e,t),updateNetworkStatus:(e,t)=>this.updateNetworkStatus(e,t),renderChannelList:()=>this.renderChannelList(),resetToDisconnectedState:()=>this.resetToDisconnectedState()}),D.setDependencies({getPublicChannels:()=>s.L.getPublicChannels(),joinPublicChannel:(e,t)=>this.joinPublicChannel(e,t),enterPreviewMode:(e,t)=>this.enterPreviewMode(e,t),getNsfwEnabled:()=>l.Z.getNsfwEnabled()}),N.setDependencies({channelManager:s.L,streamrController:h.xA,authManager:i.s,subscriptionManager:u.D,showNotification:(e,t)=>this.showNotification(e,t),showLoading:e=>this.showLoading(e),hideLoading:()=>this.hideLoading(),getChannelTypeLabel:(e,t)=>this.getChannelTypeLabel(e,t),renderChannelList:()=>this.renderChannelList(),selectChannel:e=>this.selectChannel(e),showConnectedNoChannelState:()=>this.showConnectedNoChannelState()}),F.setDependencies({identityManager:a.E,Logger:d.V,showNotification:(e,t)=>this.showNotification(e,t),showLoading:e=>this.showLoading(e),hideLoading:()=>this.hideLoading(),showAddContactModal:e=>this.showAddContactModal(e),showRemoveContactModal:(e,t)=>this.showRemoveContactModal(e,t)}),R.setDependencies({channelManager:s.L,secureStorage:l.Z,onChannelSelect:e=>this.selectChannel(e)})}registerMedia(e,t="image"){return L.registerMedia(e,t)}openLightboxById(e){L.openLightboxById(e)}init(){this.elements={walletInfo:document.getElementById("wallet-info"),connectWalletBtn:document.getElementById("connect-wallet"),disconnectWalletBtn:document.getElementById("disconnect-wallet"),walletControls:document.getElementById("wallet-controls"),switchWalletBtn:document.getElementById("switch-wallet"),contactsBtn:document.getElementById("contacts-btn"),channelList:document.getElementById("channel-list"),newChannelBtn:document.getElementById("new-channel-btn"),chatHeader:document.getElementById("chat-header"),currentChannelName:document.getElementById("current-channel-name"),currentChannelInfo:document.getElementById("current-channel-info"),channelMenuBtn:document.getElementById("channel-menu-btn"),closeChannelBtn:document.getElementById("close-channel-btn"),messagesArea:document.getElementById("messages-area"),messageInput:document.getElementById("message-input"),messageInputContainer:document.getElementById("message-input-container"),sendMessageBtn:document.getElementById("send-message-btn"),newChannelModal:document.getElementById("new-channel-modal"),channelNameInput:document.getElementById("channel-name-input"),channelPasswordInput:document.getElementById("channel-password-input"),channelMembersInput:document.getElementById("channel-members-input"),passwordField:document.getElementById("password-field"),membersField:document.getElementById("members-field"),exposureSection:document.getElementById("exposure-section"),visibleFields:document.getElementById("visible-fields"),channelDescriptionInput:document.getElementById("channel-description-input"),channelLanguageInput:document.getElementById("channel-language-input"),channelCategoryInput:document.getElementById("channel-category-input"),createChannelBtn:document.getElementById("create-channel-btn"),cancelChannelBtn:document.getElementById("cancel-channel-btn"),onlineHeader:document.getElementById("online-header"),onlineSeparator:document.getElementById("online-separator"),onlineUsersCount:document.getElementById("online-users-count"),onlineUsersList:document.getElementById("online-users-list"),joinChannelModal:document.getElementById("join-channel-modal"),joinStreamIdInput:document.getElementById("join-stream-id-input"),joinPasswordInput:document.getElementById("join-password-input"),joinPasswordField:document.getElementById("join-password-field"),joinBtn:document.getElementById("join-btn"),cancelJoinBtn:document.getElementById("cancel-join-btn"),joinChannelBtn:document.getElementById("join-channel-btn"),inviteUsersBtn:document.getElementById("invite-users-btn"),inviteUsersModal:document.getElementById("invite-users-modal"),inviteAddressInput:document.getElementById("invite-address-input"),inviteLinkDisplay:document.getElementById("invite-link-display"),copyInviteLinkBtn:document.getElementById("copy-invite-link-btn"),showQrBtn:document.getElementById("show-qr-btn"),sendInviteBtn:document.getElementById("send-invite-btn"),cancelInviteBtn:document.getElementById("cancel-invite-btn"),channelInfoBtn:document.getElementById("channel-info-btn"),channelSettingsModal:document.getElementById("channel-settings-modal"),channelSettingsName:document.getElementById("channel-settings-name"),channelSettingsType:document.getElementById("channel-settings-type"),channelSettingsId:document.getElementById("channel-settings-id"),copyStreamIdBtn:document.getElementById("copy-stream-id-btn"),membersSection:document.getElementById("members-section"),nonNativeMessage:document.getElementById("non-native-message"),refreshMembersBtn:document.getElementById("refresh-members-btn"),addMemberForm:document.getElementById("add-member-form"),addMemberInput:document.getElementById("add-member-input"),addMemberBtn:document.getElementById("add-member-btn"),batchMembersInput:document.getElementById("batch-members-input"),batchAddMembersBtn:document.getElementById("batch-add-members-btn"),membersList:document.getElementById("members-list"),permissionsSection:document.getElementById("permissions-section"),permissionsList:document.getElementById("permissions-list"),refreshPermissionsBtn:document.getElementById("refresh-permissions-btn"),closeChannelSettingsBtn:document.getElementById("close-channel-settings-btn"),dangerTabDivider:document.getElementById("danger-tab-divider"),dangerTabBtn:document.getElementById("danger-tab-btn"),deleteChannelSection:document.getElementById("delete-channel-section"),deleteChannelBtn:document.getElementById("delete-channel-btn"),channelSettingsTabs:document.querySelectorAll(".channel-settings-tab"),channelSettingsPanels:document.querySelectorAll(".channel-settings-panel"),deleteChannelModal:document.getElementById("delete-channel-modal"),deleteChannelName:document.getElementById("delete-channel-name"),cancelDeleteBtn:document.getElementById("cancel-delete-btn"),confirmDeleteBtn:document.getElementById("confirm-delete-btn"),quickJoinInput:document.getElementById("quick-join-input"),quickJoinHash:document.getElementById("quick-join-hash"),browseChannelsBtn:document.getElementById("browse-channels-btn"),browseBtnIcon:document.getElementById("browse-btn-icon"),browseBtnText:document.getElementById("browse-btn-text"),replyBar:document.getElementById("reply-bar"),replyToName:document.getElementById("reply-to-name"),replyToText:document.getElementById("reply-to-text"),replyBarClose:document.getElementById("reply-bar-close"),sidebar:document.getElementById("sidebar"),chatArea:document.getElementById("chat-area"),closeChannelBtnDesktop:document.getElementById("close-channel-btn-desktop"),chatHeaderRight:document.getElementById("chat-header-right"),exploreTypeTabs:document.getElementById("explore-type-tabs")},N.setElements(this.elements),F.setElements(this.elements),R.setElements(this.elements),this.setupEventListeners(),this.setupActivityHandler(),m.init(e=>this.navigateToState(e)),d.V.info("UI Controller initialized")}setupActivityHandler(){u.D.onActivity((e,t)=>{d.V.debug("Background activity update:",e,t);const n=document.querySelector(`[data-channel-count="${e}"]`);n&&t.unreadCount>0&&(n.textContent=t.unreadCount>=30?"+30":t.unreadCount,n.classList.remove("hidden","text-[#666]","bg-[#252525]"),n.classList.add("text-white","bg-[#F6851B]/20"))})}setupEventListeners(){this.elements.newChannelBtn.addEventListener("click",()=>{this.showNewChannelModal()}),document.querySelectorAll(".channel-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;this.switchChannelTab(t)})}),document.getElementById("visibility-toggle")?.addEventListener("click",()=>{this.toggleVisibility()}),document.querySelectorAll(".classification-tab").forEach(e=>{e.addEventListener("click",()=>{this.switchClassificationTab(e.dataset.classification)})}),document.querySelectorAll(".join-classification-tab").forEach(e=>{e.addEventListener("click",()=>{this.switchJoinClassificationTab(e.dataset.joinClassification)})}),document.querySelectorAll(".channel-filter-tab").forEach(e=>{e.addEventListener("click",()=>{this.switchChannelFilterTab(e.dataset.channelFilter)})});const e=document.getElementById("read-only-toggle");e?.addEventListener("click",()=>{this.toggleReadOnly()}),this.currentStorageProvider="streamr",document.querySelectorAll(".storage-provider-tab").forEach(e=>{e.addEventListener("click",()=>{this.selectStorageProvider(e.dataset.storage)})});const t=document.getElementById("storage-days-input");t?.addEventListener("input",()=>{this.updateStorageDaysDisplay(t.value)}),this.elements.onlineHeader?.addEventListener("click",()=>{this.elements.onlineUsersList?.classList.toggle("hidden")}),document.addEventListener("click",e=>{const t=this.elements.onlineHeader?.contains(e.target),n=this.elements.onlineUsersList?.contains(e.target);t||n||this.elements.onlineUsersList?.classList.add("hidden")}),this.elements.createChannelBtn.addEventListener("click",()=>{this.handleCreateChannel()}),this.elements.cancelChannelBtn.addEventListener("click",()=>{this.hideNewChannelModal()}),document.getElementById("cancel-channel-btn-footer")?.addEventListener("click",()=>{this.hideNewChannelModal()}),document.querySelectorAll(".channel-info-help-btn").forEach(e=>{e.addEventListener("click",()=>{T.show("channel-types-modal")})}),document.getElementById("close-channel-types-btn")?.addEventListener("click",()=>{T.hide("channel-types-modal")}),document.getElementById("close-channel-types-btn-footer")?.addEventListener("click",()=>{T.hide("channel-types-modal")}),document.querySelectorAll(".storage-learn-more-btn").forEach(e=>{e.addEventListener("click",()=>{T.show("storage-info-modal")})}),document.getElementById("close-storage-info-btn")?.addEventListener("click",()=>{T.hide("storage-info-modal")}),document.getElementById("close-storage-info-btn-footer")?.addEventListener("click",()=>{T.hide("storage-info-modal")}),this.elements.quickJoinInput?.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleQuickJoin()}),this.elements.quickJoinInput?.addEventListener("input",e=>{this.updateBrowseJoinButton(),this.updateQuickJoinHash()}),this.elements.browseChannelsBtn?.addEventListener("click",()=>{const e=this.elements.quickJoinInput?.value.trim();e?this.handleQuickJoin():this.openExploreView()}),this.elements.joinBtn?.addEventListener("click",()=>{this.handleJoinChannel()}),this.elements.cancelJoinBtn?.addEventListener("click",()=>{this.hideJoinChannelModal()}),document.getElementById("join-closed-btn")?.addEventListener("click",()=>{this.handleJoinClosedChannel()}),document.getElementById("cancel-join-closed-btn")?.addEventListener("click",()=>{this.hideJoinClosedChannelModal()}),document.getElementById("switch-to-closed-join-btn")?.addEventListener("click",()=>{const e=this.elements.joinStreamIdInput?.value.trim()||"";this.hideJoinChannelModal(),this.showJoinClosedChannelModal(e)});const n=document.getElementById("join-has-password");let i;n?.addEventListener("change",e=>{this.elements.joinPasswordField?.classList.toggle("hidden",!e.target.checked)}),this.elements.sendMessageBtn.addEventListener("click",()=>{this.handleSendMessage()}),this.elements.messageInput.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.handleSendMessage()),"Escape"===e.key&&this.replyingTo&&this.cancelReply()}),this.elements.replyBarClose?.addEventListener("click",()=>{this.cancelReply()}),this.elements.messagesArea?.addEventListener("scroll",()=>{this.handleMessagesScroll()}),this.elements.messagesArea?.addEventListener("click",e=>{const t=e.target.closest(".message-entry");e.target.closest(".reply-trigger, .react-trigger, .reaction-badge")||(document.querySelectorAll(".message-entry.message-active").forEach(e=>{e!==t&&e.classList.remove("message-active")}),t&&t.classList.toggle("message-active"))}),this.elements.messageInput.addEventListener("input",()=>{const e=this.elements.messageInput;e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px"});let a=0;this.elements.messageInput.addEventListener("input",()=>{const e=Date.now();if(e-a>2e3){const t=s.L.getCurrentChannel();t&&s.L.sendTypingIndicator(t.streamId),a=e}clearTimeout(i),i=setTimeout(()=>{},3e3)}),this.elements.inviteUsersBtn.addEventListener("click",()=>{this.showInviteModal()}),this.elements.joinChannelBtn?.addEventListener("click",()=>{this.addPreviewToList()}),this.elements.sendInviteBtn.addEventListener("click",()=>{this.handleSendInvite()}),this.elements.cancelInviteBtn.addEventListener("click",()=>{this.hideInviteModal()}),document.querySelectorAll(".invite-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.inviteTab;this.switchInviteTab(t)})}),this.elements.copyInviteLinkBtn.addEventListener("click",()=>{this.copyInviteLink()}),this.elements.showQrBtn.addEventListener("click",()=>{this.showInviteQR()}),this.elements.contactsBtn&&this.elements.contactsBtn.addEventListener("click",()=>{this.showContactsModal()}),this.elements.channelMenuBtn&&this.elements.channelMenuBtn.addEventListener("click",e=>{e.stopPropagation(),this.showChannelDropdown(e)}),this.elements.closeChannelBtn&&this.elements.closeChannelBtn.addEventListener("click",async()=>{s.L.getCurrentChannel()&&await this.deselectChannel(),this.closeChatView()}),this.elements.closeChannelBtnDesktop&&this.elements.closeChannelBtnDesktop.addEventListener("click",async()=>{await this.deselectChannel()}),this.elements.closeChannelSettingsBtn&&this.elements.closeChannelSettingsBtn.addEventListener("click",()=>{this.hideChannelSettingsModal()}),this.elements.channelSettingsModal&&this.elements.channelSettingsModal.addEventListener("click",e=>{e.target===this.elements.channelSettingsModal&&this.hideChannelSettingsModal()}),this.elements.refreshMembersBtn&&this.elements.refreshMembersBtn.addEventListener("click",()=>{this.loadChannelMembers()}),this.elements.refreshPermissionsBtn&&this.elements.refreshPermissionsBtn.addEventListener("click",()=>{this.loadStreamPermissions()}),this.elements.addMemberBtn&&this.elements.addMemberBtn.addEventListener("click",()=>{this.handleAddMember()}),this.elements.batchAddMembersBtn&&this.elements.batchAddMembersBtn.addEventListener("click",()=>{this.handleBatchAddMembers()}),this.elements.copyStreamIdBtn&&this.elements.copyStreamIdBtn.addEventListener("click",async()=>{const e=s.L.getCurrentChannel();if(e)try{await navigator.clipboard.writeText(e.streamId),this.showNotification("Stream ID copied!","success")}catch{this.showNotification("Failed to copy","error")}}),this.elements.deleteChannelBtn&&this.elements.deleteChannelBtn.addEventListener("click",()=>{this.showDeleteChannelModal()}),this.elements.cancelDeleteBtn&&this.elements.cancelDeleteBtn.addEventListener("click",()=>{this.hideDeleteChannelModal()}),this.elements.confirmDeleteBtn&&this.elements.confirmDeleteBtn.addEventListener("click",()=>{this.handleDeleteChannel()}),this.elements.deleteChannelModal&&this.elements.deleteChannelModal.addEventListener("click",e=>{e.target===this.elements.deleteChannelModal&&this.hideDeleteChannelModal()});const r=document.getElementById("cancel-add-contact-btn"),o=document.getElementById("confirm-add-contact-btn"),l=document.getElementById("add-contact-nickname-modal"),d=document.getElementById("add-contact-modal-nickname");r&&r.addEventListener("click",()=>{this.hideAddContactModal()}),o&&o.addEventListener("click",()=>{this.confirmAddContact()}),l&&l.addEventListener("click",e=>{e.target===l&&this.hideAddContactModal()}),d&&d.addEventListener("keypress",e=>{"Enter"===e.key&&this.confirmAddContact()});const c=document.getElementById("cancel-remove-contact-btn"),h=document.getElementById("confirm-remove-contact-btn"),u=document.getElementById("remove-contact-modal");c&&c.addEventListener("click",()=>{this.hideRemoveContactModal()}),h&&h.addEventListener("click",()=>{this.confirmRemoveContact()}),u&&u.addEventListener("click",e=>{e.target===u&&this.hideRemoveContactModal()}),this.elements.addMemberInput&&this.elements.addMemberInput.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleAddMember()}),this.initContactsUI(),this.initSettingsUI(),this.initEmojiPicker(),this.initAttachButton(),this.initReactions()}updateWalletInfo(e,t=!1){if(e){if(t)this.elements.walletInfo.innerHTML='<span class="text-amber-400">Guest</span>',this.elements.connectWalletBtn.classList.remove("hidden"),this.elements.connectWalletBtn.innerHTML='\n                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>\n                    </svg>\n                    Create Account\n                ',this.elements.walletControls?.classList.add("hidden"),this.elements.contactsBtn?.classList.add("hidden");else{const t=`${e.slice(0,6)}...${e.slice(-4)}`;this.elements.walletInfo.textContent=t,this.elements.connectWalletBtn.classList.add("hidden"),this.elements.walletControls?.classList.remove("hidden"),this.elements.contactsBtn?.classList.remove("hidden")}this.elements.settingsBtn?.classList.remove("hidden")}else this.elements.walletInfo.textContent="Not Connected",this.elements.connectWalletBtn.innerHTML='\n                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>\n                </svg>\n                Connect\n            ',this.elements.connectWalletBtn.classList.remove("hidden"),this.elements.walletControls?.classList.add("hidden"),this.elements.contactsBtn?.classList.add("hidden"),this.elements.settingsBtn?.classList.add("hidden")}updateSwitchWalletButton(e){e?this.elements.switchWalletBtn?.classList.remove("hidden"):this.elements.switchWalletBtn?.classList.add("hidden")}updateNetworkStatus(e,t=!1){const n=document.getElementById("network-dot");n&&(t?(n.classList.remove("bg-[#444]","bg-amber-400"),n.classList.add("bg-emerald-400")):e.toLowerCase().includes("connecting")?(n.classList.remove("bg-[#444]","bg-emerald-400"),n.classList.add("bg-amber-400")):(n.classList.remove("bg-emerald-400","bg-amber-400"),n.classList.add("bg-[#444]")))}renderChannelList(){R.setFilter(this.currentChannelFilter),R.render()}async selectChannel(e){this.hideTypingIndicator(),this.cancelReply(),this.previewChannel&&await this.exitPreviewMode(!1),this.elements.messagesArea.innerHTML="",this.elements.messagesArea?.classList.add("p-4"),s.L.setCurrentChannel(e);const t=s.L.getCurrentChannel();if(t){this.elements.joinChannelBtn?.classList.add("hidden");try{await u.D.setActiveChannel(e,t.password)}catch(e){d.V.warn("Subscribe error (may already be subscribed):",e.message)}await l.Z.setLastOpenedChannel(e),u.D.clearUnreadCount(e),this.elements.currentChannelName.textContent=t.name,this.elements.currentChannelInfo.innerHTML=this.getChannelTypeLabel(t.type,t.readOnly),this.elements.currentChannelInfo.parentElement.classList.remove("hidden"),this.elements.messageInputContainer.classList.remove("hidden"),this.elements.exploreTypeTabs?.classList.add("hidden"),this.elements.chatHeaderRight?.classList.remove("hidden"),await this.updateReadOnlyUI(t),this.elements.inviteUsersBtn.classList.remove("hidden"),this.elements.channelMenuBtn&&this.elements.channelMenuBtn.classList.remove("hidden"),this.elements.closeChannelBtn&&this.elements.closeChannelBtn.classList.remove("hidden"),this.elements.closeChannelBtnDesktop&&this.elements.closeChannelBtnDesktop.classList.remove("hidden"),this.elements.onlineHeader?.classList.remove("hidden"),this.elements.onlineHeader?.classList.add("flex"),this.elements.onlineSeparator?.classList.remove("hidden");const n=window.history.state;"channel"===n?.view?m.replaceState({view:"channel",streamId:e}):m.pushState({view:"channel",streamId:e}),this.loadChannelReactions(e),this.renderMessages(t.messages),await l.Z.setChannelLastAccess(e,Date.now()),this.renderChannelList(),s.L.startPresenceTracking(e),this.updateOnlineUsers(e,s.L.getOnlineUsers(e)),s.L.preloadDeletePermission(e),this.openChatView()}}async deselectChannel(){this.hideTypingIndicator(),this.cancelReply(),s.L.stopPresenceTracking(),this.previewChannel?await this.exitPreviewMode(!0):(await u.D.clearActiveChannel(),s.L.setCurrentChannel(null),this.elements.messageInputContainer.classList.add("hidden"),this.elements.inviteUsersBtn?.classList.add("hidden"),this.elements.joinChannelBtn?.classList.add("hidden"),this.elements.channelMenuBtn?.classList.add("hidden"),this.elements.closeChannelBtn?.classList.add("hidden"),this.elements.closeChannelBtnDesktop?.classList.add("hidden"),this.elements.onlineHeader?.classList.add("hidden"),this.elements.onlineHeader?.classList.remove("flex"),this.elements.onlineSeparator?.classList.add("hidden"),this.elements.onlineUsersList&&(this.elements.onlineUsersList.innerHTML='<div class="text-gray-400 text-sm text-center">No one online</div>'),this.elements.onlineUsersCount&&(this.elements.onlineUsersCount.textContent="0"),this.showExploreView(),document.querySelectorAll(".channel-item").forEach(e=>{e.classList.remove("bg-[#252525]")}))}resetToDisconnectedState(){this.hideTypingIndicator(),this.isSending=!1,this.elements.quickJoinInput&&(this.elements.quickJoinInput.value=""),this.updateBrowseJoinButton(),this.updateQuickJoinHash(),T.hide("channel-settings-modal"),T.hide("invite-users-modal"),T.hide("delete-channel-modal"),this.hideLeaveChannelModal(),this.elements.currentChannelName.textContent="Explore Channels",this.elements.currentChannelInfo.textContent="",this.elements.currentChannelInfo.parentElement.classList.add("hidden"),this.elements.messageInputContainer.classList.add("hidden"),this.elements.inviteUsersBtn?.classList.add("hidden"),this.elements.channelMenuBtn?.classList.add("hidden"),this.elements.closeChannelBtn?.classList.add("hidden"),this.elements.closeChannelBtnDesktop?.classList.add("hidden"),this.elements.onlineHeader?.classList.add("hidden"),this.elements.onlineHeader?.classList.remove("flex"),this.elements.onlineSeparator?.classList.add("hidden"),this.elements.onlineUsersList&&(this.elements.onlineUsersList.innerHTML='<div class="text-gray-400 text-sm text-center">No one online</div>'),this.elements.onlineUsersCount&&(this.elements.onlineUsersCount.textContent="0"),this.elements.messagesArea.innerHTML=""}showConnectedNoChannelState(){this.showExploreView()}async openExploreView(){s.L.setCurrentChannel(null),this.openChatView(),await this.showExploreView(),document.querySelectorAll(".channel-item").forEach(e=>{e.classList.remove("bg-[#252525]")}),m.pushState({view:"explore"})}async navigateToState(e){if(!e||!e.view)return this.previewChannel&&await this.exitPreviewMode(!1),void(this.isMobileView()?this.closeChatView():await this.showExploreView());switch(d.V.debug("Navigating to state:",e),e.view){case"channel":e.streamId&&(s.L.getChannel(e.streamId)?await this._selectChannelWithoutHistory(e.streamId):(this.previewChannel&&await this.exitPreviewMode(!1),this.isMobileView()?this.closeChatView():await this.showExploreView(),this.showNotification("Channel not found in your list","warning")));break;case"preview":e.streamId&&await this._enterPreviewWithoutHistory(e.streamId,e.channelInfo);break;default:this.previewChannel&&await this.exitPreviewMode(!1),this.isMobileView()?this.closeChatView():await this.showExploreView()}}async processInitialUrl(){const e=m.getInitialState();if(!e||"explore"===e.view)return await this.showExploreView(),void m.replaceState({view:"explore"});switch(d.V.info("Processing deep link:",e),e.view){case"channel":e.streamId&&(s.L.getChannel(e.streamId)?(await this._selectChannelWithoutHistory(e.streamId),m.replaceState(e)):(await this._enterPreviewWithoutHistory(e.streamId,null),m.replaceState({view:"preview",streamId:e.streamId})));break;case"preview":e.streamId&&(await this._enterPreviewWithoutHistory(e.streamId,e.channelInfo),m.replaceState(e));break;default:await this.showExploreView(),m.replaceState({view:"explore"})}}async _selectChannelWithoutHistory(e){this.hideTypingIndicator(),this.cancelReply(),this.previewChannel&&await this.exitPreviewMode(!1),this.elements.messagesArea.innerHTML="",this.elements.messagesArea?.classList.add("p-4"),s.L.setCurrentChannel(e);const t=s.L.getCurrentChannel();if(t){this.elements.joinChannelBtn?.classList.add("hidden");try{await u.D.setActiveChannel(e,t.password)}catch(e){d.V.warn("Subscribe error:",e.message)}await l.Z.setLastOpenedChannel(e),u.D.clearUnreadCount(e),this.elements.currentChannelName.textContent=t.name,this.elements.currentChannelInfo.innerHTML=this.getChannelTypeLabel(t.type,t.readOnly),this.elements.currentChannelInfo.parentElement.classList.remove("hidden"),this.elements.messageInputContainer.classList.remove("hidden"),this.elements.exploreTypeTabs?.classList.add("hidden"),this.elements.chatHeaderRight?.classList.remove("hidden"),await this.updateReadOnlyUI(t),this.elements.inviteUsersBtn.classList.remove("hidden"),this.elements.channelMenuBtn?.classList.remove("hidden"),this.elements.closeChannelBtn?.classList.remove("hidden"),this.elements.closeChannelBtnDesktop?.classList.remove("hidden"),this.elements.onlineHeader?.classList.remove("hidden"),this.elements.onlineHeader?.classList.add("flex"),this.elements.onlineSeparator?.classList.remove("hidden"),this.loadChannelReactions(e),this.renderMessages(t.messages),await l.Z.setChannelLastAccess(e,Date.now()),this.renderChannelList(),s.L.startPresenceTracking(e),this.updateOnlineUsers(e,s.L.getOnlineUsers(e)),s.L.preloadDeletePermission(e),this.openChatView()}}async _enterPreviewWithoutHistory(e,t){s.L.getChannel(e)?await this._selectChannelWithoutHistory(e):await this._enterPreviewCore(e,t,!1)}async showExploreView(){if(this.previewChannel){try{await u.D.clearPreviewChannel()}catch(e){d.V.warn("Error clearing preview:",e.message)}this.previewChannel=null}this.elements.messageInputContainer?.classList.add("hidden"),this.elements.messagesArea?.classList.remove("p-4");const e=this.isMobileView();this.elements.currentChannelName.textContent=e?"Explore":"Explore Channels",this.elements.currentChannelInfo.textContent="",this.elements.currentChannelInfo.parentElement.classList.add("hidden"),this.elements.inviteUsersBtn?.classList.add("hidden"),this.elements.joinChannelBtn?.classList.add("hidden"),this.elements.channelMenuBtn?.classList.add("hidden"),this.elements.onlineHeader?.classList.add("hidden"),this.elements.onlineSeparator?.classList.add("hidden"),e?(this.elements.closeChannelBtn?.classList.remove("hidden"),this.elements.chatHeaderRight?.classList.add("hidden")):(this.elements.closeChannelBtn?.classList.add("hidden"),this.elements.chatHeaderRight?.classList.remove("hidden")),this.elements.closeChannelBtnDesktop?.classList.add("hidden"),this.elements.exploreTypeTabs?.classList.remove("hidden");const t=l.Z.getNsfwEnabled();this.elements.messagesArea.innerHTML=D.getTemplate(t),D.setupListeners(),D.resetFilters(),await D.loadChannels()}updateOnlineUsers(e,t){const n=s.L.getCurrentChannel(),i=n&&n.streamId===e,a=this.previewChannel&&this.previewChannel.streamId===e;(i||a)&&x.updateOnlineUsers(this.elements.onlineUsersCount,this.elements.onlineUsersList,t)}attachUserMenuListeners(){x.attachUserMenuListeners()}closeUserDropdown(){x.closeUserDropdown()}showChannelDropdown(e){const t=s.L.getCurrentChannel();t&&C.showChannelDropdown(e,this.elements.channelMenuBtn,t)}closeChannelDropdown(){C.closeChannelDropdown()}async handleChannelMenuAction(e){const t=s.L.getCurrentChannel();if(t)switch(e){case"copy-stream-id":try{await navigator.clipboard.writeText(t.streamId),this.showNotification("Channel ID copied!","success")}catch{this.showNotification("Failed to copy","error")}break;case"channel-settings":this.showChannelSettingsModal();break;case"leave-channel":this.showLeaveChannelModal()}}async handleUserMenuAction(e,t){switch(e){case"copy-address":try{await navigator.clipboard.writeText(t),this.showNotification("Address copied!","success")}catch{this.showNotification("Failed to copy","error")}break;case"add-contact":this.showAddContactModal(t);break;case"start-dm":this.showNotification("DM feature coming soon!","info")}}formatAddress(e){return(0,g.M0)(e)}escapeHtml(e){return(0,g.ZD)(e)}escapeAttr(e){return(0,g.dc)(e)}isValidMediaUrl(e){return(0,g.cP)(e)}loadChannelReactions(e){const t=s.L.getChannelReactions(e);f.loadFromChannelState(t)}async handleMessagesScroll(){const e=this.elements.messagesArea;if(!e)return;if(e.scrollTop>this.scrollThreshold)return;if(this.isLoadingMore)return;const t=s.L.getCurrentChannel();if(!t||!t.hasMoreHistory)return;this.isLoadingMore=!0,this.showLoadingMoreIndicator();const n=e.scrollHeight,i=e.scrollTop;try{if((await s.L.loadMoreHistory(t.streamId)).loaded>0){this.renderMessages(t.messages);const s=e.scrollHeight-n;e.scrollTop=i+s}this.hideLoadingMoreIndicator()}catch(e){d.V.error("Failed to load more messages:",e),this.hideLoadingMoreIndicator()}this.isLoadingMore=!1}showLoadingMoreIndicator(){v.showLoadingMoreIndicator(this.elements.messagesArea)}hideLoadingMoreIndicator(){v.hideLoadingMoreIndicator()}renderMessages(e){const t=s.L.getCurrentChannel(),n=!1!==t?.hasMoreHistory;if(0===e.length)return void(this.elements.messagesArea.innerHTML='\n                <div class="flex items-center justify-center h-full text-gray-500">\n                    No messages yet. Start the conversation!\n                </div>\n            ');const a=i.s.getAddress();let r=null,o="";n||(o='\n                <div class="flex justify-center py-4">\n                    <div class="text-[#444] text-xs">\n                         beginning of conversation \n                    </div>\n                </div>\n            ');const l=function(e){if(!e||0===e.length)return[];const t=new Array(e.length);for(let n=0;n<e.length;n++){const s=n>0?e[n-1]:null,i=e[n],a=n<e.length-1?e[n+1]:null,r=M(s,i),o=M(i,a);t[n]=r||o?!r&&o?E:r&&o?k:S:I}return t}(e),d=function(e,t){if(!e||0===e.length)return[];const n=new Array(e.length),s=t?.toLowerCase();for(let t=0;t<e.length;t++){if(0===t){n[t]=null;continue}const i=e[t-1],a=e[t],r=i.sender?.toLowerCase()===s==(a.sender?.toLowerCase()===s);i.sender?.toLowerCase()===a.sender?.toLowerCase()&&M(i,a)?n[t]=A:n[t]=r?P:B}return n}(e,a);this.elements.messagesArea.innerHTML=e.map((e,t)=>{const n=e.sender?.toLowerCase()===a?.toLowerCase(),s=new Date(e.timestamp),i=s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),o=s.toDateString();let c="";o!==r&&(r=o,c=$.renderDateSeparator(s));const h=this.getVerificationBadge(e,n);let u=e.senderName||e.verified?.ensName;u||(u=this.formatAddress(e.sender));const m=function(e){switch(e){case E:return"msg-group-first";case k:return"msg-group-middle";case S:return"msg-group-last";default:return"msg-group-single"}}(l[t]),p=function(e){switch(e){case A:return"spacing-stack";case B:return"spacing-ping-pong";case P:return"spacing-same-side";default:return""}}(d[t]);return c+$.buildMessageHTML(e,n,i,h,u,m,l[t],p)}).join(""),this.elements.messagesArea.innerHTML=o+this.elements.messagesArea.innerHTML,this.isLoadingMore||(this.elements.messagesArea.scrollTop=this.elements.messagesArea.scrollHeight),this.attachReactionListeners(),this.attachLightboxListeners()}renderDateSeparator(e){return $.renderDateSeparator(e)}renderReactions(e,t){return $.renderReactions(e,t)}renderReplyPreview(e){return $.renderReplyPreview(e)}startReply(e){const t=s.L.getCurrentChannel();if(!t)return;const n=t.messages.find(t=>(t.id||t.timestamp)===e);if(!n)return;const i=n.senderName||n.verified?.ensName||this.formatAddress(n.sender);this.replyingTo={id:e,text:n.text?n.text.substring(0,100):"",sender:n.sender,senderName:i},this.elements.replyToName&&(this.elements.replyToName.textContent=i),this.elements.replyToText&&(this.elements.replyToText.textContent=n.text?n.text.substring(0,100)+(n.text.length>100?"...":""):"[Media]"),this.elements.replyBar&&this.elements.replyBar.classList.add("active"),this.elements.messageInput?.focus()}cancelReply(){this.replyingTo=null,this.elements.replyBar&&this.elements.replyBar.classList.remove("active")}scrollToMessage(e){const t=document.querySelector(`[data-msg-id="${e}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("message-highlight"),setTimeout(()=>{t.classList.remove("message-highlight")},1500))}initReactions(){f.init()}toggleReaction(e,t){f.toggleReaction(e,t)}updateReactionUI(e){f.updateReactionUI(e)}handleIncomingReaction(e,t,n,s="add"){f.handleIncomingReaction(e,t,n,s)}attachReactionListeners(){f.attachReactionListeners(e=>this.startReply(e),e=>this.handleFileDownload(e),e=>this.scrollToMessage(e))}async handleFileDownload(e){const t=s.L.getCurrentChannel();await L.handleFileDownload(e,t,c.F)}resetDownloadUI(e){L.resetDownloadUI(e)}showReactionPicker(e,t,n){f.showReactionPicker(e,t,n)}initEmojiPicker(){f.initEmojiPicker(this.elements.messageInput)}initAttachButton(){const e=document.getElementById("attach-btn"),t=document.getElementById("attach-menu"),n=document.getElementById("send-image-btn"),s=document.getElementById("send-video-btn"),i=document.getElementById("image-input"),a=document.getElementById("video-input"),r=document.getElementById("cancel-file-btn"),o=document.getElementById("confirm-file-btn");e&&t&&(this.pendingFile=null,this.pendingFileType=null,e.addEventListener("click",e=>{e.stopPropagation(),t.classList.toggle("hidden")}),n?.addEventListener("click",()=>{t.classList.add("hidden"),i?.click()}),s?.addEventListener("click",()=>{t.classList.add("hidden"),a?.click()}),i?.addEventListener("change",e=>{const t=e.target.files?.[0];t&&this.showFileConfirmModal(t,"image"),e.target.value=""}),a?.addEventListener("change",e=>{const t=e.target.files?.[0];t&&this.showFileConfirmModal(t,"video"),e.target.value=""}),r?.addEventListener("click",()=>{this.pendingFile=null,this.pendingFileType=null,T.hide("file-confirm-modal")}),o?.addEventListener("click",async()=>{if(!this.pendingFile)return;const e=this.pendingFile,t=this.pendingFileType;this.pendingFile=null,this.pendingFileType=null,T.hide("file-confirm-modal"),await this.sendMediaFile(e,t)}),this.setupMediaHandlers())}showFileConfirmModal(e,t){const n=document.getElementById("file-confirm-modal"),s=document.getElementById("confirm-file-name"),i=document.getElementById("confirm-file-size"),a=document.getElementById("file-preview-icon");n&&(this.pendingFile=e,this.pendingFileType=t,s.textContent=e.name,i.textContent=this.formatFileSize(e.size),"image"===t?a.innerHTML='\n                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/>\n                </svg>\n            ':"video"===t&&(a.innerHTML='\n                <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/>\n                </svg>\n            '),T.show("file-confirm-modal"))}async sendMediaFile(e,t){const n=s.L.getCurrentChannel();if(n)try{this.showLoading("image"===t?"Sending image...":"Processing video..."),"image"===t?(await c.F.sendImage(n.streamId,e,n.password),this.showNotification("Image sent!","success")):"video"===t&&(await c.F.sendVideo(n.streamId,e,n.password),this.showNotification("Video shared!","success")),this.hideLoading()}catch(e){this.hideLoading(),this.showNotification("Failed to send: "+e.message,"error")}else this.showNotification("No channel selected","error")}setupMediaHandlers(){c.F.onImageReceived((e,t)=>{const n=document.querySelector(`[data-image-id="${e}"]`);if(n){const e=this.registerMedia(t,"image");if(!e)return;n.outerHTML=`\n                    <div class="relative inline-block max-w-xs group">\n                        <img src="${t}" \n                             class="max-w-full max-h-60 rounded-lg cursor-pointer object-contain lightbox-trigger" \n                             data-media-id="${e}"\n                             alt="Image"/>\n                        <button class="absolute top-1 right-1 bg-black/60 hover:bg-black/80 text-white p-1 rounded transition opacity-0 group-hover:opacity-100 lightbox-trigger"\n                                data-media-id="${e}"\n                                title="Maximize">\n                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>\n                            </svg>\n                        </button>\n                    </div>\n                `,this.attachLightboxListeners()}}),c.F.onFileProgress((e,t,n,s,i)=>{const a=document.querySelector(`[data-progress-overlay="${e}"]`);a&&a.classList.remove("hidden");const r=document.querySelector(`[data-progress-percent="${e}"]`);r&&(r.textContent=`${t}%`);const o=document.querySelector(`[data-progress-fill="${e}"]`);o&&(o.style.width=`${t}%`);const l=document.querySelector(`[data-progress-text="${e}"]`);if(l){const e=(n/s*i/1048576).toFixed(1),t=(i/1048576).toFixed(1);l.textContent=`${e} / ${t} MB`}const d=document.querySelector(`.download-file-btn[data-file-id="${e}"]`);if(d){const e=d.querySelector(".download-play-icon"),t=d.querySelector(".download-loading-icon");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),d.disabled=!0,d.classList.add("cursor-not-allowed")}}),c.F.onFileComplete((e,t,n,s)=>{const i=document.querySelector(`[data-file-id="${e}"]`);if(i){const s=c.F.isSeeding(e),a=this.escapeHtml(t.fileName),r=this.escapeHtml(t.fileType);if(t.fileType.startsWith("video/")){const o=c.F.isVideoPlayable(t.fileType),l=this.registerMedia(n,"video");o&&l?(i.outerHTML=`\n                            <div data-file-id="${this.escapeAttr(e)}" class="max-w-xs">\n                                <div class="relative rounded-lg overflow-hidden bg-black">\n                                    <video src="${n}" \n                                           class="max-w-full max-h-60 cursor-pointer video-player-${this.escapeAttr(e)}" \n                                           controls\n                                           preload="metadata"\n                                           playsinline>\n                                        <source src="${n}" type="${r}">\n                                        Your browser does not support this video format.\n                                    </video>\n                                    <button class="absolute top-1 right-1 bg-black/60 hover:bg-black/80 text-white p-1 rounded transition lightbox-trigger"\n                                            data-media-id="${l}"\n                                            title="Fullscreen">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>\n                                        </svg>\n                                    </button>\n                                    ${s?'\n                                    <div class="absolute bottom-1 left-1 bg-green-600/90 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1">\n                                        <svg class="w-3 h-3 animate-pulse" fill="currentColor" viewBox="0 0 20 20">\n                                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>\n                                        </svg>\n                                        <span>Seeding</span>\n                                    </div>\n                                    ':""}\n                                </div>\n                                <div class="flex items-center justify-between mt-1 text-xs text-gray-500">\n                                    <span class="truncate flex-1">${a}</span>\n                                    <div class="flex items-center gap-2 ml-2">\n                                        <span>${this.formatFileSize(t.fileSize)}</span>\n                                        <a href="${n}" download="${a}" class="text-blue-400 hover:underline">Save</a>\n                                    </div>\n                                </div>\n                            </div>\n                        `,this.attachLightboxListeners(),setTimeout(()=>{const t=document.querySelector(`.video-player-${e}`);t&&(t.addEventListener("error",e=>{console.error("Video playback error:",e);const s=t.closest("[data-file-id]");s&&(s.innerHTML=`\n                                            <div class="bg-[#252525] rounded-lg p-3">\n                                                <div class="flex items-center gap-2 mb-2">\n                                                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>\n                                                    </svg>\n                                                    <span class="text-sm text-gray-300">Format not supported</span>\n                                                </div>\n                                                <a href="${n}" download="${a}" class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center px-3 py-2 rounded-lg text-sm transition">\n                                                    Download ${a}\n                                                </a>\n                                            </div>\n                                        `)}),t.load())},100)):i.outerHTML=`\n                            <div data-file-id="${this.escapeAttr(e)}" class="max-w-xs">\n                                <div class="bg-[#252525] rounded-lg p-3">\n                                    <div class="flex items-center gap-2 mb-2">\n                                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/>\n                                        </svg>\n                                        <span class="font-medium text-sm truncate text-white">${a}</span>\n                                    </div>\n                                    <div class="text-xs text-yellow-500 mb-2">\n                                         Format not supported in browser (${r.split("/")[1]?.toUpperCase()||"video"})\n                                    </div>\n                                    <div class="flex items-center justify-between">\n                                        <span class="text-xs text-gray-400">${this.formatFileSize(t.fileSize)}</span>\n                                        <a href="${n}" download="${a}" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm transition">\n                                            Download\n                                        </a>\n                                    </div>\n                                    ${s?'\n                                    <div class="flex items-center gap-2 mt-2">\n                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>\n                                        <span class="text-xs text-green-400">Seeding...</span>\n                                    </div>\n                                    ':""}\n                                </div>\n                            </div>\n                        `}else i.innerHTML=`\n                        <a href="${n}" download="${a}" class="text-blue-400 hover:underline">${a}</a>\n                    `}}),c.F.onSeederUpdate((e,t)=>{const n=document.querySelector(`[data-seeder-count="${e}"]`);n&&(n.textContent=`${t} seeder${1!==t?"s":""}`)})}openLightbox(e,t="image"){L.openLightbox(e,t)}closeLightbox(){L.closeLightbox()}attachLightboxListeners(){L.attachLightboxListeners()}isEmojiOnly(e){return $.isEmojiOnly(e)}wrapInlineEmojis(e){return $.wrapInlineEmojis(e)}renderMessageContent(e){return $.renderMessageContent(e)}formatFileSize(e){return $.formatFileSize(e)}showTypingIndicator(e){const t=document.getElementById("typing-indicator"),n=document.getElementById("typing-users");if(!t||!n)return;if(0===e.length)return void t.classList.add("hidden");const s=e.map(e=>this.formatAddress(e)).join(", ");n.textContent=s+(1===e.length?" is":" are"),t.classList.remove("hidden")}hideTypingIndicator(){const e=document.getElementById("typing-indicator");e&&e.classList.add("hidden")}getVerificationBadge(e,t=!1){if(t)return{html:'<span class="text-green-400" title="Your message"></span>',textColor:"text-green-400",bgColor:"",border:""};if(!e.signature)return{html:"",textColor:"text-gray-400",bgColor:"bg-gray-700",border:""};if(e.verified&&!e.verified.valid)return{html:'<span class="text-red-500" title=" Invalid signature - may be impersonation!"></span>',textColor:"text-red-400",bgColor:"bg-red-900/20",border:"border border-red-500/50"};const n={0:{icon:"",color:"text-green-400",label:"Valid signature"},1:{icon:"",color:"text-green-400",label:"ENS verified"},2:{icon:"",color:"text-yellow-400",label:"Trusted contact"}},s=n[e.verified?.trustLevel??0]||n[0];return{html:`<span class="${s.color}" title="${s.label}">${s.icon}</span>`,textColor:s.color,bgColor:"",border:""}}addMessage(e){const t=s.L.getCurrentChannel();t&&(this.renderMessages(t.messages),this.updateUnreadCount(t.streamId))}updateUnreadCount(e){const t=document.querySelector(`[data-channel-count="${e}"]`);if(!t)return;const n=s.L.getChannel(e);if(!n)return;const i=l.Z.getChannelLastAccess(e)||0,a=s.L.getCurrentChannel();if(a?.streamId===e)return l.Z.setChannelLastAccess(e,Date.now()),void t.classList.add("hidden");const r=n.messages.filter(e=>e.timestamp>i).length;r>0?(t.textContent=r>=30?"+30":r,t.classList.remove("hidden","text-[#666]","bg-[#252525]"),t.classList.add("text-white","bg-[#F6851B]/20")):(t.classList.add("hidden"),t.classList.remove("text-white","bg-[#F6851B]/20"),t.classList.add("text-[#666]","bg-[#252525]"))}async handleCreateChannel(){const e=this.elements.channelNameInput.value.trim(),t=document.querySelector(".channel-tab-content:not(.hidden)"),n=t?.querySelector(".channel-type-input")?.value||"public",i=this.elements.channelPasswordInput.value,a=this.elements.channelMembersInput.value,r="native"===n?"hidden":this.currentExposure||"hidden",o="visible"===r&&this.elements.channelDescriptionInput?.value?.trim()||"",l="visible"===r?this.elements.channelLanguageInput?.value||"en":"",c="visible"===r?this.elements.channelCategoryInput?.value||"general":"",h="native"===n?this.currentClassification||"personal":null,u=this.currentStorageProvider||"streamr",m="streamr"===u?parseInt(document.getElementById("storage-days-input")?.value||"180",10):null;if(!e)return void alert("Please enter a channel name");if("password"===n&&!i)return void alert("Please enter a password");const p="native"===n?a.split("\n").map(e=>e.trim()).filter(e=>e):[],g={exposure:r,description:o,language:l,category:c,classification:h,readOnly:this.currentReadOnly||!1,storageProvider:u,storageDays:m};d.V.debug("Creating channel:",{name:e,type:n,password:i?"***":null,members:p,options:g});try{this.showLoadingToast("Creating channel...","This may take a minute"),this.hideNewChannelModal();const t=await s.L.createChannel(e,n,i,p,g);d.V.debug("Channel created in UI:",t),this.hideLoadingToast(),d.V.debug("Rendering channel list..."),this.renderChannelList(),t&&setTimeout(()=>{this.selectChannel(t.streamId)},100),this.showNotification("Channel created successfully!","success")}catch(e){this.hideLoadingToast(),this.showNotification("Failed to create channel: "+e.message,"error")}}async handleSendMessage(){if(this.isSending)return;const e=this.elements.messageInput.value.trim();if(!e)return;const t=s.L.getCurrentChannel(),n=null!==this.previewChannel;if(t||n){this.isSending=!0;try{const i=this.replyingTo;this.elements.messageInput.value="",this.elements.messageInput.style.height="auto",this.cancelReply(),n?await this._sendPreviewMessage(e,i):await s.L.sendMessage(t.streamId,e,i)}catch(e){this.showNotification("Failed to send message: "+e.message,"error")}finally{this.isSending=!1}}}async _sendPreviewMessage(e,t=null){if(!this.previewChannel)return;const n={type:"message",text:e,sender:i.s.getAddress(),senderName:await a.E.getDisplayName(i.s.getAddress()),timestamp:Date.now(),id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`};t&&(n.replyTo={id:t.id,text:t.text,sender:t.sender,senderName:t.senderName}),await h.xA.publishMessage(this.previewChannel.streamId,n)}isMobileView(){return window.innerWidth<768}openChatView(){this.isMobileView()&&(this.elements.sidebar?.classList.add("chat-active"),this.elements.chatArea?.classList.add("active"),document.body.classList.add("chat-open"))}closeChatView(){this.isMobileView()&&(this.elements.sidebar?.classList.remove("chat-active"),this.elements.chatArea?.classList.remove("active"),document.body.classList.remove("chat-open"))}showNewChannelModal(){T.show("new-channel-modal"),this.elements.channelNameInput.value="",this.elements.channelPasswordInput.value="",this.elements.channelMembersInput.value="",this.elements.channelDescriptionInput&&(this.elements.channelDescriptionInput.value=""),this.elements.channelLanguageInput&&(this.elements.channelLanguageInput.value="en"),this.elements.channelCategoryInput&&(this.elements.channelCategoryInput.value="general"),this.switchChannelTab("public"),this.setVisibility(!1),this.switchClassificationTab("personal"),this.setReadOnly(!1),this.selectStorageProvider("streamr");const e=document.getElementById("storage-days-input");e&&(e.value="180",this.updateStorageDaysDisplay(180)),this.updateGasEstimates()}async updateGasEstimates(){const e=document.getElementById("cost-public"),t=document.getElementById("cost-password"),n=document.getElementById("cost-native");try{const s=await p.estimateCosts(),i=`Gas: ${s.formatted.gasPrice}`;e&&(e.textContent=s.formatted.public,e.dataset.tooltip=i),t&&(t.textContent=s.formatted.password,t.dataset.tooltip=i),n&&(n.textContent=s.formatted.native,n.dataset.tooltip=i)}catch(s){d.V.warn("Failed to estimate gas costs:",s);const i="Gas: ~30 gwei";e&&(e.textContent="~0.01 POL",e.dataset.tooltip=i),t&&(t.textContent="~0.01 POL",t.dataset.tooltip=i),n&&(n.textContent="~0.02 POL",n.dataset.tooltip=i)}}switchChannelTab(e){document.querySelectorAll(".channel-tab").forEach(t=>{const n=t.dataset.tab===e;t.classList.toggle("bg-white/10",n),t.classList.toggle("text-white",n),t.classList.toggle("text-white/60",!n),t.classList.toggle("hover:text-white/90",!n),t.classList.toggle("hover:bg-white/5",!n)}),document.querySelectorAll(".channel-tab-content").forEach(t=>{t.classList.toggle("hidden",t.id!==`tab-${e}`)}),document.querySelectorAll(".channel-cost-display").forEach(e=>{e.classList.add("hidden")});const t=document.getElementById(`cost-${e}`);t&&t.classList.remove("hidden"),"native"===e?(this.setVisibility(!1),this.elements.exposureSection?.classList.add("hidden")):this.elements.exposureSection?.classList.remove("hidden")}toggleVisibility(){const e=document.getElementById("visibility-toggle");if(!e)return;const t="true"===e.dataset.enabled;this.setVisibility(!t)}setVisibility(e){const t=document.getElementById("visibility-toggle");if(!t)return;t.dataset.enabled=e?"true":"false";const n=t.querySelector("span");e?(t.classList.remove("bg-white/10"),t.classList.add("bg-[#F6851B]"),n&&(n.classList.remove("left-0.5","bg-white/30"),n.classList.add("left-4","bg-white")),this.elements.visibleFields?.classList.remove("hidden")):(t.classList.remove("bg-[#F6851B]"),t.classList.add("bg-white/10"),n&&(n.classList.remove("left-4","bg-white"),n.classList.add("left-0.5","bg-white/30")),this.elements.visibleFields?.classList.add("hidden")),this.currentExposure=e?"visible":"hidden"}switchClassificationTab(e){document.querySelectorAll(".classification-tab").forEach(t=>{const n=t.dataset.classification===e;t.classList.toggle("bg-white/10",n),t.classList.toggle("text-white",n),t.classList.toggle("border-white/10",n),t.classList.toggle("bg-white/5",!n),t.classList.toggle("text-white/50",!n),t.classList.toggle("border-white/5",!n),t.classList.toggle("hover:bg-white/10",!n),t.classList.toggle("hover:text-white/70",!n)}),this.currentClassification=e}switchJoinClassificationTab(e){document.querySelectorAll(".join-classification-tab").forEach(t=>{const n=t.dataset.joinClassification===e;t.classList.toggle("bg-white/10",n),t.classList.toggle("text-white",n),t.classList.toggle("border-white/10",n),t.classList.toggle("bg-white/5",!n),t.classList.toggle("text-white/50",!n),t.classList.toggle("border-white/5",!n),t.classList.toggle("hover:bg-white/10",!n),t.classList.toggle("hover:text-white/70",!n)}),this.joinClassification=e}switchChannelFilterTab(e){document.querySelectorAll(".channel-filter-tab").forEach(t=>{const n=t.dataset.channelFilter===e;t.classList.toggle("border-[#F6851B]",n),t.classList.toggle("border-transparent",!n),t.classList.toggle("text-[#F6851B]",n),t.classList.toggle("text-white/40",!n),t.classList.toggle("hover:text-white/60",!n)}),this.currentChannelFilter=e,this.renderChannelList()}toggleReadOnly(){const e=document.getElementById("read-only-toggle");if(!e)return;const t="true"===e.dataset.enabled;this.setReadOnly(!t)}setReadOnly(e){const t=document.getElementById("read-only-toggle");if(!t)return;t.dataset.enabled=e?"true":"false";const n=t.querySelector("span");e?(t.classList.remove("bg-white/10"),t.classList.add("bg-[#F6851B]"),n&&(n.classList.remove("left-0.5","bg-white/30"),n.classList.add("left-4","bg-white"))):(t.classList.remove("bg-[#F6851B]"),t.classList.add("bg-white/10"),n&&(n.classList.remove("left-4","bg-white"),n.classList.add("left-0.5","bg-white/30"))),this.currentReadOnly=e}selectStorageProvider(e){this.currentStorageProvider=e,document.querySelectorAll(".storage-provider-tab").forEach(t=>{t.dataset.storage===e?(t.classList.remove("bg-white/5","text-white/50","border-white/5"),t.classList.add("bg-white/10","text-white","border-white/10")):(t.classList.remove("bg-white/10","text-white","border-white/10"),t.classList.add("bg-white/5","text-white/50","border-white/5"))});const t=document.getElementById("storage-days-section"),n=document.getElementById("logstore-info");"streamr"===e?(t?.classList.remove("hidden"),n?.classList.add("hidden")):(t?.classList.add("hidden"),n?.classList.remove("hidden"))}updateStorageDaysDisplay(e){e=parseInt(e,10);const t=document.getElementById("storage-days-value"),n=document.getElementById("storage-days-input");if(1===e)t.textContent="1 day";else if(e<30)t.textContent=`${e} days`;else if(e<365){const n=Math.round(e/30);t.textContent=1===n?"1 month":`${n} months`}else t.textContent="1 year";if(n){const t=(e-1)/364*100;n.style.setProperty("--slider-progress",`${t}%`)}}async updateReadOnlyUI(e){this.elements.messageInput,document.querySelector("#send-btn");const t=i.s.getAddress();if(t){if(e._publishPermCache?.address?.toLowerCase()===t.toLowerCase()&&e._publishPermCache?.timestamp&&Date.now()-e._publishPermCache.timestamp<6e4){const t=e._publishPermCache.canPublish;return void this.setReadOnlyInputState(!t,t&&e.readOnly)}this.setReadOnlyInputState(!0);try{const n=await h.xA.hasPublishPermission(e.messageStreamId,!0);e._publishPermCache={address:t,canPublish:n,timestamp:Date.now()},this.setReadOnlyInputState(!n,n&&e.readOnly),d.V.debug("Permission check via SDK:",{channel:e.name,canPublish:n,readOnly:e.readOnly})}catch(e){d.V.warn("Failed to check publish permission:",e),this.setReadOnlyInputState(!0)}}else this.setReadOnlyInputState(!0)}setReadOnlyInputState(e,t=!1){const n=this.elements.messageInput,s=document.querySelector("#send-btn");e?(n&&(n.disabled=!0,n.placeholder="This channel is read-only",n.classList.add("cursor-not-allowed","opacity-50")),s&&(s.disabled=!0,s.classList.add("opacity-50","cursor-not-allowed"))):(n&&(n.disabled=!1,n.placeholder=t?"Type a message (broadcast)...":"Type a message...",n.classList.remove("cursor-not-allowed","opacity-50")),s&&(s.disabled=!1,s.classList.remove("opacity-50","cursor-not-allowed")))}hideNewChannelModal(){T.hideNewChannelModal()}showJoinChannelModal(){T.showJoinChannelModal(this.elements.joinChannelModal,this.elements.joinStreamIdInput,this.elements.joinPasswordInput,this.elements.joinPasswordField)}hideJoinChannelModal(){T.hide("join-channel-modal")}showJoinClosedChannelModal(e=""){T.showJoinClosedChannelModal(e),this.switchJoinClassificationTab("personal")}hideJoinClosedChannelModal(){T.hide("join-closed-channel-modal")}async handleJoinClosedChannel(){const e=document.getElementById("join-closed-stream-id-input")?.value.trim(),t=document.getElementById("join-closed-name-input")?.value.trim(),n=this.joinClassification||"personal";if(e)if(t){this.hideJoinClosedChannelModal(),this.showLoadingToast("Joining channel...","Setting up encryption");try{const i=await s.L.joinChannel(e,null,{localName:t,classification:n});this.hideLoadingToast(),this.elements.quickJoinInput?.value.trim()===e&&(this.elements.quickJoinInput.value="",this.updateBrowseJoinButton(),this.updateQuickJoinHash()),this.renderChannelList(),i&&setTimeout(()=>this.selectChannel(i.streamId),100),this.showNotification("Joined closed channel!","success")}catch(e){this.hideLoadingToast(),this.showNotification("Failed to join: "+e.message,"error")}}else this.showNotification("Please give the channel a name","error");else this.showNotification("Please enter a Channel ID","error")}updateBrowseJoinButton(){const e=this.elements.quickJoinInput?.value.trim(),t=this.elements.browseChannelsBtn,n=this.elements.browseBtnIcon,s=this.elements.browseBtnText;t&&n&&s&&(e?(t.classList.remove("text-[#888]","hover:text-white"),t.classList.add("text-[#F6851B]","hover:text-[#ff9933]","border-[#F6851B]/30"),s.textContent="Join",n.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>'):(t.classList.remove("text-[#F6851B]","hover:text-[#ff9933]","border-[#F6851B]/30"),t.classList.add("text-[#888]","hover:text-white"),s.textContent="Explore",n.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418"/>'))}updateQuickJoinHash(){const e=this.elements.quickJoinInput?.value.trim(),t=this.elements.quickJoinHash,n=this.elements.quickJoinInput;t&&n&&(e?(t.classList.remove("hidden"),n.classList.add("pl-6"),n.classList.remove("px-3")):(t.classList.add("hidden"),n.classList.remove("pl-6"),n.classList.add("px-3")))}async handleQuickJoin(){const e=this.elements.quickJoinInput?.value.trim();if(!e)return void this.showNotification("Please enter a channel ID","error");let t=D.cachedPublicChannels?.find(t=>t.streamId===e);if(!t){this.showLoading("Checking channel...");try{t=await o.graphAPI.getChannelInfo(e)}catch(e){d.V.warn("Failed to query channel info:",e)}this.hideLoading()}if("password"===t?.type){const n=await this.showPasswordInputModal("Join Password Channel",`Enter password for "${t.name}":`);if(!n)return;try{this.showLoadingToast("Joining channel...","This may take a moment"),await s.L.joinChannel(e,n,{name:t.name,type:"password"}),this.hideLoadingToast(),this.elements.quickJoinInput&&(this.elements.quickJoinInput.value="",this.updateBrowseJoinButton(),this.updateQuickJoinHash()),this.renderChannelList(),this.showNotification("Joined channel successfully!","success")}catch(e){this.hideLoadingToast(),this.showNotification("Failed to join: "+e.message,"error")}return}if("native"===t?.type)return this.hideLoading(),void this.showJoinClosedChannelModal(e);try{this.showLoadingToast("Joining channel...","This may take a moment"),await s.L.joinChannel(e,null,t?{name:t.name,type:t.type}:void 0),this.hideLoadingToast(),this.elements.quickJoinInput&&(this.elements.quickJoinInput.value="",this.updateBrowseJoinButton(),this.updateQuickJoinHash()),this.renderChannelList(),this.showNotification("Joined channel successfully!","success")}catch(n){if(this.hideLoadingToast(),t)this.showNotification("Failed to join: "+n.message,"error");else{this.elements.joinStreamIdInput&&(this.elements.joinStreamIdInput.value=e);const t=document.getElementById("join-has-password");t&&(t.checked=!1,this.elements.joinPasswordField?.classList.add("hidden")),T.show("join-channel-modal"),this.showNotification("Enter channel details or check if password is required","info"),this.elements.quickJoinInput&&(this.elements.quickJoinInput.value="",this.updateBrowseJoinButton(),this.updateQuickJoinHash())}}}async handleJoinChannel(){const e=this.elements.joinStreamIdInput?.value.trim(),t=this.elements.joinPasswordInput?.value||null;if(e)try{this.showLoadingToast("Joining channel...","This may take a moment"),await s.L.joinChannel(e,t),this.hideLoadingToast(),this.hideJoinChannelModal(),this.renderChannelList(),this.showNotification("Joined channel successfully!","success")}catch(e){this.hideLoadingToast(),this.showNotification("Failed to join: "+e.message,"error")}else this.showNotification("Please enter a Stream ID","error")}async joinPublicChannel(e,t=null){try{if("password"===t?.type){const n=await this.showPasswordInputModal("Join Password Channel",`Enter password for "${t.name}":`);if(!n)return;this.showLoadingToast("Joining channel...","This may take a moment"),await s.L.joinChannel(e,n,{name:t?.name,type:"password",readOnly:t?.readOnly||!1,createdBy:t?.createdBy})}else this.showLoadingToast("Joining channel...","This may take a moment"),await s.L.joinChannel(e,null,{name:t?.name,type:t?.type||"public",readOnly:t?.readOnly||!1,createdBy:t?.createdBy});this.hideLoadingToast(),this.renderChannelList(),await this.selectChannel(e),this.showNotification("Joined channel successfully!","success")}catch(e){this.hideLoadingToast(),this.showNotification("Failed to join: "+e.message,"error")}}async enterPreviewMode(e,t=null){s.L.getChannel(e)?await this.selectChannel(e):await this._enterPreviewCore(e,t,!0)}async _enterPreviewCore(e,t,n){try{if(this.previewChannel&&await this.exitPreviewMode(!1),s.L.setCurrentChannel(null),this.showLoadingToast("Loading channel...","Connecting to stream"),!t)try{t=await o.graphAPI.getChannelInfo(e)}catch(e){d.V.warn("Could not get channel info from Graph:",e.message)}if(this.previewChannel={streamId:e,channelInfo:t,name:this._getChannelDisplayName(e,t),type:t?.type||"public",readOnly:t?.readOnly||!1,messages:[]},await u.D.setPreviewChannel(e),this.hideLoadingToast(),this._showPreviewUI(),this.openChatView(),n){const t=window.history.state;"preview"===t?.view||"channel"===t?.view?m.replaceState({view:"preview",streamId:e}):m.pushState({view:"preview",streamId:e})}d.V.info("Entered preview mode for:",e)}catch(e){this.hideLoadingToast(),this.previewChannel=null,d.V.error("Failed to enter preview mode:",e),this.showNotification("Failed to load channel: "+e.message,"error")}}_getChannelDisplayName(e,t){if(t?.name)return t.name;const n=e.split("/")[1];return n?n.replace(/-\d$/,""):e}_showPreviewUI(){this.previewChannel&&(this.elements.messagesArea.innerHTML='\n            <div class="flex flex-col items-center justify-center h-full text-gray-500">\n                <div class="spinner mb-3" style="width: 24px; height: 24px;"></div>\n                <span class="text-sm">Loading messages...</span>\n            </div>\n        ',this.elements.messagesArea?.classList.add("p-4"),this.previewChannel.isLoading=!0,setTimeout(()=>{this.previewChannel&&this.previewChannel.isLoading&&0===this.previewChannel.messages.length&&(this.previewChannel.isLoading=!1,this.elements.messagesArea.innerHTML='\n                    <div class="flex items-center justify-center h-full text-gray-500">\n                        No messages yet. Start the conversation!\n                    </div>\n                ')},3e3),this.elements.currentChannelName.textContent=this.previewChannel.name,this.elements.currentChannelInfo.innerHTML=this.getChannelTypeLabel(this.previewChannel.type,this.previewChannel.readOnly),this.elements.currentChannelInfo.parentElement.classList.remove("hidden"),this.elements.messageInputContainer.classList.remove("hidden"),this.elements.exploreTypeTabs?.classList.add("hidden"),this.elements.chatHeaderRight?.classList.remove("hidden"),this.elements.joinChannelBtn?.classList.remove("hidden"),this.elements.inviteUsersBtn?.classList.add("hidden"),this.elements.channelMenuBtn&&this.elements.channelMenuBtn.classList.remove("hidden"),this.elements.closeChannelBtn&&this.elements.closeChannelBtn.classList.remove("hidden"),this.elements.closeChannelBtnDesktop&&this.elements.closeChannelBtnDesktop.classList.remove("hidden"),this.elements.onlineHeader?.classList.remove("hidden"),this.elements.onlineHeader?.classList.add("flex"),this.elements.onlineSeparator?.classList.remove("hidden"))}async addPreviewToList(){if(this.previewChannel)try{const{streamId:e,channelInfo:t,name:n,type:i,readOnly:a,messages:r}=this.previewChannel;this.showLoadingToast("Adding channel...","Saving to your list"),await s.L.persistChannelFromPreview(e,{name:n,type:i,readOnly:a,createdBy:t?.createdBy,messages:r||[],reactions:f.exportAsObject()});const o=e;this.previewChannel=null,await u.D.promotePreviewToActive(o),this.hideLoadingToast(),this.elements.joinChannelBtn?.classList.add("hidden"),this.elements.inviteUsersBtn?.classList.remove("hidden"),this.renderChannelList(),await this.selectChannel(o),this.showNotification("Channel added to your list!","success"),d.V.info("Preview channel added to list:",o)}catch(e){this.hideLoadingToast(),d.V.error("Failed to add preview to list:",e),this.showNotification("Failed to add channel: "+e.message,"error")}else d.V.warn("No preview channel to add")}async exitPreviewMode(e=!0){if(this.previewChannel)try{const t=this.previewChannel.streamId;await u.D.clearPreviewChannel(),this.previewChannel=null,this.elements.joinChannelBtn?.classList.add("hidden"),d.V.info("Exited preview mode for:",t),e&&await this.openExploreView()}catch(e){d.V.error("Error exiting preview mode:",e),this.previewChannel=null}}handlePreviewMessage(e){if(!this.previewChannel)return;if("presence"===e?.type||"typing"===e?.type)return;if("reaction"===e?.type)return void f.handleIncomingReaction(e.messageId,e.emoji,e.user,e.action||"add");const t=e?.text,n="image"===e?.type&&e?.imageId,s="video_announce"===e?.type&&e?.metadata;e?.id&&e?.sender&&e?.timestamp&&(t||n||s?this.previewChannel.messages.some(t=>t.id===e.id)?d.V.debug("Preview: Message already exists, skipping:",e.id):(d.V.debug("Preview message received:",e.id,e.text?.slice(0,30)),this.previewChannel.isLoading=!1,this.previewChannel.messages.push(e),this.previewChannel.messages.sort((e,t)=>(e.timestamp||0)-(t.timestamp||0)),this.renderMessages(this.previewChannel.messages),this.elements.messagesArea&&(this.elements.messagesArea.scrollTop=this.elements.messagesArea.scrollHeight)):d.V.debug("Preview: Unknown message type, skipping:",e?.type))}showPasswordInputModal(e,t){return new Promise(n=>{const s=document.createElement("div");s.className="fixed inset-0 bg-black/80 flex items-center justify-center z-[60]";const i=this.escapeHtml(e),a=this.escapeHtml(t);s.innerHTML=`\n                <div class="bg-[#111111] rounded-xl p-5 w-[340px] max-w-full mx-4 border border-[#222]">\n                    <h3 class="text-[15px] font-medium mb-2 text-white">${i}</h3>\n                    <p class="text-[12px] text-[#888] mb-4">${a}</p>\n                    <input type="password" id="browse-password-input" placeholder="Password" \n                        class="w-full bg-[#1a1a1a] border border-[#282828] text-white px-3 py-2.5 rounded-lg text-[13px] focus:outline-none focus:border-[#444] transition mb-4"\n                        autocomplete="off">\n                    <div class="flex gap-2">\n                        <button id="cancel-pw-btn" class="flex-1 bg-[#1a1a1a] hover:bg-[#252525] border border-[#282828] text-[#888] text-[13px] font-medium py-2.5 rounded-lg transition">\n                            Cancel\n                        </button>\n                        <button id="confirm-pw-btn" class="flex-1 bg-white hover:bg-[#f0f0f0] text-black text-[13px] font-medium py-2.5 rounded-lg transition">\n                            Join\n                        </button>\n                    </div>\n                </div>\n            `,document.body.appendChild(s);const r=s.querySelector("#browse-password-input"),o=s.querySelector("#cancel-pw-btn"),l=s.querySelector("#confirm-pw-btn");setTimeout(()=>r.focus(),100);const d=e=>{document.body.removeChild(s),n(e)};o.addEventListener("click",()=>d(null)),l.addEventListener("click",()=>d(r.value)),r.addEventListener("keypress",e=>{"Enter"===e.key&&d(r.value)}),s.addEventListener("click",e=>{e.target===s&&d(null)})})}async generateQRCode(e){try{if(!window.QRCode)throw new Error("QRCode library not loaded");const t=document.createElement("div");t.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50",t.innerHTML='\n                <div class="bg-[#111111] rounded-xl p-5 border border-[#222]">\n                    <h3 class="text-[15px] font-medium mb-4 text-white">Invite QR Code</h3>\n                    <div id="qr-container" class="bg-white p-3 rounded-lg flex items-center justify-center"></div>\n                    <button class="mt-4 w-full bg-[#1a1a1a] hover:bg-[#252525] border border-[#282828] text-[#888] text-[13px] font-medium px-4 py-2.5 rounded-lg transition">Close</button>\n                </div>\n            ',document.body.appendChild(t);const n=t.querySelector("#qr-container"),s=document.createElement("canvas");await window.QRCode.toCanvas(s,e,{width:200,margin:1,errorCorrectionLevel:"L",color:{dark:"#000000",light:"#ffffff"}}),n.appendChild(s),t.querySelector("button").addEventListener("click",()=>{document.body.removeChild(t)}),t.addEventListener("click",e=>{e.target===t&&document.body.removeChild(t)})}catch(e){d.V.error("Failed to generate QR code:",e),this.showNotification("Failed to generate QR code","error")}}showLoading(e){v.showLoading(e)}hideLoading(){v.hideLoading()}showAddContactModal(e){T.showAddContactModal(e),this._pendingContactAddress=e}hideAddContactModal(){T.hideAddContactModal(),this._pendingContactAddress=null}async confirmAddContact(){const e=document.getElementById("add-contact-modal-nickname"),t=e?.value?.trim()||null,n=this._pendingContactAddress||T.getPendingData("contactAddress");n&&(await a.E.addTrustedContact(n,t),this.showNotification("Contact added!","success"),this.hideAddContactModal())}showRemoveContactModal(e,t=null){T.showRemoveContactModal(e,t),this._pendingRemoveContactAddress=e,this._onRemoveContactCallback=t}hideRemoveContactModal(){T.hideRemoveContactModal(),this._pendingRemoveContactAddress=null,this._onRemoveContactCallback=null}async confirmRemoveContact(){const e=this._pendingRemoveContactAddress,t=this._onRemoveContactCallback;e&&(await a.E.removeTrustedContact(e),this.showNotification("Contact removed","info"),this.hideRemoveContactModal(),t&&t())}showNotification(e,t="info",n=3e3){v.showNotification(e,t,n)}showLoadingToast(e,t="This may take a moment..."){return v.showLoadingToast(e,t)}hideLoadingToast(e=null){v.hideLoadingToast(e)}getChannelTypeLabel(e,t=!1){const n=t?'<svg class="w-3 h-3 ml-1 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18"/></svg>':"";return{public:`<span class="inline-flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>Open${n}</span>`,password:`<span class="inline-flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>Protected${n}</span>`,native:`<span class="inline-flex items-center gap-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1.5l-8 13.5 8 4.5 8-4.5-8-13.5zm0 18l-8-4.5 8 9 8-9-8 4.5z"/></svg>Closed${n}</span>`}[e]||this.escapeHtml(String(e||"Unknown"))}showInviteModal(){const e=s.L.getCurrentChannel();if(!e)return void this.showNotification("Please select a channel first","warning");const t=s.L.generateInviteLink(e.streamId);this.elements.inviteLinkDisplay.value=t,this.elements.inviteAddressInput.value="",this.switchInviteTab("link"),T.show("invite-users-modal")}hideInviteModal(){T.hide("invite-users-modal")}switchInviteTab(e){document.querySelectorAll(".invite-tab").forEach(t=>{t.dataset.inviteTab===e?(t.classList.add("bg-white","text-black","font-medium"),t.classList.remove("text-[#888]","hover:text-white","hover:bg-[#252525]")):(t.classList.remove("bg-white","text-black","font-medium"),t.classList.add("text-[#888]","hover:text-white","hover:bg-[#252525]"))}),document.querySelectorAll(".invite-tab-content").forEach(e=>{e.classList.add("hidden")});const t=document.getElementById(`invite-tab-${e}`);t&&t.classList.remove("hidden")}async handleSendInvite(){const e=this.elements.inviteAddressInput.value.trim();if(!e)return void this.showNotification("Please enter a user address","warning");const t=s.L.getCurrentChannel();if(t)try{const{notificationManager:s}=await Promise.resolve().then(n.bind(n,6734));this.showLoading("Sending invite..."),await s.sendChannelInvite(e,t),this.hideLoading(),this.hideInviteModal(),this.showNotification("Invite sent successfully!","success")}catch(e){this.hideLoading(),e.message?.includes("STREAM_NOT_FOUND")||e.message?.includes("Stream not found")?this.showNotification("User does not have notifications enabled","error",5e3):this.showNotification("Failed to send invite","error")}else this.showNotification("No channel selected","error")}copyInviteLink(){this.elements.inviteLinkDisplay.select(),document.execCommand("copy"),this.showNotification("Link copied to clipboard!","success")}showInviteQR(){const e=this.elements.inviteLinkDisplay.value;this.generateQRCode(e)}async showChannelSettingsModal(){await N.show()}initChannelSettingsTabs(){N.initTabs()}selectChannelSettingsTab(e){N.selectTab(e)}hideChannelSettingsModal(){N.hide()}showDeleteChannelModal(){N.showDeleteModal()}hideDeleteChannelModal(){N.hideDeleteModal()}async handleDeleteChannel(){await N.handleDelete()}showLeaveChannelModal(){N.showLeaveModal()}hideLeaveChannelModal(){N.hideLeaveModal()}async confirmLeaveChannel(){await N.confirmLeave()}async handleLeaveChannel(){this.showLeaveChannelModal()}async loadChannelMembers(){await N.loadMembers()}renderMembersList(e,t){N.renderMembersList(e,t)}showMemberDropdown(e,t,n,s=!1){N.showMemberDropdown(e,t,n,s)}closeMemberDropdown(){N.closeMemberDropdown()}async handleMemberAction(e,t,n){await N.handleMemberAction(e,t,n)}async handleAddMember(){await N.handleAddMember()}async handleBatchAddMembers(){await N.handleBatchAddMembers()}showRemoveMemberModal(e){N.showRemoveMemberModal(e)}hideRemoveMemberModal(){N.hideRemoveMemberModal()}async executeRemoveMember(e){await N.executeRemoveMember(e)}async handleRemoveMember(e){this.showRemoveMemberModal(e)}async loadStreamPermissions(){await N.loadPermissions()}initSettingsUI(){this.elements.settingsBtn=document.getElementById("settings-btn"),this.elements.settingsModal=document.getElementById("settings-modal"),this.elements.closeSettingsBtn=document.getElementById("close-settings-btn"),this.elements.notificationsEnabled=document.getElementById("notifications-enabled"),this.elements.notificationsStatus=document.getElementById("notifications-status"),this.elements.settingsUsername=document.getElementById("settings-username"),this.elements.settingsAddress=document.getElementById("settings-address"),this.elements.copyOwnAddressBtn=document.getElementById("copy-own-address-btn"),this.elements.settingsGraphApiKey=document.getElementById("settings-graph-api-key"),this.elements.graphApiStatus=document.getElementById("graph-api-status"),this.elements.settingsTabs=document.querySelectorAll(".settings-tab"),this.elements.settingsPanels=document.querySelectorAll(".settings-panel"),this.initSettingsTabs(),this.elements.settingsBtn&&this.elements.settingsBtn.addEventListener("click",()=>this.showSettingsModal()),this.elements.closeSettingsBtn&&this.elements.closeSettingsBtn.addEventListener("click",()=>this.hideSettingsModal()),this.elements.notificationsEnabled&&this.elements.notificationsEnabled.addEventListener("change",e=>this.handleNotificationsToggle(e)),this.elements.settingsUsername&&this.elements.settingsUsername.addEventListener("change",async e=>{const t=e.target.value;await a.E.setUsername(t),i.s.updateWalletName(t||null),this.showNotification("Username updated!","success")}),this.elements.copyOwnAddressBtn&&this.elements.copyOwnAddressBtn.addEventListener("click",()=>this.copyOwnAddress());const e=document.getElementById("refresh-balance-btn");e&&e.addEventListener("click",()=>{const e=i.s.getAddress();this.updateBalanceDisplay(e)});const t=document.getElementById("fund-metamask-btn");t&&t.addEventListener("click",()=>this.handleFundWithMetaMask()),this.elements.settingsGraphApiKey&&this.elements.settingsGraphApiKey.addEventListener("change",async e=>{const t=e.target.value.trim();await o.graphAPI.setApiKey(t||null),await this.updateGraphApiStatus(),this.showNotification("Graph API key updated!","success")}),this.elements.walletInfo&&this.elements.walletInfo.addEventListener("click",()=>this.copyOwnAddress()),V.initExportPrivateKeyUI(),V.initBackupRestoreUI((e,t,n)=>this.showPasswordPrompt(e,t,n)),V.initDeleteAccountUI();const n=document.getElementById("nsfw-enabled");n&&n.addEventListener("change",async e=>{await l.Z.setNsfwEnabled(e.target.checked),document.querySelector(".explore-view")&&this.showExploreView()})}async showPasswordPrompt(e,t,n=!1){return new Promise(s=>{const i=document.createElement("div");i.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50";const a=this.escapeHtml(e),r=this.escapeHtml(t);i.innerHTML=`\n                <div class="bg-[#111111] rounded-xl w-[360px] overflow-hidden shadow-2xl border border-[#222]">\n                    <div class="px-5 pt-5 pb-3">\n                        <div class="flex items-center justify-between">\n                            <h3 class="text-[15px] font-medium text-white">${a}</h3>\n                            <button id="close-modal" class="text-[#666] hover:text-white transition p-1 -mr-1">\n                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                                </svg>\n                            </button>\n                        </div>\n                        <p class="text-[11px] text-[#666] mt-1 whitespace-pre-line">${r}</p>\n                    </div>\n                    <div class="px-5 pb-4 space-y-3">\n                        <div class="relative">\n                            <input type="password" id="password-input" placeholder="Password"\n                                class="w-full bg-[#1a1a1a] border border-[#282828] rounded-lg px-3 py-2.5 text-[13px] text-white placeholder-[#555] focus:outline-none focus:border-[#444] transition"\n                                autocomplete="off">\n                            <button id="toggle-visibility" class="absolute right-2.5 top-1/2 -translate-y-1/2 text-[#555] hover:text-white transition">\n                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                </svg>\n                            </button>\n                        </div>\n                        ${n?'\n                        <div class="relative">\n                            <input type="password" id="password-confirm" placeholder="Confirm password"\n                                class="w-full bg-[#1a1a1a] border border-[#282828] rounded-lg px-3 py-2.5 text-[13px] text-white placeholder-[#555] focus:outline-none focus:border-[#444] transition"\n                                autocomplete="off">\n                        </div>\n                        ':""}\n                        <p id="password-error" class="text-[11px] text-red-500 hidden"></p>\n                    </div>\n                    <div class="px-5 pb-5 flex gap-2">\n                        <button id="pw-cancel" class="flex-1 bg-[#1a1a1a] hover:bg-[#202020] text-white text-[13px] font-medium py-2.5 rounded-lg transition border border-[#282828]">\n                            Cancel\n                        </button>\n                        <button id="pw-confirm" class="flex-1 bg-white hover:bg-[#f0f0f0] text-black text-[13px] font-medium py-2.5 rounded-lg transition">\n                            Continue\n                        </button>\n                    </div>\n                </div>\n            `,document.body.appendChild(i);const o=i.querySelector("#password-input"),l=i.querySelector("#password-confirm"),d=i.querySelector("#password-error"),c=i.querySelector("#pw-confirm"),h=i.querySelector("#pw-cancel"),u=i.querySelector("#close-modal"),m=i.querySelector("#toggle-visibility");o.focus(),m&&m.addEventListener("click",()=>{const e="password"===o.type?"text":"password";o.type=e,l&&(l.type=e)});const p=e=>{o.value="",l&&(l.value=""),document.body.removeChild(i),s(e)},g=()=>{const e=o.value;return!e||e.length<4?(d.textContent="Password must be at least 4 characters",d.classList.remove("hidden"),null):n&&l&&e!==l.value?(d.textContent="Passwords do not match",d.classList.remove("hidden"),null):e};c.addEventListener("click",()=>{const e=g();e&&p(e)}),h.addEventListener("click",()=>p(null)),u.addEventListener("click",()=>p(null));const w=e=>{if("Enter"===e.key){const e=g();e&&p(e)}};o.addEventListener("keypress",w),l&&l.addEventListener("keypress",w),i.addEventListener("click",e=>{e.target===i&&p(null)})})}async copyOwnAddress(){const e=i.s.getAddress();if(e)try{await navigator.clipboard.writeText(e),this.showNotification("Address copied!","success")}catch{this.showNotification("Failed to copy","error")}}async showSettingsModal(){if(this.elements.settingsModal){const e=a.E.getUsername();this.elements.settingsUsername&&(this.elements.settingsUsername.value=e||"");const t=i.s.getAddress();this.elements.settingsAddress&&(this.elements.settingsAddress.value=t||""),this.updateBalanceDisplay(t);const n=r.notificationManager.isEnabled();if(this.elements.notificationsEnabled&&(this.elements.notificationsEnabled.checked=n),this.elements.notificationsStatus&&(this.elements.notificationsStatus.textContent=n?"Enabled":"Disabled",this.elements.notificationsStatus.className=n?"text-xs text-green-500":"text-xs text-white/40"),this.elements.settingsGraphApiKey){const e=o.graphAPI.isUsingDefaultKey()?"":o.graphAPI.getApiKey();this.elements.settingsGraphApiKey.value=e}await this.updateGraphApiStatus();const s=document.getElementById("nsfw-enabled");s&&(s.checked=l.Z.getNsfwEnabled()),this.selectSettingsTab("profile"),document.getElementById("export-key-step1")?.classList.remove("hidden"),document.getElementById("export-key-step2")?.classList.add("hidden");const d=document.getElementById("export-key-password");d&&(d.value=""),document.getElementById("delete-account-step1")?.classList.remove("hidden"),document.getElementById("delete-account-step2")?.classList.add("hidden");const c=document.getElementById("delete-account-password");c&&(c.value=""),T.show("settings-modal")}}initSettingsTabs(){this.elements.settingsTabs&&this.elements.settingsTabs.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.settingsTab;this.selectSettingsTab(t)})}),this.initSettingsCarousel()}settingsTabOrder=["profile","notifications","api","security","about"];currentSettingsTabIndex=0;initSettingsCarousel(){const e=document.getElementById("settings-carousel"),t=document.getElementById("settings-modal");if(!e||!t)return;e.querySelectorAll(".carousel-tab").forEach((e,t)=>{e.addEventListener("click",()=>{0===t?this.navigateSettingsCarousel(-1):2===t&&this.navigateSettingsCarousel(1)})});let n=0,s=0,i=!1;const a=t.querySelector(".bg-\\[\\#141414\\]");a&&(a.addEventListener("touchstart",e=>{const t=e.target;"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&"SELECT"!==t.tagName?(n=e.touches[0].clientX,s=e.touches[0].clientY,i=!0):i=!1},{passive:!0}),a.addEventListener("touchend",e=>{if(!i||!this.isMobileView())return;const t=e.changedTouches[0].clientX,a=e.changedTouches[0].clientY,r=n-t,o=s-a;Math.abs(r)>50&&Math.abs(r)>1.5*Math.abs(o)&&this.navigateSettingsCarousel(r>0?1:-1),i=!1},{passive:!0}))}navigateSettingsCarousel(e){const t=this.settingsTabOrder.length;this.currentSettingsTabIndex=(this.currentSettingsTabIndex+e+t)%t;const n=this.settingsTabOrder[this.currentSettingsTabIndex];this.selectSettingsTab(n)}updateSettingsCarousel(e){const t=document.getElementById("settings-carousel");if(!t)return;const n=t.querySelectorAll(".carousel-tab");if(3!==n.length)return;const s=this.settingsTabOrder.length,i=this.settingsTabOrder.indexOf(e);if(-1===i)return;this.currentSettingsTabIndex=i;const a=(i-1+s)%s,r=(i+1)%s,o={profile:"Account",notifications:"Notifications",api:"API",security:"Security",about:"About"};n[0].textContent=o[this.settingsTabOrder[a]],n[0].dataset.tab=this.settingsTabOrder[a],n[0].classList.remove("active"),n[0].classList.add("adjacent"),n[1].textContent=o[this.settingsTabOrder[i]],n[1].dataset.tab=this.settingsTabOrder[i],n[1].classList.add("active"),n[1].classList.remove("adjacent"),n[2].textContent=o[this.settingsTabOrder[r]],n[2].dataset.tab=this.settingsTabOrder[r],n[2].classList.remove("active"),n[2].classList.add("adjacent")}selectSettingsTab(e){this.elements.settingsTabs?.forEach(t=>{const n=t.dataset.settingsTab===e;t.classList.toggle("bg-white/10",n),t.classList.toggle("text-white",n),t.classList.toggle("text-white/60",!n)}),this.isMobileView()&&this.updateSettingsCarousel(e),this.elements.settingsPanels?.forEach(t=>{const n=t.id.replace("settings-panel-","");t.classList.toggle("hidden",n!==e)})}async updateGraphApiStatus(){if(this.elements.graphApiStatus)if(o.graphAPI.isUsingDefaultKey())this.elements.graphApiStatus.innerHTML='<span class="text-yellow-500 inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg>Using default key (rate limited)</span>';else{this.elements.graphApiStatus.innerHTML='<span class="text-gray-400">Testing connection...</span>';const e=await o.graphAPI.testConnection();this.elements.graphApiStatus.innerHTML=e?'<span class="text-green-500 inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Custom key active</span>':'<span class="text-red-500 inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>Invalid key or connection failed</span>'}}async updateBalanceDisplay(e){const t=document.getElementById("settings-balance");if(!t)return;if(!e)return void(t.textContent="Not connected");t.textContent="Loading...";const n=await p.getBalance(e);t.textContent=p.formatBalancePOL(n)}async handleFundWithMetaMask(){const e=i.s.getAddress();if(e){if(void 0===window.ethereum)return this.showNotification("MetaMask not detected. Please install MetaMask.","error"),void window.open("https://metamask.io/download/","_blank");try{const t=await window.ethereum.request({method:"eth_requestAccounts"});if(!t||0===t.length)return void this.showNotification("MetaMask connection cancelled","error");const n=t[0];if("0x89"!==await window.ethereum.request({method:"eth_chainId"}))try{await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x89"}]})}catch(e){if(4902!==e.code)throw e;await window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:"0x89",chainName:"Polygon Mainnet",nativeCurrency:{name:"POL",symbol:"POL",decimals:18},rpcUrls:["https://polygon-bor-rpc.publicnode.com","https://rpc.ankr.com/polygon"],blockExplorerUrls:["https://polygonscan.com"]}]})}const s=await this.showFundAmountPrompt();if(!s)return;const i="0x"+BigInt(Math.floor(1e18*parseFloat(s))).toString(16);this.showNotification("Confirm transaction in MetaMask...","info");const a=await window.ethereum.request({method:"eth_sendTransaction",params:[{from:n,to:e,value:i}]});this.showNotification("Transaction sent! Waiting for confirmation...","info");let r=null;for(;!r;)await new Promise(e=>setTimeout(e,2e3)),r=await window.ethereum.request({method:"eth_getTransactionReceipt",params:[a]});"0x1"===r.status?(this.showNotification(`Funded ${s} POL successfully!`,"success"),this.updateBalanceDisplay(e)):this.showNotification("Transaction failed","error")}catch(e){d.V.error("MetaMask funding error:",e),4001===e.code?this.showNotification("Transaction cancelled","error"):this.showNotification("Error: "+(e.message||"Unknown error"),"error")}}else this.showNotification("No account connected","error")}async showFundAmountPrompt(){return new Promise(e=>{const t=document.createElement("div");t.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50",t.innerHTML='\n                <div class="bg-[#111111] rounded-xl w-[320px] overflow-hidden shadow-2xl border border-[#222]">\n                    <div class="px-5 pt-5 pb-4">\n                        <div class="flex items-center justify-between">\n                            <h3 class="text-[15px] font-medium text-white">Fund Account</h3>\n                            <button id="close-fund-modal" class="text-[#666] hover:text-white transition p-1 -mr-1">\n                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                                </svg>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="px-5 pb-5">\n                        <input\n                            type="number"\n                            id="fund-amount"\n                            placeholder="Amount in POL"\n                            step="1"\n                            min="1"\n                            class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 rounded-xl text-sm focus:outline-none focus:border-[#8247E5]/50 transition placeholder:text-white/30 mb-3"\n                        />\n                        <div class="flex gap-2 mb-4">\n                            <button class="fund-preset flex-1 bg-white/5 hover:bg-white/10 text-white/60 px-2 py-1.5 rounded-lg text-xs transition whitespace-nowrap" data-amount="5">5 POL</button>\n                            <button class="fund-preset flex-1 bg-white/5 hover:bg-white/10 text-white/60 px-2 py-1.5 rounded-lg text-xs transition whitespace-nowrap" data-amount="10">10 POL</button>\n                            <button class="fund-preset flex-1 bg-white/5 hover:bg-white/10 text-white/60 px-2 py-1.5 rounded-lg text-xs transition whitespace-nowrap" data-amount="15">15 POL</button>\n                            <button class="fund-preset flex-1 bg-white/5 hover:bg-white/10 text-white/60 px-2 py-1.5 rounded-lg text-xs transition whitespace-nowrap" data-amount="20">20 POL</button>\n                        </div>\n                        <button id="confirm-fund-btn" class="w-full bg-[#F6851B]/10 hover:bg-[#F6851B]/20 text-[#F6851B] border border-[#F6851B]/30 px-4 py-3 rounded-xl text-sm font-medium transition flex items-center justify-center gap-2">\n                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m18 0V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v3"/></svg>\n                            Continue to MetaMask\n                        </button>\n                    </div>\n                </div>\n            ',document.body.appendChild(t);const n=t.querySelector("#fund-amount"),s=t.querySelector("#confirm-fund-btn"),i=t.querySelector("#close-fund-modal"),a=t.querySelectorAll(".fund-preset"),r=n=>{t.remove(),e(n)};a.forEach(e=>{e.addEventListener("click",()=>{n.value=e.dataset.amount,n.focus()})}),s.addEventListener("click",()=>{const e=parseFloat(n.value);!e||e<=0?n.classList.add("border-red-500/50"):r(n.value)}),n.addEventListener("keydown",e=>{"Enter"===e.key&&s.click()}),i.addEventListener("click",()=>r(null)),t.addEventListener("click",e=>{e.target===t&&r(null)}),setTimeout(()=>n.focus(),100)})}hideSettingsModal(){T.hide("settings-modal")}async handleNotificationsToggle(e){if(e.target.checked){if(!confirm("Enabling notifications will create a Streamr stream.\n\nThis requires a blockchain transaction and will cost gas fees.\n\nDo you want to continue?"))return void(e.target.checked=!1);try{this.showLoading("Creating notification stream (on-chain transaction)..."),await r.notificationManager.enable(),this.hideLoading(),this.showNotification("Notifications enabled!","success"),this.elements.notificationsStatus&&(this.elements.notificationsStatus.textContent="Enabled",this.elements.notificationsStatus.className="text-xs text-green-500")}catch(t){this.hideLoading(),e.target.checked=!1,this.showNotification("Failed to enable notifications: "+t.message,"error")}}else r.notificationManager.disable(),this.showNotification("Notifications disabled","info"),this.elements.notificationsStatus&&(this.elements.notificationsStatus.textContent="Disabled",this.elements.notificationsStatus.className="text-xs text-gray-500")}initContactsUI(){F.init()}showContactsModal(){F.show()}hideContactsModal(){F.hide()}renderContactsList(){F.renderList()}async handleAddContact(){await F.handleAddContact()}handleMessageRightClick(e){F.handleMessageRightClick(e)}showContextMenu(e,t){F.showContextMenu(e,t)}hideContextMenu(){F.hideContextMenu()}async handleContextMenuAction(e){await F.handleContextMenuAction(e)}}},9423(e,t,n){n.d(t,{Y0:()=>l,cr:()=>d});const s=[["#12182B","#3B6BE3"],["#151C33","#4A81D9"],["#1D1F2E","#5C7CFA"],["#181536","#5D5FE3"],["#141A2F","#4C6EDB"],["#101726","#4462C9"],["#171C2B","#6A7FDB"],["#19142A","#6C5DD3"],["#1C1633","#7A6CE0"],["#1A1230","#5F55B5"],["#201238","#7B4FE0"],["#23113A","#8A4BD6"],["#1D122B","#8E46E6"],["#211529","#8952D9"],["#241024","#B33DB3"],["#291425","#C44994"],["#2A1028","#A93FA0"],["#2B1212","#D93838"],["#2E151A","#D94160"],["#2E1622","#C93C75"],["#261518","#C44B5A"],["#2A1416","#B5424D"],["#241012","#A63A44"],["#0F1F1A","#1F8A70"],["#0E1B17","#1C7C68"],["#0C1A16","#207561"],["#0F201C","#2C8C6A"],["#101C18","#3A7F66"],["#1A1C23","#7382A6"],["#181B22","#6F7C99"],["#161A20","#5F6B85"]],i={arrowRight:(e,t,n)=>{const s=.35*n;return`M${e-s},${t-.6*s}\n                L${e+.4*s},${t}\n                L${e-s},${t+.6*s}\n                L${e-.5*s},${t}\n                Z`},chevronRight:(e,t,n)=>{const s=.3*n,i=.15*n;return`M${e-s},${t-s}\n                L${e+.3*s},${t}\n                L${e-s},${t+s}\n                L${e-s+i},${t+s}\n                L${e+.3*s+i},${t}\n                L${e-s+i},${t-s}\n                Z`},chevronLeft:(e,t,n)=>{const s=.3*n,i=.15*n;return`M${e+s},${t-s}\n                L${e-.3*s},${t}\n                L${e+s},${t+s}\n                L${e+s-i},${t+s}\n                L${e-.3*s-i},${t}\n                L${e+s-i},${t-s}\n                Z`},triangleUp:(e,t,n)=>{const s=.4*n;return`M${e},${t-s}\n                L${e+.9*s},${t+.7*s}\n                L${e-.9*s},${t+.7*s}\n                Z`},triangleDown:(e,t,n)=>{const s=.4*n;return`M${e},${t+s}\n                L${e+.9*s},${t-.7*s}\n                L${e-.9*s},${t-.7*s}\n                Z`},triangleLeft:(e,t,n)=>{const s=.4*n;return`M${e-s},${t} L${e+.7*s},${t-.9*s} L${e+.7*s},${t+.9*s} Z`},triangleRight:(e,t,n)=>{const s=.4*n;return`M${e+s},${t} L${e-.7*s},${t-.9*s} L${e-.7*s},${t+.9*s} Z`},diamond:(e,t,n)=>{const s=.38*n;return`M${e},${t-s}\n                L${e+s},${t}\n                L${e},${t+s}\n                L${e-s},${t}\n                Z`},square:(e,t,n)=>{const s=.35*n;return`M${e-s},${t-s}\n                L${e+s},${t-s}\n                L${e+s},${t+s}\n                L${e-s},${t+s}\n                Z`},pentagon:(e,t,n)=>{const s=.35*n,i=[];for(let n=0;n<5;n++){const a=2*Math.PI/5*n-Math.PI/2;i.push(`${e+s*Math.cos(a)},${t+s*Math.sin(a)}`)}return`M${i.join(" L")} Z`},hexagon:(e,t,n)=>{const s=.35*n,i=[];for(let n=0;n<6;n++){const a=Math.PI/3*n-Math.PI/6;i.push(`${e+s*Math.cos(a)},${t+s*Math.sin(a)}`)}return`M${i.join(" L")} Z`},heptagon:(e,t,n)=>{const s=.35*n,i=[];for(let n=0;n<7;n++){const a=2*Math.PI/7*n-Math.PI/2;i.push(`${e+s*Math.cos(a)},${t+s*Math.sin(a)}`)}return`M${i.join(" L")} Z`},octagon:(e,t,n)=>{const s=.33*n,i=[];for(let n=0;n<8;n++){const a=Math.PI/4*n;i.push(`${e+s*Math.cos(a)},${t+s*Math.sin(a)}`)}return`M${i.join(" L")} Z`},star4:(e,t,n)=>{const s=.38*n,i=.16*n,a=[];for(let n=0;n<8;n++){const r=Math.PI/4*n-Math.PI/2,o=n%2==0?s:i;a.push(`${e+o*Math.cos(r)},${t+o*Math.sin(r)}`)}return`M${a.join(" L")} Z`},star5:(e,t,n)=>{const s=.38*n,i=.16*n,a=[];for(let n=0;n<10;n++){const r=Math.PI/5*n-Math.PI/2,o=n%2==0?s:i;a.push(`${e+o*Math.cos(r)},${t+o*Math.sin(r)}`)}return`M${a.join(" L")} Z`},star6:(e,t,n)=>{const s=.38*n,i=.18*n,a=[];for(let n=0;n<12;n++){const r=Math.PI/6*n-Math.PI/2,o=n%2==0?s:i;a.push(`${e+o*Math.cos(r)},${t+o*Math.sin(r)}`)}return`M${a.join(" L")} Z`},parallelogram:(e,t,n)=>{const s=.35*n,i=.12*n;return`M${e-s+i},${t-.6*s}\n                L${e+s+i},${t-.6*s}\n                L${e+s-i},${t+.6*s}\n                L${e-s-i},${t+.6*s}\n                Z`},trapezoid:(e,t,n)=>{const s=.38*n;return`M${e-.6*s},${t-.5*s}\n                L${e+.6*s},${t-.5*s}\n                L${e+s},${t+.5*s}\n                L${e-s},${t+.5*s}\n                Z`},cross:(e,t,n)=>{const s=.35*n,i=.12*n;return`M${e-i},${t-s}\n                L${e+i},${t-s}\n                L${e+i},${t-i}\n                L${e+s},${t-i}\n                L${e+s},${t+i}\n                L${e+i},${t+i}\n                L${e+i},${t+s}\n                L${e-i},${t+s}\n                L${e-i},${t+i}\n                L${e-s},${t+i}\n                L${e-s},${t-i}\n                Z`},house:(e,t,n)=>{const s=.32*n;return`M${e},${t-s}\n                L${e+s},${t-.2*s}\n                L${e+s},${t+s}\n                L${e-s},${t+s}\n                L${e-s},${t-.2*s}\n                Z`},shield:(e,t,n)=>{const s=.35*n;return`M${e},${t-s}\n                L${e+s},${t-.5*s}\n                L${e+.8*s},${t+.3*s}\n                L${e},${t+s}\n                L${e-.8*s},${t+.3*s}\n                L${e-s},${t-.5*s}\n                Z`},kite:(e,t,n)=>{const s=.38*n;return`M${e},${t-s}\n                L${e+.5*s},${t-.1*s}\n                L${e},${t+s}\n                L${e-.5*s},${t-.1*s}\n                Z`},step:(e,t,n)=>{const s=.35*n;return`M${e-s},${t-s}\n                L${e},${t-s}\n                L${e},${t}\n                L${e+s},${t}\n                L${e+s},${t+s}\n                L${e-s},${t+s}\n                Z`},doubleBlock:(e,t,n)=>{const s=.25*n,i=.28*n,a=.08*n;return`M${e-s-a},${t-i}\n                L${e-a},${t-i}\n                L${e-a},${t+i}\n                L${e-s-a},${t+i}\n                Z\n                M${e+a},${t-i}\n                L${e+s+a},${t-i}\n                L${e+s+a},${t+i}\n                L${e+a},${t+i}\n                Z`},splitPill:(e,t,n)=>{const s=.4*n,i=.22*n,a=.02*n;return`M${e-s+i},${t-i}\n                L${e+s-i},${t-i}\n                Q${e+s},${t-i} ${e+s},${t}\n                Q${e+s},${t+i} ${e+s-i},${t+i}\n                L${e-s+i},${t+i}\n                Q${e-s},${t+i} ${e-s},${t}\n                Q${e-s},${t-i} ${e-s+i},${t-i}\n                Z\n                M${e-a},${t-i}\n                L${e+a},${t-i}\n                L${e+a},${t+i}\n                L${e-a},${t+i}\n                Z`},roundedRect:(e,t,n)=>{const s=.35*n,i=.12*n;return`\n            M${e-s+i},${t-s}\n            L${e+s-i},${t-s}\n            Q${e+s},${t-s} ${e+s},${t-s+i}\n            L${e+s},${t+s-i}\n            Q${e+s},${t+s} ${e+s-i},${t+s}\n            L${e-s+i},${t+s}\n            Q${e-s},${t+s} ${e-s},${t+s-i}\n            L${e-s},${t-s+i}\n            Q${e-s},${t-s} ${e-s+i},${t-s}\n            Z`.replace(/\s+/g," ")},pill:(e,t,n)=>{const s=.4*n,i=.22*n;return`\n            M${e-s+i},${t-i}\n            L${e+s-i},${t-i}\n            Q${e+s},${t-i} ${e+s},${t}\n            Q${e+s},${t+i} ${e+s-i},${t+i}\n            L${e-s+i},${t+i}\n            Q${e-s},${t+i} ${e-s},${t}\n            Q${e-s},${t-i} ${e-s+i},${t-i}\n            Z`.replace(/\s+/g," ")},bookmark:(e,t,n)=>{const s=.35*n;return`M${e-s},${t-s} L${e+s},${t-s} L${e+s},${t+s} L${e},${t+.4*s} L${e-s},${t+s} Z`},hourglass:(e,t,n)=>{const s=.35*n;return`\n            M${e-s},${t-s}\n            L${e+s},${t-s}\n            L${e-.4*s},${t}\n            L${e+s},${t+s}\n            L${e-s},${t+s}\n            L${e+.4*s},${t}\n            Z`.replace(/\s+/g," ")}},a=Object.keys(i);function r(e){let t=0;if(!e)return t;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return Math.abs(t)}const o=new Map;function l(e,t=32,n=.2){const l=`${e?.toLowerCase()}-${t}-${n}`;if(o.has(l))return o.get(l);const d=function(e,t=32,n=.2){e&&"string"==typeof e||(e="0x0000000000000000000000000000000000000000");const o=e.toLowerCase(),l=r(o),d=r(o.split("").reverse().join("")),c=l%s.length,[h,u]=s[c],m=d%a.length,p=a[m],g=t/2+.01*t*(l%10-5),w=t/2+.01*t*(d%10-5);return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${t} ${t}" width="${t}" height="${t}">\n        <rect width="${t}" height="${t}" rx="${t*n}" fill="${h}"/>\n        <g transform="rotate(${l%8*45} ${g} ${w})">\n            <path d="${(0,i[p])(g,w,t)}" fill="${u}"/>\n        </g>\n    </svg>`}(e,t,n);if(o.size>=200){const e=o.keys().next().value;o.delete(e)}return o.set(l,d),d}function d(e){if(!e||"string"!=typeof e)return s[0][1];const t=r(e.toLowerCase());return s[t%s.length][1]}},6684(e,t,n){n.d(t,{Bu:()=>d,M0:()=>r,ZD:()=>i,cP:()=>o,dc:()=>a,po:()=>l});var s=n(9423);function i(e){return null==e?"":("string"==typeof e?e:String(e)).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function a(e){return i(e)}function r(e){return e?`${e.slice(0,6)}...${e.slice(-4)}`:"Unknown"}function o(e){if(!e||"string"!=typeof e)return!1;if(e.startsWith("data:image/")||e.startsWith("data:video/"))return!0;if(e.startsWith("blob:"))return!0;try{const t=new URL(e);return["http:","https:"].includes(t.protocol)}catch{return!1}}function l(e){return(0,s.cr)(e)}function d(e){return e?e.replace(/(https?:\/\/[^\s<>"'`()\[\]{}]+)/gi,e=>{let t=e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'");try{const n=new URL(t);if(!["http:","https:"].includes(n.protocol))return e}catch{return e}return`<a href="${t.replace(/"/g,"%22").replace(/'/g,"%27").replace(/</g,"%3C").replace(/>/g,"%3E")}" target="_blank" rel="noopener noreferrer" class="text-[#F6851B] hover:underline break-all">${e.length>50?e.substring(0,47)+"...":e}</a>`}):""}}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,n),a.exports}n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};n.r(s);var i=n(5246),a=n(6976),r=n(7040),o=n(4350),l=n(6734),d=n(1350),c=n(6884),h=n(9110),u=n(302),m=n(1272),p=n(9423),g=n(6684);class w{constructor(){this.initialized=!1,this.pendingInvite=null}async init(){m.V.info("Pombo - Initializing...");try{await h.F.init(),o.B.init(),window.uiController=o.B,this.setupMessageHandlers(),this.setupWalletHandlers(),this.checkInviteLink(),o.B.updateNetworkStatus("Ready to connect",!1),this.initialized=!0,m.V.info("Pombo - Ready!"),i.s.hasSavedWallet()?setTimeout(()=>this.connectWallet(),300):setTimeout(()=>this.connectAsGuest(),300)}catch(e){m.V.error("Initialization failed:",e),o.B.showNotification("Failed to initialize app: "+e.message,"error")}}setupWalletHandlers(){const e=document.getElementById("connect-wallet"),t=document.getElementById("disconnect-wallet"),n=document.getElementById("switch-wallet");e.addEventListener("click",async()=>{await this.connectWallet()}),t?.addEventListener("click",async()=>{await this.disconnectWallet()}),n?.addEventListener("click",async()=>{await this.switchWallet()})}async switchWallet(){try{const e=i.s.listSavedWallets();if(e.length<=1)return;const t=i.s.getAddress(),n=e.filter(e=>e.address!==t);if(0===n.length)return;const s=await this.showWalletSelector(n);if(!s)return;const a=await this.showSecureInput("Unlock Account","Enter password to unlock account:","password");if(!a)return;await this.disconnectWallet(),await this.loadWalletWithProgress(a,s),o.B.showNotification("Account switched!","success")}catch(e){o.B.showNotification(e.message||"Failed to switch account","error")}}async disconnectWallet(){const e=i.s.isGuestMode();try{r.L.stopPresenceTracking(),await u.D.cleanup(),await r.L.leaveAllChannels(),await a.xA.disconnect(),h.F.reset(),c.Z.lock(),i.s.disconnect(),o.B.updateWalletInfo(null),o.B.updateNetworkStatus("Disconnected",!1),o.B.renderChannelList(),o.B.resetToDisconnectedState(),e?o.B.showNotification("Guest session ended - all data has been cleared","info"):o.B.showNotification("Account disconnected","info"),m.V.info("Account disconnected - full cleanup complete")}catch(e){m.V.error("Error disconnecting:",e),o.B.updateWalletInfo(null),o.B.updateNetworkStatus("Disconnected",!1),o.B.resetToDisconnectedState(),o.B.showNotification("Error disconnecting: "+e.message,"error")}}async connectAsGuest(){try{o.B.updateNetworkStatus("Connecting as Guest...",!1);const{address:e,signer:t}=i.s.connectAsGuest();m.V.info("Guest wallet created:",e),await this.onWalletConnected(e,t),m.V.info("Connected as Guest - ready to explore!")}catch(e){m.V.error("Failed to connect as Guest:",e),o.B.updateNetworkStatus("Failed to connect",!1),o.B.showNotification("Failed to connect: "+e.message,"error")}}async connectWallet(){try{if(i.s.isGuestMode())return void await this.showCreateWalletModal();const e=i.s.listSavedWallets();e.length>0?await this.showUnlockWalletModal(e):await this.showCreateWalletModal()}catch(e){"cancelled"!==e.message&&(console.error("Failed to connect wallet:",e),o.B.showNotification("Failed to connect: "+e.message,"error"))}}async showUnlockWalletModal(e){return new Promise((t,n)=>{const s=1===e.length,i=s?e[0]:null,a=(e,t)=>!e.name||e.name.startsWith("Wallet ")||e.name.startsWith("Imported ")||e.name.startsWith("Account ")?`Account ${t+1}`:e.name,r=document.createElement("div");r.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 animate-fadeIn",r.innerHTML=`\n                <div class="bg-[#111111] rounded-xl w-[360px] overflow-hidden shadow-2xl border border-[#222] animate-slideUp">\n                    \x3c!-- Header --\x3e\n                    <div class="px-5 pt-5 pb-3">\n                        <div class="flex items-center justify-between">\n                            <h3 class="text-[15px] font-medium text-white">Unlock Account</h3>\n                            <button id="close-modal" class="text-[#666] hover:text-white transition p-1 -mr-1">\n                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                                </svg>\n                            </button>\n                        </div>\n                    </div>\n                    \n                    ${s?`\n                    \x3c!-- Single Wallet Display --\x3e\n                    <div class="px-5 pb-4">\n                        <div class="bg-[#1a1a1a] rounded-lg p-3 border border-[#282828]">\n                            <div class="flex items-center gap-3">\n                                <div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0">${(0,p.Y0)(i.address,40,.2)}</div>\n                                <div class="flex-1 min-w-0">\n                                    <div class="text-[13px] font-medium text-white truncate">${o.B.escapeAttr(a(i,0))}</div>\n                                    <div class="text-[11px] text-[#888] font-mono">${i.address.slice(0,6)}...${i.address.slice(-4)}</div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    `:`\n                    \x3c!-- Multiple Wallets List --\x3e\n                    <div class="px-5 pb-4">\n                        <div class="space-y-2 max-h-40 overflow-y-auto scrollbar-thin">\n                            ${e.map((e,t)=>`\n                                <button class="wallet-item w-full bg-[#1a1a1a] hover:bg-[#202020] rounded-lg p-3 border border-[#282828] hover:border-[#444] transition-all text-left ${0===t?"selected border-[#444]":""}" data-address="${o.B.escapeAttr(e.address)}" data-name="${o.B.escapeAttr(e.name)}">\n                                    <div class="flex items-center gap-3">\n                                        <div class="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0">${(0,p.Y0)(e.address,36,.2)}</div>\n                                        <div class="flex-1 min-w-0">\n                                            <div class="text-[13px] font-medium text-white truncate">${o.B.escapeAttr(a(e,t))}</div>\n                                            <div class="text-[11px] text-[#888] font-mono">${e.address.slice(0,6)}...${e.address.slice(-4)}</div>\n                                        </div>\n                                        <div class="w-4 h-4 rounded-full border border-[#444] group-[.selected]:bg-white flex items-center justify-center">\n                                            <div class="w-2 h-2 rounded-full bg-white opacity-0 selected-dot"></div>\n                                        </div>\n                                    </div>\n                                </button>\n                            `).join("")}\n                        </div>\n                    </div>\n                    `}\n                    \n                    \x3c!-- Password Input --\x3e\n                    <div class="px-5 pb-4">\n                        <div class="relative">\n                            <input type="password" id="wallet-password" \n                                placeholder="Password"\n                                class="w-full bg-[#1a1a1a] border border-[#282828] rounded-lg px-3 py-2.5 text-[13px] text-white placeholder-[#555] focus:outline-none focus:border-[#444] transition"\n                                autocomplete="off">\n                            <button id="toggle-password" class="absolute right-2.5 top-1/2 -translate-y-1/2 text-[#555] hover:text-white transition">\n                                <svg id="eye-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                </svg>\n                            </button>\n                        </div>\n                        <p id="password-error" class="text-red-500 text-[11px] mt-1.5 hidden">Incorrect password</p>\n                    </div>\n                    \n                    \x3c!-- Actions --\x3e\n                    <div class="px-5 pb-5">\n                        <button id="unlock-btn" class="w-full bg-white hover:bg-[#e5e5e5] text-black text-[13px] font-medium py-2.5 rounded-lg transition disabled:opacity-40 disabled:cursor-not-allowed">\n                            Unlock\n                        </button>\n                    </div>\n                    \n                    \x3c!-- Footer --\x3e\n                    <div class="border-t border-[#222] px-5 py-3 bg-[#0d0d0d]">\n                        <div class="flex items-center justify-center gap-3 text-[12px]">\n                            <button id="create-new-btn" class="text-[#666] hover:text-white transition">New account</button>\n                            <span class="text-[#333]"></span>\n                            <button id="import-btn" class="text-[#666] hover:text-white transition">Import</button>\n                        </div>\n                    </div>\n                </div>\n            `;const l=document.createElement("style");l.textContent="\n                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n                @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\n                .animate-fadeIn { animation: fadeIn 0.15s ease-out; }\n                .animate-slideUp { animation: slideUp 0.2s ease-out; }\n                .scrollbar-thin::-webkit-scrollbar { width: 3px; }\n                .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }\n                .scrollbar-thin::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }\n                .wallet-item.selected .selected-dot { opacity: 1; }\n            ",document.head.appendChild(l),document.body.appendChild(r);const d=r.querySelector("#wallet-password"),c=r.querySelector("#unlock-btn"),h=r.querySelector("#toggle-password"),u=r.querySelector("#eye-icon"),m=r.querySelector("#password-error"),g=r.querySelector("#close-modal"),w=r.querySelector("#create-new-btn"),v=r.querySelector("#import-btn"),y=r.querySelectorAll(".wallet-item");let f=s?i.address:e[0].address,b=s?i.name:e[0].name;setTimeout(()=>d.focus(),100),y.forEach(e=>{e.addEventListener("click",()=>{y.forEach(e=>e.classList.remove("selected","border-[#444]")),e.classList.add("selected","border-[#444]"),f=e.dataset.address,b=e.dataset.name,d.focus()})}),h.addEventListener("click",()=>{const e="password"===d.type;d.type=e?"text":"password",u.innerHTML=e?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"/>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>'});const x=()=>{d.value="",document.body.removeChild(r),document.head.removeChild(l)},C=async()=>{const e=d.value;if(e){c.disabled=!0,c.innerHTML='<svg class="animate-spin h-4 w-4 mx-auto text-black" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';try{x(),await this.loadWalletWithProgress(e,f),t()}catch(e){document.head.appendChild(l),document.body.appendChild(r),m.classList.remove("hidden"),d.classList.add("border-red-500"),c.disabled=!1,c.textContent="Unlock",d.value="",d.focus()}}else d.classList.add("border-red-500")};c.addEventListener("click",C),d.addEventListener("keypress",e=>{"Enter"===e.key&&C()}),d.addEventListener("input",()=>{d.classList.remove("border-red-500"),m.classList.add("hidden")}),g.addEventListener("click",()=>{x(),n(new Error("cancelled"))}),r.addEventListener("click",e=>{e.target===r&&(x(),n(new Error("cancelled")))}),w.addEventListener("click",async()=>{x();try{await this.showCreateWalletModal(),t()}catch(e){n(e)}}),v.addEventListener("click",async()=>{x();try{await this.importPrivateKey(),t()}catch(e){n(e)}})})}async showCreateWalletModal(){return new Promise((e,t)=>{const n=document.createElement("div");n.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 animate-fadeIn",n.innerHTML='\n                <div class="bg-[#111111] rounded-xl w-[340px] overflow-hidden shadow-2xl border border-[#222] animate-slideUp">\n                    \x3c!-- Header --\x3e\n                    <div class="px-5 pt-5 pb-3">\n                        <div class="flex items-center justify-between">\n                            <h3 class="text-[15px] font-medium text-white">Connect Account</h3>\n                            <button id="close-modal" class="text-[#666] hover:text-white transition p-1 -mr-1">\n                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                                </svg>\n                            </button>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Options --\x3e\n                    <div class="px-5 pb-3 space-y-2">\n                        <button id="create-btn" class="w-full bg-white hover:bg-[#f0f0f0] rounded-lg p-3.5 text-left transition-all">\n                            <div class="flex items-center gap-3">\n                                <div class="w-9 h-9 rounded-lg bg-[#111] flex items-center justify-center">\n                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.5v15m7.5-7.5h-15"/>\n                                    </svg>\n                                </div>\n                                <div>\n                                    <div class="text-[13px] font-medium text-black">Create New Account</div>\n                                    <div class="text-[11px] text-[#666]">Generate a new private key</div>\n                                </div>\n                            </div>\n                        </button>\n                        \n                        <button id="import-btn" class="w-full bg-[#1a1a1a] hover:bg-[#202020] border border-[#282828] hover:border-[#333] rounded-lg p-3.5 text-left transition-all">\n                            <div class="flex items-center gap-3">\n                                <div class="w-9 h-9 rounded-lg bg-[#252525] flex items-center justify-center">\n                                    <svg class="w-4 h-4 text-[#888]" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>\n                                    </svg>\n                                </div>\n                                <div>\n                                    <div class="text-[13px] font-medium text-white">Import Private Key</div>\n                                    <div class="text-[11px] text-[#666]">Use existing account</div>\n                                </div>\n                            </div>\n                        </button>\n                    </div>\n                    \n                    \x3c!-- Restore link (discreet) --\x3e\n                    <div class="px-5 pb-4 flex justify-end">\n                        <button id="restore-btn" class="flex items-center gap-1.5 text-[#555] hover:text-[#888] transition text-[11px]">\n                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/>\n                            </svg>\n                            restore\n                        </button>\n                        <input type="file" id="restore-file-input" accept=".json" class="hidden">\n                    </div>\n                </div>\n            ';const s=document.createElement("style");s.textContent="\n                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n                @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\n                .animate-fadeIn { animation: fadeIn 0.15s ease-out; }\n                .animate-slideUp { animation: slideUp 0.2s ease-out; }\n            ",document.head.appendChild(s),document.body.appendChild(n);const i=()=>{document.body.removeChild(n),document.head.removeChild(s)};n.querySelector("#close-modal").addEventListener("click",()=>{i(),t(new Error("cancelled"))}),n.addEventListener("click",e=>{e.target===n&&(i(),t(new Error("cancelled")))}),n.querySelector("#create-btn").addEventListener("click",async()=>{i();try{await this.connectLocal(),e()}catch(e){t(e)}}),n.querySelector("#import-btn").addEventListener("click",async()=>{i();try{await this.importPrivateKey(),e()}catch(e){t(e)}});const a=n.querySelector("#restore-btn"),r=n.querySelector("#restore-file-input");a.addEventListener("click",()=>{r.click()}),r.addEventListener("change",async n=>{const s=n.target.files?.[0];if(s){i();try{await this.restoreFromBackup(s),e()}catch(e){"cancelled"!==e.message&&o.B.showNotification("Restore failed: "+e.message,"error"),t(e)}}})})}async restoreFromBackup(e){const t=await e.text(),n=JSON.parse(t);if("pombo-account-backup"!==n.format||3!==n.version)throw new Error("Invalid backup format. Only pombo-account-backup v3 is supported.");const s=await this.showSecureInput("Restore Account","Enter the backup password:","password");if(!s)throw new Error("cancelled");const i=this.showProgressModal("Restoring Account","Decrypting with scrypt...");try{const e=await c.Z.importAccountBackup(n,s,e=>this.updateProgressModal(i,e));this.hideProgressModal(i);const t=n.keystore.address.toLowerCase(),a=JSON.parse(localStorage.getItem("pombo_wallets")||"{}");a[t]||(a[t]={name:e.data?.username||`Restored ${t.slice(0,8)}`,keystore:n.keystore,createdAt:Date.now(),lastUsed:Date.now(),restored:!0},localStorage.setItem("pombo_wallets",JSON.stringify(a))),await this.loadWalletWithProgress(s,t);const r=e.data;if(r){if(r.channels&&r.channels.length>0){const e=new Set((c.Z.cache.channels||[]).map(e=>e.messageStreamId||e.streamId));for(const t of r.channels){const n=t.messageStreamId||t.streamId;n&&!e.has(n)&&c.Z.cache.channels.push(t)}}if(r.trustedContacts)for(const[e,t]of Object.entries(r.trustedContacts))c.Z.cache.trustedContacts[e]||(c.Z.cache.trustedContacts[e]=t);r.username&&!c.Z.cache.username&&(c.Z.cache.username=r.username),await c.Z.saveToStorage()}o.B.showNotification("Account restored successfully!","success")}catch(e){throw this.hideProgressModal(i),e}}async showSecureInput(e,t,n="password"){return new Promise(s=>{const i=document.createElement("div");i.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50",i.innerHTML=`\n                <div class="bg-[#111111] rounded-xl w-[340px] overflow-hidden shadow-2xl border border-[#222]">\n                    <div class="px-5 pt-5 pb-3">\n                        <div class="flex items-center justify-between">\n                            <h3 class="text-[15px] font-medium text-white">${e}</h3>\n                            <button id="close-modal" class="text-[#666] hover:text-white transition p-1 -mr-1">\n                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                                </svg>\n                            </button>\n                        </div>\n                        <p class="text-[11px] text-[#666] mt-1">${t}</p>\n                    </div>\n                    <div class="px-5 pb-4">\n                        <div class="relative">\n                            <input type="${n}" id="secure-input" \n                                class="w-full bg-[#1a1a1a] border border-[#282828] rounded-lg px-3 py-2.5 text-[13px] text-white placeholder-[#555] focus:outline-none focus:border-[#444] transition"\n                                autocomplete="off" spellcheck="false">\n                            ${"password"===n?'\n                            <button id="toggle-visibility" class="absolute right-2.5 top-1/2 -translate-y-1/2 text-[#555] hover:text-white transition">\n                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                </svg>\n                            </button>\n                            ':""}\n                        </div>\n                    </div>\n                    <div class="px-5 pb-5 flex gap-2">\n                        <button id="secure-cancel" class="flex-1 bg-[#1a1a1a] hover:bg-[#202020] text-white text-[13px] font-medium py-2.5 rounded-lg transition border border-[#282828]">\n                            Cancel\n                        </button>\n                        <button id="secure-confirm" class="flex-1 bg-white hover:bg-[#f0f0f0] text-black text-[13px] font-medium py-2.5 rounded-lg transition">\n                            Continue\n                        </button>\n                    </div>\n                </div>\n            `,document.body.appendChild(i);const a=i.querySelector("#secure-input"),r=i.querySelector("#secure-confirm"),o=i.querySelector("#secure-cancel"),l=i.querySelector("#close-modal"),d=i.querySelector("#toggle-visibility");a.focus(),d&&d.addEventListener("click",()=>{a.type="password"===a.type?"text":"password"});const c=e=>{a.value="",document.body.removeChild(i),s(e)};r.addEventListener("click",()=>c(a.value||null)),o.addEventListener("click",()=>c(null)),l.addEventListener("click",()=>c(null)),a.addEventListener("keypress",e=>{"Enter"===e.key&&c(a.value||null)}),i.addEventListener("click",e=>{e.target===i&&c(null)})})}async connectLocal(){try{i.s.isGuestMode()&&await this.disconnectWallet();const e=i.s.generateLocalWallet(),t=await this.showNewAccountSetupModal(e.address,e.privateKey);if("cancelled"===t)return await this.connectAsGuest(),void o.B.showNotification("Continuing as Guest - your data won't be saved","info");t&&await this.saveWalletWithProgress(t.password,t.displayName),await this.onWalletConnected(e.address,e.signer),t?.displayName&&c.Z.isStorageUnlocked()&&(c.Z.cache.username=t.displayName,await c.Z.saveToStorage()),o.B.showNotification("Account created!","success")}catch(e){throw e}}async showNewAccountSetupModal(e,t){return new Promise(n=>{const s=document.createElement("div");s.className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4",s.innerHTML=`\n                <div class="bg-[#141414] rounded-2xl w-[420px] max-w-[95vw] shadow-2xl border border-white/5 overflow-hidden">\n                    \x3c!-- Step 1: Account Created --\x3e\n                    <div id="step-1">\n                        \x3c!-- Header --\x3e\n                        <div class="flex items-center justify-between px-6 py-4 border-b border-white/5">\n                            <div class="flex items-center gap-3">\n                                <div class="w-9 h-9 rounded-xl bg-[#1a2f1a] flex items-center justify-center">\n                                    <svg class="w-4 h-4 text-[#4ade80]" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12.75l6 6 9-13.5"/>\n                                    </svg>\n                                </div>\n                                <div>\n                                    <h3 class="text-lg font-medium text-white/90">Account Created</h3>\n                                    <p class="text-xs text-white/40">Set up your account</p>\n                                </div>\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Content --\x3e\n                        <div class="p-6 space-y-4">\n                            \x3c!-- Address --\x3e\n                            <div>\n                                <label class="block text-xs font-medium text-white/40 uppercase tracking-wider mb-2">Address</label>\n                                <div class="bg-white/5 border border-white/10 rounded-xl px-4 py-3 font-mono text-sm text-white/60 break-all">\n                                    ${e}\n                                </div>\n                            </div>\n                            \n                            \x3c!-- Private Key --\x3e\n                            <div>\n                                <label class="block text-xs font-medium text-white/40 uppercase tracking-wider mb-2">Private Key</label>\n                                <div class="bg-white/5 border border-white/10 rounded-xl px-4 py-3 relative">\n                                    <div id="pk-hidden" class="font-mono text-sm text-white/30 select-none"></div>\n                                    <div id="pk-revealed" class="font-mono text-sm text-white/60 break-all hidden">${t}</div>\n                                    <button id="toggle-pk" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white/80 transition">\n                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                        </svg>\n                                    </button>\n                                </div>\n                                <button id="copy-pk" class="mt-2 w-full bg-white/5 hover:bg-white/10 border border-white/10 text-white/70 text-sm font-medium py-2.5 rounded-xl transition flex items-center justify-center gap-2">\n                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>\n                                    </svg>\n                                    Copy Private Key\n                                </button>\n                            </div>\n                            \n                            \x3c!-- Warning --\x3e\n                            <div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-4">\n                                <div class="flex gap-3">\n                                    <svg class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>\n                                    </svg>\n                                    <div>\n                                        <p class="text-amber-400 text-sm font-medium">Save your private key!</p>\n                                        <p class="text-amber-400/60 text-xs mt-1">Store it safely offline. This is the only way to recover your account.</p>\n                                    </div>\n                                </div>\n                            </div>\n                            \n                            \x3c!-- Display Name --\x3e\n                            <div>\n                                <label class="block text-xs font-medium text-white/40 uppercase tracking-wider mb-2">Display Name</label>\n                                <input type="text" id="display-name-input" \n                                    class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 rounded-xl text-sm focus:outline-none focus:border-white/30 transition placeholder:text-white/20"\n                                    placeholder="Your name (optional)" maxlength="32" autocomplete="off">\n                            </div>\n                            \n                            \x3c!-- Password --\x3e\n                            <div>\n                                <label class="block text-xs font-medium text-white/40 uppercase tracking-wider mb-2">Password</label>\n                                <div class="relative">\n                                    <input type="password" id="password-input" \n                                        class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 rounded-xl text-sm focus:outline-none focus:border-white/30 transition placeholder:text-white/20 pr-11"\n                                        placeholder="Min 12 chars, upper, lower, number" autocomplete="new-password">\n                                    <button id="toggle-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white/80 transition">\n                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                        </svg>\n                                    </button>\n                                </div>\n                                \x3c!-- Password strength indicators --\x3e\n                                <div id="password-strength" class="mt-3 space-y-1.5 text-xs">\n                                    <div id="check-length" class="flex items-center gap-2 text-white/30">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>\n                                        </svg>\n                                        At least 12 characters\n                                    </div>\n                                    <div id="check-upper" class="flex items-center gap-2 text-white/30">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>\n                                        </svg>\n                                        Uppercase letter\n                                    </div>\n                                    <div id="check-lower" class="flex items-center gap-2 text-white/30">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>\n                                        </svg>\n                                        Lowercase letter\n                                    </div>\n                                    <div id="check-number" class="flex items-center gap-2 text-white/30">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>\n                                        </svg>\n                                        Number\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Footer --\x3e\n                        <div class="px-6 py-4 border-t border-white/5 flex gap-3">\n                            <button id="cancel-btn" class="flex-1 bg-white/5 hover:bg-white/10 text-white/70 text-sm font-medium py-3 rounded-xl transition border border-white/10">\n                                Cancel\n                            </button>\n                            <button id="continue-btn" disabled class="flex-1 bg-white/10 text-white/30 text-sm font-medium py-3 rounded-xl transition cursor-not-allowed">\n                                Continue\n                            </button>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Step 2: Confirm Password --\x3e\n                    <div id="step-2" class="hidden">\n                        \x3c!-- Header --\x3e\n                        <div class="flex items-center justify-between px-6 py-4 border-b border-white/5">\n                            <div>\n                                <h3 class="text-lg font-medium text-white/90">Confirm Password</h3>\n                                <p class="text-xs text-white/40 mt-0.5">Re-enter your password to confirm</p>\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Content --\x3e\n                        <div class="p-6">\n                            <div class="relative">\n                                <input type="password" id="confirm-password-input" \n                                    class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 rounded-xl text-sm focus:outline-none focus:border-white/30 transition placeholder:text-white/20 pr-11"\n                                    placeholder="Re-enter password" autocomplete="new-password">\n                                <button id="toggle-confirm-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white/80 transition">\n                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                    </svg>\n                                </button>\n                            </div>\n                            <p id="password-error" class="hidden text-xs text-red-400 mt-2">Passwords don't match</p>\n                        </div>\n                        \n                        \x3c!-- Footer --\x3e\n                        <div class="px-6 py-4 border-t border-white/5 flex gap-3">\n                            <button id="back-btn" class="flex-1 bg-white/5 hover:bg-white/10 text-white/70 text-sm font-medium py-3 rounded-xl transition border border-white/10">\n                                Back\n                            </button>\n                            <button id="confirm-btn" class="flex-1 bg-white hover:bg-white/90 text-black text-sm font-medium py-3 rounded-xl transition">\n                                Continue\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `,document.body.appendChild(s);const i=s.querySelector("#step-1"),a=s.querySelector("#step-2"),r=s.querySelector("#toggle-pk"),o=s.querySelector("#pk-hidden"),l=s.querySelector("#pk-revealed"),d=s.querySelector("#copy-pk"),c=s.querySelector("#display-name-input"),h=s.querySelector("#password-input"),u=s.querySelector("#toggle-password"),m=s.querySelector("#cancel-btn"),p=s.querySelector("#continue-btn"),g=s.querySelector("#check-length"),w=s.querySelector("#check-upper"),v=s.querySelector("#check-lower"),y=s.querySelector("#check-number"),f=s.querySelector("#confirm-password-input"),b=s.querySelector("#toggle-confirm-password"),x=s.querySelector("#back-btn"),C=s.querySelector("#confirm-btn"),L=s.querySelector("#password-error"),I='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',E='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="1.5"/></svg>';let k={length:!1,upper:!1,lower:!1,number:!1};m.addEventListener("click",()=>{document.body.removeChild(s),n("cancelled")});let S=!1;r.addEventListener("click",()=>{S=!S,o.classList.toggle("hidden",S),l.classList.toggle("hidden",!S)}),d.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(t),d.innerHTML='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!',d.classList.add("text-emerald-400"),setTimeout(()=>{d.innerHTML='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/></svg> Copy Private Key',d.classList.remove("text-emerald-400")},2e3)}catch(e){const n=document.createElement("textarea");n.value=t,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}}),u.addEventListener("click",()=>{h.type="password"===h.type?"text":"password"}),h.addEventListener("input",()=>{const e=h.value;k.length=e.length>=12,k.upper=/[A-Z]/.test(e),k.lower=/[a-z]/.test(e),k.number=/[0-9]/.test(e),g.className="flex items-center gap-2 "+(k.length?"text-emerald-400":"text-white/30"),g.innerHTML=(k.length?I:E)+" At least 12 characters",w.className="flex items-center gap-2 "+(k.upper?"text-emerald-400":"text-white/30"),w.innerHTML=(k.upper?I:E)+" Uppercase letter",v.className="flex items-center gap-2 "+(k.lower?"text-emerald-400":"text-white/30"),v.innerHTML=(k.lower?I:E)+" Lowercase letter",y.className="flex items-center gap-2 "+(k.number?"text-emerald-400":"text-white/30"),y.innerHTML=(k.number?I:E)+" Number";const t=k.length&&k.upper&&k.lower&&k.number;p.disabled=!t,p.className=t?"flex-1 bg-white hover:bg-white/90 text-black text-sm font-medium py-3 rounded-xl transition":"flex-1 bg-white/10 text-white/30 text-sm font-medium py-3 rounded-xl transition cursor-not-allowed"}),p.addEventListener("click",()=>{p.disabled||(i.classList.add("hidden"),a.classList.remove("hidden"),f.focus())}),b.addEventListener("click",()=>{f.type="password"===f.type?"text":"password"}),x.addEventListener("click",()=>{a.classList.add("hidden"),i.classList.remove("hidden"),f.value="",L.classList.add("hidden")}),C.addEventListener("click",()=>{if(f.value!==h.value)return L.classList.remove("hidden"),void f.classList.add("border-red-400");const e={password:h.value,displayName:c.value.trim()||null};h.value="",f.value="",document.body.removeChild(s),n(e)}),f.addEventListener("input",()=>{L.classList.add("hidden"),f.classList.remove("border-red-400")}),f.addEventListener("keypress",e=>{"Enter"===e.key&&C.click()}),h.addEventListener("keypress",e=>{"Enter"!==e.key||p.disabled||p.click()})})}async showImportPrivateKeyModal(){return new Promise(e=>{const t=document.createElement("div");t.className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4",t.innerHTML='\n                <div class="bg-[#141414] rounded-2xl w-[420px] max-w-[95vw] shadow-2xl border border-white/5 overflow-hidden">\n                    \x3c!-- Step 1: Import Private Key --\x3e\n                    <div id="step-1">\n                        \x3c!-- Header --\x3e\n                        <div class="flex items-center justify-between px-6 py-4 border-b border-white/5">\n                            <div class="flex items-center gap-3">\n                                <div class="w-9 h-9 rounded-xl bg-[#1a1f2e] flex items-center justify-center">\n                                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/>\n                                    </svg>\n                                </div>\n                                <div>\n                                    <h3 class="text-lg font-medium text-white/90">Import Private Key</h3>\n                                    <p class="text-xs text-white/40">Restore your account</p>\n                                </div>\n                            </div>\n                            <button id="close-btn" class="text-white/40 hover:text-white/80 transition p-1">\n                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                                </svg>\n                            </button>\n                        </div>\n                        \n                        \x3c!-- Content --\x3e\n                        <div class="p-6 space-y-4">\n                            \x3c!-- Private Key Input --\x3e\n                            <div>\n                                <label class="block text-xs font-medium text-white/40 uppercase tracking-wider mb-2">Private Key</label>\n                                <div class="relative">\n                                    <input type="password" id="private-key-input" \n                                        class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 rounded-xl text-sm font-mono focus:outline-none focus:border-white/30 transition placeholder:text-white/20 pr-11"\n                                        placeholder="64 hex characters (with or without 0x)" autocomplete="off" spellcheck="false">\n                                    <button id="toggle-pk" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white/80 transition">\n                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                        </svg>\n                                    </button>\n                                </div>\n                                <p id="pk-error" class="hidden text-xs text-red-400 mt-2">Invalid format - must be 64 hex characters</p>\n                            </div>\n                            \n                            \x3c!-- Divider --\x3e\n                            <div class="border-t border-white/5 pt-4">\n                                <p class="text-xs text-white/40 mb-3">Set a password to save this account locally</p>\n                            </div>\n                            \n                            \x3c!-- Password --\x3e\n                            <div>\n                                <label class="block text-xs font-medium text-white/40 uppercase tracking-wider mb-2">Password</label>\n                                <div class="relative">\n                                    <input type="password" id="password-input" \n                                        class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 rounded-xl text-sm focus:outline-none focus:border-white/30 transition placeholder:text-white/20 pr-11"\n                                        placeholder="Min 12 chars, upper, lower, number" autocomplete="new-password">\n                                    <button id="toggle-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white/80 transition">\n                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                        </svg>\n                                    </button>\n                                </div>\n                                \x3c!-- Password strength indicators --\x3e\n                                <div id="password-strength" class="mt-3 space-y-1.5 text-xs">\n                                    <div id="check-length" class="flex items-center gap-2 text-white/30">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>\n                                        </svg>\n                                        At least 12 characters\n                                    </div>\n                                    <div id="check-upper" class="flex items-center gap-2 text-white/30">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>\n                                        </svg>\n                                        Uppercase letter\n                                    </div>\n                                    <div id="check-lower" class="flex items-center gap-2 text-white/30">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>\n                                        </svg>\n                                        Lowercase letter\n                                    </div>\n                                    <div id="check-number" class="flex items-center gap-2 text-white/30">\n                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>\n                                        </svg>\n                                        Number\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Footer --\x3e\n                        <div class="px-6 py-4 border-t border-white/5 flex gap-3">\n                            <button id="skip-btn" class="flex-1 bg-white/5 hover:bg-white/10 text-white/70 text-sm font-medium py-3 rounded-xl transition border border-white/10">\n                                Continue without saving\n                            </button>\n                            <button id="save-btn" disabled class="flex-1 bg-white/10 text-white/30 text-sm font-medium py-3 rounded-xl transition cursor-not-allowed">\n                                Save\n                            </button>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Step 2: Confirm Password --\x3e\n                    <div id="step-2" class="hidden">\n                        \x3c!-- Header --\x3e\n                        <div class="flex items-center justify-between px-6 py-4 border-b border-white/5">\n                            <div>\n                                <h3 class="text-lg font-medium text-white/90">Confirm Password</h3>\n                                <p class="text-xs text-white/40 mt-0.5">Re-enter your password to confirm</p>\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Content --\x3e\n                        <div class="p-6">\n                            <div class="relative">\n                                <input type="password" id="confirm-password-input" \n                                    class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 rounded-xl text-sm focus:outline-none focus:border-white/30 transition placeholder:text-white/20 pr-11"\n                                    placeholder="Re-enter password" autocomplete="new-password">\n                                <button id="toggle-confirm-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white/80 transition">\n                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>\n                                    </svg>\n                                </button>\n                            </div>\n                            <p id="password-error" class="hidden text-xs text-red-400 mt-2">Passwords don\'t match</p>\n                        </div>\n                        \n                        \x3c!-- Footer --\x3e\n                        <div class="px-6 py-4 border-t border-white/5 flex gap-3">\n                            <button id="back-btn" class="flex-1 bg-white/5 hover:bg-white/10 text-white/70 text-sm font-medium py-3 rounded-xl transition border border-white/10">\n                                Back\n                            </button>\n                            <button id="confirm-btn" class="flex-1 bg-white hover:bg-white/90 text-black text-sm font-medium py-3 rounded-xl transition">\n                                Save\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            ',document.body.appendChild(t);const n=t.querySelector("#step-1"),s=t.querySelector("#step-2"),i=t.querySelector("#close-btn"),a=t.querySelector("#private-key-input"),r=t.querySelector("#toggle-pk"),o=t.querySelector("#pk-error"),l=t.querySelector("#password-input"),d=t.querySelector("#toggle-password"),c=t.querySelector("#skip-btn"),h=t.querySelector("#save-btn"),u=t.querySelector("#check-length"),m=t.querySelector("#check-upper"),p=t.querySelector("#check-lower"),g=t.querySelector("#check-number"),w=t.querySelector("#confirm-password-input"),v=t.querySelector("#toggle-confirm-password"),y=t.querySelector("#back-btn"),f=t.querySelector("#confirm-btn"),b=t.querySelector("#password-error"),x='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',C='<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="1.5"/></svg>';let L={length:!1,upper:!1,lower:!1,number:!1},I=!1;const E=e=>(e=e.trim(),/^[a-fA-F0-9]{64}$/.test(e)?"0x"+e:e),k=()=>{const e=I&&L.length&&L.upper&&L.lower&&L.number;h.disabled=!e,h.className=e?"flex-1 bg-white hover:bg-white/90 text-black text-sm font-medium py-3 rounded-xl transition":"flex-1 bg-white/10 text-white/30 text-sm font-medium py-3 rounded-xl transition cursor-not-allowed"};i.addEventListener("click",()=>{document.body.removeChild(t),e(null)}),t.addEventListener("click",n=>{n.target===t&&(document.body.removeChild(t),e(null))}),r.addEventListener("click",()=>{a.type="password"===a.type?"text":"password"}),a.addEventListener("input",()=>{(()=>{const e=E(a.value);I=/^0x[a-fA-F0-9]{64}$/.test(e),o.classList.toggle("hidden",I||0===a.value.trim().length),a.classList.toggle("border-red-400",!I&&a.value.trim().length>0),k()})(),c.disabled=!I,c.className=I?"flex-1 bg-white/5 hover:bg-white/10 text-white/70 text-sm font-medium py-3 rounded-xl transition border border-white/10":"flex-1 bg-white/5 text-white/30 text-sm font-medium py-3 rounded-xl transition border border-white/10 cursor-not-allowed"}),d.addEventListener("click",()=>{l.type="password"===l.type?"text":"password"}),l.addEventListener("input",()=>{const e=l.value;L.length=e.length>=12,L.upper=/[A-Z]/.test(e),L.lower=/[a-z]/.test(e),L.number=/[0-9]/.test(e),u.className="flex items-center gap-2 "+(L.length?"text-emerald-400":"text-white/30"),u.innerHTML=(L.length?x:C)+" At least 12 characters",m.className="flex items-center gap-2 "+(L.upper?"text-emerald-400":"text-white/30"),m.innerHTML=(L.upper?x:C)+" Uppercase letter",p.className="flex items-center gap-2 "+(L.lower?"text-emerald-400":"text-white/30"),p.innerHTML=(L.lower?x:C)+" Lowercase letter",g.className="flex items-center gap-2 "+(L.number?"text-emerald-400":"text-white/30"),g.innerHTML=(L.number?x:C)+" Number",k()}),c.addEventListener("click",()=>{if(!I)return;const n=E(a.value);a.value="",l.value="",document.body.removeChild(t),e({privateKey:n,password:null})}),h.addEventListener("click",()=>{h.disabled||(n.classList.add("hidden"),s.classList.remove("hidden"),w.focus())}),v.addEventListener("click",()=>{w.type="password"===w.type?"text":"password"}),y.addEventListener("click",()=>{s.classList.add("hidden"),n.classList.remove("hidden"),w.value="",b.classList.add("hidden")}),f.addEventListener("click",()=>{if(w.value!==l.value)return b.classList.remove("hidden"),void w.classList.add("border-red-400");const n={privateKey:E(a.value),password:l.value};a.value="",l.value="",w.value="",document.body.removeChild(t),e(n)}),w.addEventListener("input",()=>{b.classList.add("hidden"),w.classList.remove("border-red-400")}),w.addEventListener("keypress",e=>{"Enter"===e.key&&f.click()}),l.addEventListener("keypress",e=>{"Enter"!==e.key||h.disabled||h.click()}),a.addEventListener("keypress",e=>{"Enter"===e.key&&(h.disabled?I&&c.click():h.click())}),setTimeout(()=>a.focus(),100)})}async saveWalletWithProgress(e,t=null){const n=this.showProgressModal("Encrypting Account","Using Keystore V3 with scrypt (n=262144)...");try{const s=await i.s.saveWalletEncrypted(e,t,e=>{this.updateProgressModal(n,e)});return this.hideProgressModal(n),o.B.showNotification(`Account "${s.name}" saved securely!`,"success"),s}catch(e){throw this.hideProgressModal(n),e}}async loadWalletWithProgress(e,t=null){const n=this.showProgressModal("Decrypting Account","Verifying Keystore V3...");try{const s=await i.s.loadWalletEncrypted(e,t,e=>{this.updateProgressModal(n,e)});return this.hideProgressModal(n),await this.onWalletConnected(s.address,s.signer),s}catch(e){throw this.hideProgressModal(n),e}}showProgressModal(e,t){const n=document.createElement("div");return n.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50",n.innerHTML=`\n            <div class="bg-[#111111] rounded-xl w-[300px] overflow-hidden shadow-2xl border border-[#222]">\n                <div class="px-5 pt-5 pb-2">\n                    <h3 class="text-[14px] font-medium text-white">${e}</h3>\n                    <p class="text-[11px] text-[#666] mt-0.5">${t}</p>\n                </div>\n                <div class="px-5 pb-5 pt-3">\n                    <div class="flex items-center justify-between mb-1.5">\n                        <span class="text-[10px] text-[#666]">Progress</span>\n                        <span class="text-[10px] font-medium text-white" id="progress-label">0%</span>\n                    </div>\n                    <div class="h-1.5 bg-[#1a1a1a] rounded-full overflow-hidden">\n                        <div id="progress-bar" class="h-full bg-white transition-all duration-300 ease-out" style="width: 0%"></div>\n                    </div>\n                    <p class="text-[10px] text-[#555] text-center mt-3">This may take a few seconds...</p>\n                </div>\n            </div>\n        `,document.body.appendChild(n),n}updateProgressModal(e,t){const n=Math.round(100*t),s=e.querySelector("#progress-bar"),i=e.querySelector("#progress-label");s&&(s.style.width=`${n}%`),i&&(i.textContent=`${n}%`)}hideProgressModal(e){e&&e.parentNode&&document.body.removeChild(e)}async showWalletSelector(e){return new Promise(t=>{const n=document.createElement("div");n.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 animate-fadeIn",n.innerHTML=`\n                <div class="bg-[#111111] rounded-xl w-[360px] overflow-hidden shadow-2xl border border-[#222] animate-slideUp">\n                    \x3c!-- Header --\x3e\n                    <div class="px-5 pt-5 pb-3">\n                        <div class="flex items-center justify-between">\n                            <h3 class="text-[15px] font-medium text-white">Select Account</h3>\n                            <button id="close-modal" class="text-[#666] hover:text-white transition p-1 -mr-1">\n                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                                </svg>\n                            </button>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Account List --\x3e\n                    <div class="px-5 pb-5">\n                        <div class="space-y-2 max-h-60 overflow-y-auto scrollbar-thin">\n                            ${e.map((e,t)=>`\n                                <button class="account-option w-full bg-[#1a1a1a] hover:bg-[#202020] rounded-lg p-3 border border-[#282828] hover:border-[#444] transition-all text-left" data-address="${o.B.escapeAttr(e.address)}">\n                                    <div class="flex items-center gap-3">\n                                        <div class="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0">${(0,p.Y0)(e.address,36,.2)}</div>\n                                        <div class="flex-1 min-w-0">\n                                            <div class="text-[13px] font-medium text-white truncate">${o.B.escapeAttr(((e,t)=>!e.name||e.name.startsWith("Wallet ")||e.name.startsWith("Imported ")||e.name.startsWith("Account ")?`Account ${t+1}`:e.name)(e,t))}</div>\n                                            <div class="text-[11px] text-[#888] font-mono">${e.address.slice(0,6)}...${e.address.slice(-4)}</div>\n                                        </div>\n                                    </div>\n                                </button>\n                            `).join("")}\n                        </div>\n                    </div>\n                </div>\n            `,document.body.appendChild(n),n.querySelectorAll(".account-option").forEach(e=>{e.addEventListener("click",e=>{const s=e.currentTarget.dataset.address;document.body.removeChild(n),t(s)})}),n.querySelector("#close-modal").addEventListener("click",()=>{document.body.removeChild(n),t(null)}),n.addEventListener("click",e=>{e.target===n&&(document.body.removeChild(n),t(null))})})}async importPrivateKey(){try{const e=await this.showImportPrivateKeyModal();if(!e)return;const{privateKey:t,password:n}=e;i.s.isGuestMode()&&await this.disconnectWallet();const s=i.s.importPrivateKey(t);n&&await this.saveWalletWithProgress(n),await this.onWalletConnected(s.address,s.signer),o.B.showNotification("Account imported!","success")}catch(e){throw e}}async loadSavedWallet(){try{const e=i.s.listSavedWallets();let t=null;if(e.length>1&&(t=await this.showWalletSelector(e),!t))return;const n=await this.showSecureInput("Unlock Account","Enter your account password:","password");if(!n)return;await this.loadWalletWithProgress(n,t)}catch(e){throw e}}async onWalletConnected(e,t){try{const n=i.s.isGuestMode();o.B.updateWalletInfo(e,n),o.B.updateNetworkStatus("Connecting to Streamr...",!1);const s=i.s.listSavedWallets();o.B.updateSwitchWalletButton(s.length>1),n?c.Z.initAsGuest(e):await c.Z.init(t,e),r.L.clearChannels(),r.L.loadChannels(),m.V.info("Loaded channels for wallet:",e),await a.xA.init(t),await h.F.setOwner(e);const p=await a.xA.getAddress();m.V.info("Streamr connected with address:",p),o.B.updateNetworkStatus("Connected to Streamr",!0);try{await d.E.init(),m.V.info("Identity manager initialized")}catch(e){m.V.warn("Identity manager init failed (non-critical):",e)}o.B.renderChannelList(),await o.B.processInitialUrl(),u.D.startBackgroundPoller(),m.V.info("Dynamic subscription management active (background poller started)");try{await l.notificationManager.init(),m.V.info("Notification system ready")}catch(e){m.V.warn("Failed to init notifications (non-critical):",e)}if(this.pendingInvite){m.V.info("Processing pending invite:",this.pendingInvite.name);const e=this.pendingInvite;this.pendingInvite=null,setTimeout(()=>this.showInviteDialog(e),500)}m.V.info("Wallet connected and Streamr initialized")}catch(e){throw m.V.error("Failed to initialize after wallet connection:",e),o.B.updateNetworkStatus("Failed to connect to Streamr",!1),e}}setupMessageHandlers(){const e=new Map;r.L.onMessage((t,n)=>{if(!i.s.isConnected())return void m.V.debug("Message ignored - user disconnected");const s=r.L.getCurrentChannel(),a=s?.streamId;if("message"===t)o.B.updateUnreadCount(n.streamId),n.streamId===a&&o.B.addMessage(n.message);else if("typing"===t){if(n.streamId!==a)return;const t=n.user,s=i.s.getAddress();if(t?.toLowerCase()===s?.toLowerCase())return;e.has(n.streamId)||e.set(n.streamId,new Map);const l=e.get(n.streamId);l.set(t,Date.now());const d=Date.now();for(const[e,t]of l)d-t>3e3&&l.delete(e);o.B.showTypingIndicator(Array.from(l.keys())),setTimeout(()=>{l.delete(t);const e=r.L.getCurrentChannel();e?.streamId===n.streamId&&o.B.showTypingIndicator(Array.from(l.keys()))},3e3)}else"reaction"===t?n.streamId===a&&o.B.handleIncomingReaction(n.messageId,n.emoji,n.user,n.action||"add"):"media"===t?h.F.handleMediaMessage(n.streamId,n.media):"channelJoined"===t?(h.F.reannounceForChannel(n.streamId,n.password),n.permissions&&!n.permissions.canPublish&&n.permissions.canSubscribe&&o.B.showNotification("You have read-only access to this channel. You cannot send messages.","warning",5e3)):"history_loaded"===t&&n.streamId===a&&r.L.getCurrentChannel()&&m.V.debug(`History loaded: ${n.loaded} messages, hasMore: ${n.hasMore}`)}),r.L.onOnlineUsersChange((e,t)=>{o.B.updateOnlineUsers(e,t)})}checkInviteLink(){const e=new URLSearchParams(window.location.search).get("invite");if(e){const t=r.L.parseInviteLink(e);t&&(m.V.info("Invite detected:",t),window.history.replaceState({},document.title,window.location.pathname),i.s.isConnected()?this.showInviteDialog(t):this.pendingInvite=t)}}showInviteDialog(e){const t=document.createElement("div");t.className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 animate-fadeIn",t.innerHTML=`\n            <div class="bg-[#111111] rounded-xl w-[360px] overflow-hidden shadow-2xl border border-[#222] animate-slideUp">\n                \x3c!-- Header --\x3e\n                <div class="px-5 pt-5 pb-3">\n                    <div class="flex items-center justify-between">\n                        <h3 class="text-[15px] font-medium text-white">Channel Invite</h3>\n                        <button id="close-invite-modal" class="text-[#666] hover:text-white transition p-1 -mr-1">\n                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>\n                            </svg>\n                        </button>\n                    </div>\n                    <p class="text-[13px] text-[#888] mt-1">You've been invited to join a channel</p>\n                </div>\n                \n                \x3c!-- Channel Info --\x3e\n                <div class="px-5 pb-4">\n                    <div class="bg-[#1a1a1a] rounded-lg p-4 border border-[#282828] space-y-3">\n                        <div class="flex items-center gap-3">\n                            <div class="w-10 h-10 rounded-lg bg-[#252525] flex items-center justify-center">\n                                <svg class="w-5 h-5 text-[#888]" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>\n                                </svg>\n                            </div>\n                            <div class="flex-1 min-w-0">\n                                <div class="text-[14px] font-medium text-white truncate">${(0,g.ZD)(e.name)}</div>\n                                <div class="text-[12px] text-[#666]">${this.getChannelTypeLabel(e.type)}</div>\n                            </div>\n                        </div>\n                        <div class="pt-2 border-t border-[#282828]">\n                            <div class="text-[11px] text-[#555] font-mono break-all">${(0,g.ZD)(e.streamId)}</div>\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- Actions --\x3e\n                <div class="px-5 pb-5 flex gap-3">\n                    <button id="decline-invite" class="flex-1 bg-[#1a1a1a] hover:bg-[#252525] border border-[#282828] text-[#888] text-[13px] font-medium px-4 py-2.5 rounded-lg transition">\n                        Decline\n                    </button>\n                    <button id="accept-invite" class="flex-1 bg-white hover:bg-[#f0f0f0] text-black text-[13px] font-medium px-4 py-2.5 rounded-lg transition">\n                        Join Channel\n                    </button>\n                </div>\n            </div>\n        `,document.body.appendChild(t);const n=()=>{t.classList.add("animate-fadeOut"),setTimeout(()=>document.body.removeChild(t),150)};t.querySelector("#close-invite-modal").addEventListener("click",n),t.querySelector("#decline-invite").addEventListener("click",n),t.querySelector("#accept-invite").addEventListener("click",()=>{n(),this.joinChannelFromInvite(e)}),t.addEventListener("click",e=>{e.target===t&&n()})}getChannelTypeLabel(e){return{public:"Public Channel",password:"Password Protected",native:"Native Encryption"}[e]||(0,g.ZD)(String(e||"Unknown"))}async joinChannelFromInvite(e){try{o.B.showLoading("Joining channel..."),await r.L.joinChannel(e.streamId,e.password,{name:e.name,type:e.type}),o.B.hideLoading(),o.B.renderChannelList(),o.B.showNotification("Joined channel successfully!","success")}catch(e){o.B.hideLoading(),o.B.showNotification("Failed to join channel: "+e.message,"error")}}async acceptInvite(e){await l.notificationManager.acceptInvite(e),o.B.renderChannelList()}dismissInvite(e){l.notificationManager.dismissInvite(e)}}return document.addEventListener("DOMContentLoaded",()=>{const e=new w;e.init(),window.ethChat=e}),s})());